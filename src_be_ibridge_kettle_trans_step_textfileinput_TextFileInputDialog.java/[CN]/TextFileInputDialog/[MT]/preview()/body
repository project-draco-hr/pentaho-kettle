{
  String debug="Start";
  TextFileInputMeta info=new TextFileInputMeta();
  debug="gef info";
  getInfo(info);
  debug="gef files";
  String files[]=info.getFiles();
  Row previousRow=null;
  int nrRepeats=0;
  long rownumber=1;
  if (files != null && files.length > 0) {
    int maxNrLines;
    if (previewlimit >= 0) {
      maxNrLines=previewlimit;
    }
 else {
      String shellText="Number of preview rows";
      String lineText="How many lines do you want to preview?";
      EnterNumberDialog end=new EnterNumberDialog(shell,props,100,shellText,lineText);
      maxNrLines=end.open();
    }
    boolean stopPreview=false;
    if (maxNrLines >= 0 && !stopPreview) {
      debug="A";
      for (int i=0; i < info.getInputFields().length; i++)       if (info.getInputFields()[i].isRepeated())       nrRepeats++;
      try {
        int linenr=0;
        ArrayList rowbuffer=new ArrayList();
        for (int x=0; x < files.length && (linenr < maxNrLines || maxNrLines == 0) && !stopPreview; x++) {
          debug="B";
          FileInputStream fi=new FileInputStream(new File(files[x]));
          ZipInputStream zi=null;
          InputStream f=null;
          if (info.isZipped()) {
            zi=new ZipInputStream(fi);
            zi.getNextEntry();
            f=zi;
          }
 else {
            f=fi;
          }
          InputStreamReader reader;
          if (info.getEncoding() != null && info.getEncoding().length() > 0) {
            reader=new InputStreamReader(f,info.getEncoding());
          }
 else {
            reader=new InputStreamReader(f);
          }
          debug="C";
          String line=TextFileInput.getLine(log,reader,wFormat.getText());
          if (info.hasHeader())           line=TextFileInput.getLine(log,reader,wFormat.getText());
          debug="D";
          while (line != null && (linenr < maxNrLines || maxNrLines == 0)) {
            StringBuffer error=new StringBuffer();
            Row r=TextFileInput.convertLineToRow(log,line,info,df,dfs,daf,dafs,files[x],rownumber);
            if (r != null) {
              rownumber++;
              if (nrRepeats > 0) {
                if (previousRow == null) {
                  previousRow=new Row();
                  for (int i=0; i < info.getInputFields().length; i++) {
                    if (info.getInputFields()[i].isRepeated()) {
                      Value value=r.getValue(i);
                      previousRow.addValue(new Value(value));
                    }
                  }
                }
 else {
                  int repnr=0;
                  for (int i=0; i < info.getInputFields().length; i++) {
                    if (info.getInputFields()[i].isRepeated()) {
                      Value value=r.getValue(i);
                      if (value.isNull()) {
                        Value prev=previousRow.getValue(repnr);
                        r.removeValue(i);
                        r.addValue(i,prev);
                      }
 else {
                        previousRow.removeValue(repnr);
                        previousRow.addValue(repnr,new Value(value));
                      }
                      repnr++;
                    }
                  }
                }
              }
              if (!(input.noEmptyLines() && r.isEmpty()) && !r.isIgnored()) {
                rowbuffer.add(r);
              }
 else {
                rownumber--;
                linenr--;
              }
              line=TextFileInput.getLine(log,reader,wFormat.getText());
            }
 else {
              MessageBox mb=new MessageBox(shell,SWT.OK | SWT.CANCEL | SWT.ICON_ERROR);
              mb.setMessage("Error previewing file on line " + linenr + " : "+ error);
              mb.setText("ERROR");
              int answer=mb.open();
              if (answer == SWT.CANCEL)               stopPreview=true;
              line=null;
            }
            linenr++;
          }
          debug="E";
          if (info.isZipped()) {
            zi.closeEntry();
            zi.close();
          }
          f.close();
        }
        debug="EA";
        if (previewlimit >= 0) {
          if (!previewdialog.isDisposed()) {
            previewdialog.dispose();
            debug="EB";
            previewbounds=previewdialog.getBounds();
            debug="EC";
            previewhscroll=previewdialog.getHScroll();
            debug="ED";
            previewvscroll=previewdialog.getVScroll();
          }
        }
 else {
          previewlimit=maxNrLines;
        }
        debug="F";
        wPreview.setText(STRING_PREVIEW_REFRESH);
        previewdialog=new PreviewRowsDialog(shell,SWT.NONE,wStepname.getText(),rowbuffer);
        previewdialog.setBounds(previewbounds);
        previewdialog.setHScroll(previewhscroll);
        previewdialog.setVScroll(previewvscroll);
        if (previewdialog.open() == null) {
          previewbounds=previewdialog.getBounds();
          previewhscroll=previewdialog.getHScroll();
          previewvscroll=previewdialog.getVScroll();
          previewlimit=-1;
          wPreview.setText(STRING_PREVIEW_ROWS);
        }
      }
 catch (      Exception e) {
        wPreview.setText(STRING_PREVIEW_ROWS);
        previewdialog=null;
        previewlimit=-1;
        MessageBox mb=new MessageBox(shell,SWT.OK | SWT.ICON_ERROR);
        mb.setMessage("The following error occured while trying to preview rows: " + Const.CR + e.toString()+ Const.CR+ "Part: "+ debug);
        mb.setText("ERROR");
        mb.open();
      }
 finally {
      }
    }
  }
 else {
    MessageBox mb=new MessageBox(shell,SWT.OK | SWT.ICON_ERROR);
    mb.setMessage("I couldn't find a valid file to work with.  Please check the files, directories & expression.");
    mb.setText("ERROR");
    mb.open();
  }
}
