{
  String parentFolderName=buildPluginsFolderPath(marketEntry);
  File pluginFolder=new File(parentFolderName + File.separator + marketEntry.getId());
  LogChannel.GENERAL.logBasic("Uninstalling plugin in folder: " + pluginFolder.getAbsolutePath());
  if (!pluginFolder.exists()) {
    throw new KettleException("No plugin was found in the expected folder : " + pluginFolder.getAbsolutePath());
  }
  try {
    for (    PluginInterface plugin : PluginRegistry.getInstance().findPluginsByFolder(pluginFolder.toURI().toURL())) {
      ClassLoader cl=PluginRegistry.getInstance().getClassLoader(plugin);
      if (cl instanceof KettleURLClassLoader) {
        ((KettleURLClassLoader)cl).closeClassLoader();
      }
      PluginRegistry.getInstance().removePlugin(plugin.getPluginType(),plugin);
    }
  }
 catch (  MalformedURLException e1) {
    LogChannel.GENERAL.logError(e1.getLocalizedMessage(),e1);
  }
  deleteDirectory(pluginFolder);
  if (refresh) {
    if (!Display.getDefault().getThread().equals(Thread.currentThread())) {
      Spoon.getInstance().getDisplay().asyncExec(new Runnable(){
        public void run(){
          try {
            refreshSpoon(monitorDialog);
          }
 catch (          KettleException e) {
            e.printStackTrace();
          }
        }
      }
);
    }
 else {
      refreshSpoon(monitorDialog);
    }
  }
}
