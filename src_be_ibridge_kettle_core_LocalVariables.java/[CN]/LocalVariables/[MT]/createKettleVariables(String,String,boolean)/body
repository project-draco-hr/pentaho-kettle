{
  if (parentThread != null && parentThread.equals(localThread)) {
    throw new RuntimeException("local thread can't be the same as the parent thread!");
  }
  KettleVariables vars=new KettleVariables(localThread,parentThread);
  if (parentThread != null) {
    KettleVariables initialValue=getKettleVariables(parentThread);
    if (initialValue != null) {
      if (sameNamespace) {
        vars=new KettleVariables(localThread,parentThread);
        vars.setProperties(initialValue.getProperties());
      }
 else {
        vars.putAll(initialValue.getProperties());
      }
    }
 else {
      throw new RuntimeException("No parent Kettle Variables found for thread [" + parentThread + "], local thread is ["+ localThread+ "]");
    }
  }
  KettleVariables checkVars=(KettleVariables)map.get(localThread);
  if (checkVars != null) {
    throw new RuntimeException("There are already variables in the local variables map for [" + localThread + "]");
  }
  map.put(localThread,vars);
  return vars;
}
