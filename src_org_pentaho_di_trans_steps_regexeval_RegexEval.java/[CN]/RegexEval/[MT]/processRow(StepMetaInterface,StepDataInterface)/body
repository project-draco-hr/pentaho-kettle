{
  meta=(RegexEvalMeta)smi;
  data=(RegexEvalData)sdi;
  Object[] row=getRow();
  if (row == null) {
    setOutputDone();
    return false;
  }
  if (first) {
    first=false;
    data.nrIncomingFields=getInputRowMeta().size();
    data.outputRowMeta=getInputRowMeta().clone();
    meta.getFields(data.outputRowMeta,getStepname(),null,null,this);
    data.nrExtraFields=meta.isAllowCaptureGroupsFlagSet() ? meta.getFieldName().length : 0;
    if (meta.getMatcher() != null) {
      if (data.indexOfFieldToEvaluate < 0) {
        data.indexOfFieldToEvaluate=getInputRowMeta().indexOfValue(meta.getMatcher());
        if (data.indexOfFieldToEvaluate < 0) {
          logError(BaseMessages.getString(PKG,"RegexEval.Log.ErrorFindingField") + "[" + meta.getMatcher()+ "]");
          throw new KettleStepException(BaseMessages.getString(PKG,"RegexEval.Exception.CouldnotFindField",meta.getMatcher()));
        }
        if (Const.isEmpty(environmentSubstitute(meta.getResultFieldName()))) {
          if (!meta.isAllowCaptureGroupsFlagSet()) {
            logError(BaseMessages.getString(PKG,"RegexEval.Log.ErrorResultFieldMissing"));
            throw new KettleStepException(BaseMessages.getString(PKG,"RegexEval.Exception.ErrorResultFieldMissing"));
          }
          data.addResultField=false;
        }
      }
    }
 else {
      logError(BaseMessages.getString(PKG,"RegexEval.Log.ErrorMatcherMissing"));
      throw new KettleStepException(BaseMessages.getString(PKG,"RegexEval.Exception.ErrorMatcherMissing"));
    }
    data.conversionRowMeta=data.outputRowMeta.clone();
    for (    ValueMetaInterface valueMeta : data.conversionRowMeta.getValueMetaList()) {
      valueMeta.setType(ValueMetaInterface.TYPE_STRING);
    }
  }
  Object[] outputRow=RowDataUtil.allocateRowData(data.outputRowMeta.size());
  for (int i=0; i < data.nrIncomingFields; i++) {
    outputRow[i]=row[i];
  }
  try {
    String fieldValue=getInputRowMeta().getString(row,data.indexOfFieldToEvaluate);
    int index=data.nrIncomingFields;
    if (fieldValue == null) {
      if (data.addResultField) {
        outputRow[index]=false;
        index++;
      }
      for (int i=0; i < data.nrExtraFields; i++) {
        ValueMetaInterface valueMeta=data.outputRowMeta.getValueMeta(index);
        ValueMetaInterface conversionValueMeta=data.conversionRowMeta.getValueMeta(index);
        Object convertedValue=valueMeta.convertDataFromString(null,conversionValueMeta,meta.getFieldNullIf()[i],meta.getFieldIfNull()[i],meta.getFieldTrimType()[i]);
        outputRow[index]=convertedValue;
        index++;
      }
    }
 else {
      Matcher m=data.pattern.matcher(fieldValue);
      boolean firstCheck=false;
      boolean isMatch=m.matches();
      if (data.addResultField) {
        outputRow[index]=isMatch;
        index++;
      }
      String[] values=new String[data.nrExtraFields];
      for (int i=0; i < data.nrExtraFields; i++) {
        if (isMatch) {
          if (!firstCheck) {
            firstCheck=true;
            if (data.nrExtraFields != m.groupCount()) {
              logError(BaseMessages.getString(PKG,"RegexEval.Log.ErrorCaptureGroupFieldsMismatch",String.valueOf(m.groupCount()),String.valueOf(data.nrExtraFields)));
              throw new KettleStepException(BaseMessages.getString(PKG,"RegexEval.Exception.ErrorCaptureGroupFieldsMismatch",String.valueOf(m.groupCount()),String.valueOf(data.nrExtraFields)));
            }
          }
          values[i]=m.group(i + 1);
        }
        ValueMetaInterface valueMeta=data.outputRowMeta.getValueMeta(index);
        ValueMetaInterface conversionValueMeta=data.conversionRowMeta.getValueMeta(index);
        Object convertedValue=valueMeta.convertDataFromString(values[i],conversionValueMeta,meta.getFieldNullIf()[i],meta.getFieldIfNull()[i],meta.getFieldTrimType()[i]);
        outputRow[index]=convertedValue;
        index++;
      }
    }
    if (log.isRowLevel())     logRowlevel(BaseMessages.getString(PKG,"RegexEval.Log.ReadRow") + " " + getInputRowMeta().getString(row));
    putRow(data.outputRowMeta,outputRow);
  }
 catch (  KettleException e) {
    boolean sendToErrorRow=false;
    String errorMessage=null;
    if (getStepMeta().isDoingErrorHandling()) {
      sendToErrorRow=true;
      errorMessage=e.toString();
    }
 else {
      throw new KettleStepException(BaseMessages.getString(PKG,"RegexEval.Log.ErrorInStep"),e);
    }
    if (sendToErrorRow) {
      putError(getInputRowMeta(),outputRow,1,errorMessage,null,"REGEX001");
    }
  }
  return true;
}
