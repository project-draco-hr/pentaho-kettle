{
  RepositoriesDialog rd=new RepositoriesDialog(display,APP_NAME,Permission.TRANSFORMATION);
  rd.getShell().setImage(GUIResource.getInstance().getImageSpoon());
  if (rd.open()) {
    if (rep != null) {
      rep.disconnect();
    }
    RepositoryDirectory directoryTree=null;
    try {
      setRepository(rd.getConnectedRepository());
      directoryTree=rep.loadRepositoryDirectoryTree();
    }
 catch (    KettleException ke) {
      rep=null;
      new ErrorDialog(shell,BaseMessages.getString(PKG,"Spoon.Dialog.ErrorConnectingRepository.Title"),BaseMessages.getString(PKG,"Spoon.Dialog.ErrorConnectingRepository.Message",Const.CR),ke);
    }
    TransMeta transMetas[]=getLoadedTransformations();
    for (int t=0; t < transMetas.length; t++) {
      TransMeta transMeta=transMetas[t];
      for (int i=0; i < transMeta.nrDatabases(); i++) {
        transMeta.getDatabase(i).setObjectId(null);
      }
      transMeta.setObjectId(null);
      List<DatabaseMeta> oldDatabases=transMeta.getDatabases();
      transMeta.setDatabases(new ArrayList<DatabaseMeta>());
      transMeta.setPartitionSchemas(new ArrayList<PartitionSchema>());
      transMeta.setSlaveServers(new ArrayList<SlaveServer>());
      transMeta.setClusterSchemas(new ArrayList<ClusterSchema>());
      try {
        SharedObjects sharedObjects=rep.readTransSharedObjects(transMeta);
        sharedObjectsFileMap.put(sharedObjects.getFilename(),sharedObjects);
      }
 catch (      KettleException e) {
        new ErrorDialog(shell,BaseMessages.getString(PKG,"Spoon.Dialog.ErrorReadingSharedObjects.Title"),BaseMessages.getString(PKG,"Spoon.Dialog.ErrorReadingSharedObjects.Message",makeTabName(transMeta,true)),e);
      }
      for (int i=0; i < oldDatabases.size(); i++) {
        DatabaseMeta oldDatabase=oldDatabases.get(i);
        DatabaseMeta newDatabase=DatabaseMeta.findDatabase(transMeta.getDatabases(),oldDatabase.getName());
        if (newDatabase != null) {
          oldDatabase.setDatabaseInterface(newDatabase.getDatabaseInterface());
        }
 else {
          transMeta.addDatabase(oldDatabase);
        }
      }
      RepositoryDirectory redi=directoryTree.findDirectory(transMeta.getRepositoryDirectory().getPath());
      if (redi != null) {
        transMeta.setRepositoryDirectory(redi);
      }
 else {
        transMeta.setRepositoryDirectory(directoryTree);
      }
    }
    refreshTree();
    setShellText();
  }
 else {
    if (!rd.isCancelled()) {
      closeRepository();
    }
  }
}
