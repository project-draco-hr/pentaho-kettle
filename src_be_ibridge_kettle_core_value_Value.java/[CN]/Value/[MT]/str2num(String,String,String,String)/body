{
  if (isNull()) {
    setType(VALUE_TYPE_STRING);
  }
 else {
    if (getType() == VALUE_TYPE_STRING) {
      if (getString() == null) {
        setNull();
        setValue(0.0);
      }
 else {
        NumberFormat nf=NumberFormat.getInstance();
        DecimalFormat df=(DecimalFormat)nf;
        DecimalFormatSymbols dfs=new DecimalFormatSymbols();
        if (currency != null && currency.length() > 0)         dfs.setCurrencySymbol(currency);
        if (grouping != null && grouping.length() > 0)         dfs.setGroupingSeparator(grouping.charAt(0));
        if (decimal != null && decimal.length() > 0)         dfs.setDecimalSeparator(decimal.charAt(0));
        if (pattern != null && pattern.length() > 0)         df.applyPattern(pattern);
        try {
          setValue(nf.parse(getString()).doubleValue());
        }
 catch (        Exception e) {
          setType(VALUE_TYPE_NUMBER);
          setNull();
          throw new KettleValueException("Couldn't convert string to number " + e.toString());
        }
      }
    }
 else {
      throw new KettleValueException("Function STR2NUM works only on strings");
    }
  }
  return this;
}
