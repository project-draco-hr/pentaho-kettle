{
  if (isNull()) {
    setType(VALUE_TYPE_STRING);
  }
 else {
    if (getType() == VALUE_TYPE_STRING) {
      if (getString() == null) {
        setNull();
        setValue(0.0);
      }
 else {
        NumberFormat nf=NumberFormat.getInstance();
        DecimalFormat df=(DecimalFormat)nf;
        DecimalFormatSymbols dfs=new DecimalFormatSymbols();
        if (arg3 != null)         dfs.setCurrencySymbol(arg3);
        if (arg2 != null)         dfs.setGroupingSeparator(arg2.charAt(0));
        if (arg1 != null)         dfs.setDecimalSeparator(arg1.charAt(0));
        if (arg0 != null)         df.applyPattern(arg0);
        try {
          setValue(nf.parse(getString()).doubleValue());
        }
 catch (        Exception e) {
          setType(VALUE_TYPE_NUMBER);
          setNull();
          throw new KettleValueException("Couldn't convert string to number " + e.toString());
        }
      }
    }
 else {
      throw new KettleValueException("Function STR2NUM works only on strings");
    }
  }
  return this;
}
