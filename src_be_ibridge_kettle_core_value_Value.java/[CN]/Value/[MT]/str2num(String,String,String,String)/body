{
  if (isNull()) {
    setType(VALUE_TYPE_STRING);
  }
 else {
    if (getType() == VALUE_TYPE_STRING) {
      if (getString() == null) {
        setNull();
        setValue(0.0);
      }
 else {
        NumberFormat nf=NumberFormat.getInstance();
        DecimalFormat df=(DecimalFormat)nf;
        DecimalFormatSymbols dfs=new DecimalFormatSymbols();
        if (pattern != null && pattern.length() > 0)         df.applyPattern(pattern);
        if (decimal != null && decimal.length() > 0)         dfs.setDecimalSeparator(decimal.charAt(0));
        if (grouping != null && grouping.length() > 0)         dfs.setGroupingSeparator(grouping.charAt(0));
        if (currency != null && currency.length() > 0)         dfs.setCurrencySymbol(currency);
        try {
          df.setDecimalFormatSymbols(dfs);
          setValue(nf.parse(getString()).doubleValue());
        }
 catch (        Exception e) {
          String message="Couldn't convert string to number " + e.toString();
          if (pattern != null && pattern.length() > 0)           message+=" pattern=" + pattern;
          if (decimal != null && decimal.length() > 0)           message+=" decimal=" + decimal;
          if (grouping != null && grouping.length() > 0)           message+=" grouping=" + grouping.charAt(0);
          if (currency != null && currency.length() > 0)           message+=" currency=" + currency;
          throw new KettleValueException(message);
        }
      }
    }
 else {
      throw new KettleValueException("Function STR2NUM works only on strings");
    }
  }
  return this;
}
