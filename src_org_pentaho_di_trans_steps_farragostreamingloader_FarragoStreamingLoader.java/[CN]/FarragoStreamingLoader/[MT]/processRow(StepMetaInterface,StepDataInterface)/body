{
  meta=(FarragoStreamingLoaderMeta)smi;
  data=(FarragoStreamingLoaderData)sdi;
  try {
    Object[] r=getRow();
    if (r == null) {
      if (data.objOut != null) {
        data.objOut.close();
        if (data.client != null) {
          data.client.close();
        }
      }
      return false;
    }
    if (first) {
      first=false;
      data.keynrs=new int[meta.getFieldStreamForKeys().length + meta.getFieldStreamForFields().length];
      data.format=new String[data.keynrs.length];
      for (int i=0; i < meta.getFieldStreamForKeys().length; i++) {
        data.keynrs[i]=getInputRowMeta().indexOfValue(meta.getFieldStreamForKeys()[i]);
        data.format[i]=getInputRowMeta().getValueMeta(data.keynrs[i]).getTypeDesc().toUpperCase();
      }
      int tmp_cnt=meta.getFieldStreamForKeys().length;
      for (int i=0; i < meta.getFieldStreamForFields().length; i++) {
        data.keynrs[tmp_cnt + i]=getInputRowMeta().indexOfValue(meta.getFieldStreamForFields()[i]);
        data.format[tmp_cnt + i]=getInputRowMeta().getValueMeta(data.keynrs[i]).getTypeDesc().toUpperCase();
      }
      if (isDetailed())       logDetailed(data.format.toString());
      List<Object> header=new ArrayList<Object>();
      header.add("1");
      List<String> format=new ArrayList<String>();
      for (int i=0; i < data.format.length; i++) {
        format.add(data.format[i]);
      }
      header.add(format);
      data.objOut.writeObject(header);
    }
    List<Object> entity=new ArrayList<Object>();
    for (int i=0; i < data.keynrs.length; i++) {
      int index=data.keynrs[i];
      ValueMetaInterface valueMeta=getInputRowMeta().getValueMeta(index);
      Object valueData=r[index];
      if (valueData != null) {
switch (valueMeta.getType()) {
case ValueMetaInterface.TYPE_STRING:
          if (log.isRowLevel())           logRowlevel(valueMeta.getString(valueData) + ":" + valueMeta.getLength()+ ":"+ valueMeta.getTypeDesc());
        entity.add(valueMeta.getString(valueData));
      break;
case ValueMetaInterface.TYPE_INTEGER:
    if (log.isRowLevel())     logRowlevel(valueMeta.getInteger(valueData) + ":" + valueMeta.getLength()+ ":"+ valueMeta.getTypeDesc());
  entity.add(valueMeta.getInteger(valueData));
break;
case ValueMetaInterface.TYPE_DATE:
Date date=valueMeta.getDate(valueData);
if (log.isRowLevel()) logRowlevel(XMLHandler.date2string(date) + ":" + valueMeta.getLength());
java.sql.Date sqlDate=new java.sql.Date(date.getTime());
entity.add(sqlDate);
break;
case ValueMetaInterface.TYPE_BOOLEAN:
if (log.isRowLevel()) logRowlevel(Boolean.toString(valueMeta.getBoolean(valueData)) + ":" + valueMeta.getLength());
entity.add(valueMeta.getBoolean(valueData));
break;
}
}
}
data.objOut.writeObject(entity);
data.objOut.reset();
data.objOut.flush();
return true;
}
 catch (Exception e) {
logError(BaseMessages.getString(PKG,"FarragoStreamingLoader.Log.ErrorInStep"),e);
setErrors(1);
stopAll();
setOutputDone();
return false;
}
}
