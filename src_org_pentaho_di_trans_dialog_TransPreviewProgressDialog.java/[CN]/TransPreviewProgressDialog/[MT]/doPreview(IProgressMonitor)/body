{
  LogWriter log=LogWriter.getInstance();
  int nrRows=0;
  for (int i=0; i < previewSize.length; i++)   nrRows+=previewSize[i];
  progressMonitor.beginTask(Messages.getString("TransPreviewProgressDialog.Monitor.BeginTask.Title"),100);
  Log4jStringAppender stringAppender=LogWriter.createStringAppender();
  log.addAppender(stringAppender);
  trans=new Trans(transMeta);
  trans.setPreviewSteps(previewStepNames);
  trans.setPreviewSizes(previewSize);
  trans.execute(null);
  int previousPct=0;
  while (!trans.previewComplete() && !trans.isFinished() && !progressMonitor.isCanceled()) {
    int nrDone=0;
    for (int i=0; i < previewSize.length; i++) {
      List<Object[]> buffer=trans.getPreviewRows(previewStepNames[i],0);
      nrDone+=buffer.size();
    }
    int pct=100 * nrDone / nrRows;
    int worked=pct - previousPct;
    if (worked > 0)     progressMonitor.worked(worked);
    previousPct=pct;
    try {
      Thread.sleep(500);
    }
 catch (    InterruptedException e) {
    }
    if (progressMonitor.isCanceled()) {
      cancelled=true;
      trans.stopAll();
    }
  }
  trans.stopAll();
  log.removeAppender(stringAppender);
  loggingText=stringAppender.getBuffer().toString();
  progressMonitor.done();
}
