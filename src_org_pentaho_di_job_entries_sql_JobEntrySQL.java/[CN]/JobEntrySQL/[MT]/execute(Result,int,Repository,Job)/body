{
  LogWriter log=LogWriter.getInstance();
  Result result=previousResult;
  if (connection != null) {
    Database db=new Database(connection);
    FileObject SQLfile=null;
    db.shareVariablesWith(this);
    try {
      db.connect();
      if (sqlfromfile) {
        if (sqlfilename == null)         throw new KettleDatabaseException(Messages.getString("JobSQL.NoSQLFileSpecified"));
        try {
          String realfilename=environmentSubstitute(sqlfilename);
          SQLfile=KettleVFS.getFileObject(realfilename);
          if (!SQLfile.exists()) {
            log.logError(toString(),Messages.getString("JobSQL.SQLFileNotExist",realfilename));
            throw new KettleDatabaseException(Messages.getString("JobSQL.SQLFileNotExist",realfilename));
          }
          if (log.isDetailed())           log.logDetailed(toString(),Messages.getString("JobSQL.SQLFileExists",realfilename));
          InputStream IS=KettleVFS.getInputStream(SQLfile);
          InputStreamReader BIS=new InputStreamReader(new BufferedInputStream(IS,500));
          StringBuffer lineStringBuffer=new StringBuffer(256);
          lineStringBuffer.setLength(0);
          BufferedReader buff=new BufferedReader(BIS);
          String sLine=null;
          while ((sLine=buff.readLine()) != null) {
            db.execStatements(sLine);
          }
        }
 catch (        Exception e) {
          throw new KettleDatabaseException(Messages.getString("JobSQL.ErrorRunningSQLfromFile"),e);
        }
      }
 else {
        String mySQL=null;
        if (useVariableSubstitution)         mySQL=environmentSubstitute(sql);
 else         mySQL=sql;
        db.execStatements(mySQL);
      }
    }
 catch (    KettleDatabaseException je) {
      result.setNrErrors(1);
      log.logError(toString(),Messages.getString("JobSQL.ErrorRunJobEntry",je.getMessage()));
    }
 finally {
      db.disconnect();
      if (SQLfile != null) {
        try {
          SQLfile.close();
        }
 catch (        Exception e) {
        }
      }
    }
  }
 else {
    result.setNrErrors(1);
    log.logError(toString(),Messages.getString("JobSQL.NoDatabaseConnection"));
  }
  if (result.getNrErrors() == 0) {
    result.setResult(true);
  }
 else {
    result.setResult(false);
  }
  return result;
}
