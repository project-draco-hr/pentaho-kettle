{
  this.sortfield=sortField;
  this.sortingDescending=sortingDescending;
  try {
    table.setSortColumn(table.getColumn(sortfield));
    table.setSortDirection(sortingDescending ? SWT.DOWN : SWT.UP);
    TableItem[] items=table.getItems();
    List<Object[]> v=new ArrayList<Object[]>();
    final RowMetaInterface rowMeta=new RowMeta();
    rowMeta.addValueMeta(new ValueMeta("colorname",ValueMetaInterface.TYPE_STRING));
    rowMeta.addValueMeta(new ValueMeta("color",ValueMetaInterface.TYPE_INTEGER));
    for (int j=0; j < table.getColumnCount(); j++) {
      ColumnInfo colInfo;
      if (j > 0)       colInfo=columns[j - 1];
 else       colInfo=numberColumn;
      ValueMetaInterface valueMeta=colInfo.getValueMeta();
      if (j == sortField)       valueMeta.setSortedDescending(sortingDescending);
      rowMeta.addValueMeta(valueMeta);
    }
    RowMetaInterface sourceRowMeta=(RowMetaInterface)rowMeta.clone();
    for (int i=0; i < sourceRowMeta.size(); i++)     sourceRowMeta.getValueMeta(i).setType(ValueMetaInterface.TYPE_STRING);
    for (int i=0; i < items.length; i++) {
      TableItem item=items[i];
      Object[] r=new Object[table.getColumnCount() + 2];
      Color bg=item.getBackground();
      if (!bg.equals(defaultBackgroundColor)) {
        String colorName="bg " + bg.toString();
        r[0]=colorName;
        r[1]=new Long((bg.getRed() << 16) + (bg.getGreen() << 8) + (bg.getBlue()));
        usedColors.put(colorName,bg);
      }
      for (int j=0; j < table.getColumnCount(); j++) {
        String data=item.getText(j);
        ValueMetaInterface targetValueMeta=rowMeta.getValueMeta(j + 2);
        ValueMetaInterface sourceValueMeta=sourceRowMeta.getValueMeta(j + 2);
        r[j + 2]=targetValueMeta.convertData(sourceValueMeta,data);
      }
      v.add(r);
    }
    final int[] sortIndex=new int[]{sortField + 2};
    Collections.sort(v,new Comparator<Object[]>(){
      public int compare(      Object[] r1,      Object[] r2){
        try {
          return rowMeta.compare(r1,r2,sortIndex);
        }
 catch (        KettleValueException e) {
          LogWriter.getInstance().logError("TableView sort","Error comparing rows: " + e.toString());
          return 0;
        }
      }
    }
);
    table.removeAll();
    for (int i=0; i < v.size(); i++) {
      Object[] r=v.get(i);
      TableItem item=new TableItem(table,SWT.NONE);
      String colorName=(String)r[0];
      Long colorValue=(Long)r[1];
      if (colorValue != null) {
        Color bg=usedColors.get(colorName);
        if (bg != null) {
          item.setBackground(bg);
        }
      }
      for (int j=2; j < r.length; j++) {
        String string=rowMeta.getString(r,j);
        if (string != null)         item.setText(j - 2,string);
      }
    }
  }
 catch (  Exception e) {
    new ErrorDialog(this.getShell(),Messages.getString("TableView.ErrorDialog.title"),Messages.getString("TableView.ErrorDialog.description"),e);
  }
}
