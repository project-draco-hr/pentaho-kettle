{
  try {
    currentMouseX=x;
    currentMouseY=y;
    final StepMeta stepMeta=transMeta.getStep(x,y,iconsize);
    if (stepMeta != null) {
      setCurrentStep(stepMeta);
      XulMenupopup menu=menuMap.get("trans-graph-entry");
      if (menu != null) {
        List<StepMeta> selection=transMeta.getSelectedSteps();
        int sels=selection.size();
        XulMenuitem item=(XulMenuitem)spoon.getMainSpoonContainer().getDocumentRoot().getElementById("trans-graph-entry-newhop");
        item.setDisabled(sels != 2);
        item=(XulMenuitem)spoon.getMainSpoonContainer().getDocumentRoot().getElementById("trans-graph-entry-open-mapping");
        item.setDisabled(!stepMeta.isMapping());
        item=(XulMenuitem)spoon.getMainSpoonContainer().getDocumentRoot().getElementById("trans-graph-entry-align-snap");
        item.setLabel(BaseMessages.getString(PKG,"TransGraph.PopupMenu.SnapToGrid") + ConstUI.GRID_SIZE + ")\tALT-HOME");
        XulMenu aMenu=(XulMenu)spoon.getMainSpoonContainer().getDocumentRoot().getElementById("trans-graph-entry-align");
        if (aMenu != null) {
          aMenu.setDisabled(sels < 2);
        }
        item=(XulMenuitem)spoon.getMainSpoonContainer().getDocumentRoot().getElementById("trans-graph-entry-data-movement-distribute");
        item.setSelected(!stepMeta.isDistributes());
        item=(XulMenuitem)spoon.getMainSpoonContainer().getDocumentRoot().getElementById("trans-graph-entry-data-movement-copy");
        item.setSelected(!stepMeta.isDistributes());
        item=(XulMenuitem)spoon.getMainSpoonContainer().getDocumentRoot().getElementById("trans-graph-entry-hide");
        item.setDisabled(!(stepMeta.isDrawn() && !transMeta.isStepUsedInTransHops(stepMeta)));
        item=(XulMenuitem)spoon.getMainSpoonContainer().getDocumentRoot().getElementById("trans-graph-entry-detach");
        item.setDisabled(!transMeta.isStepUsedInTransHops(stepMeta));
        item=(XulMenuitem)spoon.getMainSpoonContainer().getDocumentRoot().getElementById("trans-graph-entry-errors");
        item.setDisabled(!stepMeta.supportsErrorHandling());
        ConstUI.displayMenu((Menu)menu.getManagedObject(),canvas);
      }
    }
 else {
      final TransHopMeta hi=findHop(x,y);
      if (hi != null) {
        XulMenupopup menu=menuMap.get("trans-graph-hop");
        if (menu != null) {
          setCurrentHop(hi);
          XulMenuitem item=(XulMenuitem)spoon.getMainSpoonContainer().getDocumentRoot().getElementById("trans-graph-hop-enabled");
          if (item != null) {
            if (hi.isEnabled()) {
              item.setLabel(BaseMessages.getString(PKG,"TransGraph.PopupMenu.DisableHop"));
            }
 else {
              item.setLabel(BaseMessages.getString(PKG,"TransGraph.PopupMenu.EnableHop"));
            }
          }
          ConstUI.displayMenu((Menu)menu.getManagedObject(),canvas);
        }
      }
 else {
        final NotePadMeta ni=transMeta.getNote(x,y);
        setCurrentNote(ni);
        if (ni != null) {
          XulMenupopup menu=menuMap.get("trans-graph-note");
          if (menu != null) {
            ConstUI.displayMenu((Menu)menu.getManagedObject(),canvas);
          }
        }
 else {
          XulMenupopup menu=menuMap.get("trans-graph-background");
          if (menu != null) {
            final String clipcontent=spoon.fromClipboard();
            XulMenuitem item=(XulMenuitem)spoon.getMainSpoonContainer().getDocumentRoot().getElementById("trans-graph-background-paste");
            if (item != null) {
              item.setDisabled(clipcontent == null);
            }
            ConstUI.displayMenu((Menu)menu.getManagedObject(),canvas);
          }
        }
      }
    }
  }
 catch (  Throwable t) {
    t.printStackTrace();
  }
}
