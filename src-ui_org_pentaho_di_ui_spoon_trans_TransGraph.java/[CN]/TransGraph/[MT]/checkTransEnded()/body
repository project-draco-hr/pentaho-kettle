{
  if (trans != null) {
    if (trans.isFinished() && (running || halted)) {
      log.logMinimal(Spoon.APP_NAME,Messages.getString("TransLog.Log.TransformationHasFinished"));
      running=false;
      initialized=false;
      halted=false;
      halting=false;
      try {
        trans.endProcessing(Database.LOG_STATUS_END);
        if (spoonHistoryRefresher != null)         spoonHistoryRefresher.markRefreshNeeded();
      }
 catch (      KettleException e) {
        new ErrorDialog(shell,Messages.getString("TransLog.Dialog.ErrorWritingLogRecord.Title"),Messages.getString("TransLog.Dialog.ErrorWritingLogRecord.Message"),e);
      }
      setControlStates();
      if (debug && lastTransDebugMeta != null && lastTransDebugMeta.getTotalNumberOfHits() == 0) {
        debug=false;
        showLastPreviewResults();
      }
      debug=false;
      checkErrorVisuals();
      shell.getDisplay().asyncExec(new Runnable(){
        public void run(){
          redraw();
        }
      }
);
    }
  }
}
