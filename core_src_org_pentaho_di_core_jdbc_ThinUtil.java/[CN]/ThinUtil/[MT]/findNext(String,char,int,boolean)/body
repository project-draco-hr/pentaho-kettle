{
  int quoteIndex=index;
  while (true) {
    index++;
    if (index >= sql.length()) {
      break;
    }
    boolean quoteMatch=sql.charAt(index) == nextChar;
    if (quoteMatch) {
      boolean escaped=escape && index + 1 < sql.length() && sql.charAt(index + 1) == nextChar;
      if (quoteMatch && !escaped) {
        break;
      }
      if (escaped) {
        index++;
      }
    }
  }
  if (index + 1 > sql.length()) {
    throw new KettleSQLException("No closing " + nextChar + " found, starting at location "+ quoteIndex+ " in : ["+ sql+ "]");
  }
  index++;
  return index;
}
