{
  Object[] rowData;
  if (data.readsRows) {
    rowData=getRow();
    if (rowData == null) {
      setOutputDone();
      return false;
    }
  }
 else {
    rowData=RowDataUtil.allocateRowData(0);
    incrementLinesRead();
  }
  if (first && rowData != null) {
    first=false;
    if (data.readsRows) {
      data.inputRowMeta=getInputRowMeta();
    }
 else {
      data.inputRowMeta=new RowMeta();
    }
    data.outputRowMeta=data.inputRowMeta.clone();
    meta.getFields(data.outputRowMeta,getStepname(),null,null,this,repository,metaStore);
    data.conversionMeta=data.outputRowMeta.cloneToType(ValueMetaInterface.TYPE_STRING);
    int fieldsLength=meta.getFieldDefinitions().length;
    data.extraData=new Object[fieldsLength];
    for (int i=0; i < fieldsLength; i++) {
      String newValue=environmentSubstitute(meta.getFieldDefinitions()[i].getVariableString());
      if (log.isDetailed()) {
        logDetailed("field [" + meta.getFieldDefinitions()[i].getFieldName() + "] has value ["+ newValue+ "]");
      }
      ValueMetaInterface targetMeta=data.outputRowMeta.getValueMeta(data.inputRowMeta.size() + i);
      ValueMetaInterface sourceMeta=data.conversionMeta.getValueMeta(data.inputRowMeta.size() + i);
      data.extraData[i]=targetMeta.convertData(sourceMeta,newValue);
    }
  }
  rowData=RowDataUtil.addRowData(rowData,data.inputRowMeta.size(),data.extraData);
  putRow(data.outputRowMeta,rowData);
  if (!data.readsRows) {
    setOutputDone();
    return false;
  }
  return true;
}
