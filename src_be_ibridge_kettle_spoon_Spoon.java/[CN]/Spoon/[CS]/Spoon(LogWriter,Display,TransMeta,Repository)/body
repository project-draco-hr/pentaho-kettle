{
  this.log=log;
  this.rep=rep;
  if (d != null) {
    disp=d;
    destroy=false;
  }
 else {
    disp=new Display();
    destroy=true;
  }
  shell=new Shell(disp);
  shell.setText(APPL_TITLE);
  FormLayout layout=new FormLayout();
  layout.marginWidth=0;
  layout.marginHeight=0;
  shell.setLayout(layout);
  if (ti == null) {
    this.transMeta=new TransMeta();
  }
 else {
    this.transMeta=ti;
  }
  if (!Props.isInitialized()) {
    log.logDetailed(toString(),Messages.getString("Spoon.Log.LoadProperties"));
    Props.init(disp,Props.TYPE_PROPERTIES_SPOON);
  }
  props=Props.getInstance();
  loadSettings();
  remarks=new ArrayList();
  impact=new ArrayList();
  impactHasRun=false;
  variables=new Row();
  shell.setImage(GUIResource.getInstance().getImageSpoon());
  cursor_hourglass=new Cursor(disp,SWT.CURSOR_WAIT);
  cursor_hand=new Cursor(disp,SWT.CURSOR_HAND);
  defKeys=new KeyAdapter(){
    public void keyPressed(    KeyEvent e){
      boolean ctrl=((e.stateMask & SWT.CONTROL) != 0);
      boolean alt=((e.stateMask & SWT.ALT) != 0);
      if (e.keyCode == SWT.ESC) {
        spoongraph.clearSettings();
        transMeta.unselectAll();
        refreshGraph();
      }
      ;
      if (e.keyCode == SWT.F3) {
        createDatabaseWizard();
      }
      if (e.keyCode == SWT.F4) {
        copyTableWizard();
      }
      if (e.keyCode == SWT.F5) {
        refreshGraph();
        refreshTree(true);
      }
      if (e.keyCode == SWT.F6) {
        showLastImpactAnalyses();
      }
      if (e.keyCode == SWT.F7) {
        showLastTransCheck();
      }
      if (e.keyCode == SWT.F8) {
        spoonlog.showPreview();
      }
      if (e.keyCode == SWT.F9) {
        tabfolder.setSelection(1);
        spoonlog.startstop();
      }
      if (e.keyCode == SWT.F10) {
        spoonlog.preview();
      }
      if (e.keyCode == SWT.F11) {
        checkTrans();
        spoongraph.clearSettings();
      }
      if ((int)e.character == 1 && ctrl && !alt) {
        transMeta.selectAll();
      }
      ;
      if ((int)e.character == 4 && ctrl && !alt) {
        closeRepository();
        spoongraph.clearSettings();
      }
      ;
      if ((int)e.character == 5 && ctrl && !alt) {
        exploreRepository();
        spoongraph.clearSettings();
      }
      ;
      if ((int)e.character == 6 && ctrl && !alt) {
        searchMetaData();
        spoongraph.clearSettings();
      }
      ;
      if ((int)e.character == 9 && ctrl && !alt) {
        openFile(true);
        spoongraph.clearSettings();
      }
      ;
      if ((int)e.character == 9 && ctrl && alt) {
        copyTransformationImage();
        spoongraph.clearSettings();
      }
      if ((int)e.character == 10 && ctrl && !alt) {
        getVariables();
        spoongraph.clearSettings();
      }
      ;
      if ((int)e.character == 11 && ctrl && !alt) {
        createKettleArchive();
        spoongraph.clearSettings();
      }
      ;
      if ((int)e.character == 12 && ctrl && !alt) {
        showVariables();
        spoongraph.clearSettings();
      }
      ;
      if ((int)e.character == 14 && ctrl && !alt) {
        newFile();
        spoongraph.clearSettings();
      }
      if ((int)e.character == 15 && ctrl && !alt) {
        openFile(false);
        spoongraph.clearSettings();
      }
      if ((int)e.character == 16 && ctrl && !alt) {
        printFile();
        spoongraph.clearSettings();
      }
      if ((int)e.character == 17 && ctrl && !alt) {
        analyseImpact();
        spoongraph.clearSettings();
      }
      if ((int)e.character == 18 && ctrl && !alt) {
        openRepository();
        spoongraph.clearSettings();
      }
      ;
      if ((int)e.character == 19 && ctrl && !alt) {
        saveFile();
        spoongraph.clearSettings();
      }
      if ((int)e.character == 19 && ctrl && alt) {
        sendXMLToSlaveServer();
        spoongraph.clearSettings();
      }
      if ((int)e.character == 20 && ctrl && !alt) {
        setTrans();
        spoongraph.clearSettings();
      }
      if ((int)e.character == 21 && ctrl && !alt) {
        splitTrans(true,true,true);
        spoongraph.clearSettings();
      }
      if ((int)e.character == 25 && ctrl && !alt) {
        redoAction();
        spoongraph.clearSettings();
      }
      if ((int)e.character == 26 && ctrl && !alt) {
        spoongraph.clearSettings();
        undoAction();
      }
    }
  }
;
  modKeys=new KeyAdapter(){
    public void keyPressed(    KeyEvent e){
      spoongraph.shift=(e.keyCode == SWT.SHIFT);
      spoongraph.control=(e.keyCode == SWT.CONTROL);
    }
    public void keyReleased(    KeyEvent e){
      spoongraph.shift=(e.keyCode == SWT.SHIFT);
      spoongraph.control=(e.keyCode == SWT.CONTROL);
    }
  }
;
  addBar();
  FormData fdBar=new FormData();
  fdBar.left=new FormAttachment(0,0);
  fdBar.top=new FormAttachment(0,0);
  tBar.setLayoutData(fdBar);
  sashform=new SashForm(shell,SWT.HORIZONTAL);
  FormData fdSash=new FormData();
  fdSash.left=new FormAttachment(0,0);
  fdSash.top=new FormAttachment(tBar,0);
  fdSash.bottom=new FormAttachment(100,0);
  fdSash.right=new FormAttachment(100,0);
  sashform.setLayoutData(fdSash);
  addMenu();
  addTree();
  addTabs();
  setTreeImages();
  shell.addShellListener(new ShellAdapter(){
    public void shellClosed(    ShellEvent e){
      e.doit=quitFile();
    }
  }
);
  shell.layout();
  WindowProperty winprop=props.getScreen(APPL_TITLE);
  if (winprop != null)   winprop.setShell(shell);
 else {
    shell.pack();
    shell.setMaximized(true);
  }
}
