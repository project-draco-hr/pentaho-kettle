{
  boolean retval=false;
  try {
    WorkbookSettings ws=new WorkbookSettings();
    ws.setLocale(Locale.getDefault());
    if (!Const.isEmpty(meta.getEncoding())) {
      ws.setEncoding(meta.getEncoding());
    }
    String filename=buildFilename();
    if (log.isDebug())     log.logDebug(toString(),Messages.getString("ExcelOutput.Log.OpeningFile",filename));
    data.file=KettleVFS.getFileObject(filename);
    if (meta.isAddToResultFiles()) {
      ResultFile resultFile=new ResultFile(ResultFile.FILE_TYPE_GENERAL,data.file,getTransMeta().getName(),getStepname());
      resultFile.setComment("This file was created with an Excel output step by Pentaho Data Integration");
      addResultFile(resultFile);
    }
    if (!meta.isTemplateEnabled()) {
      if (meta.isAppend() && data.file.exists()) {
        boolean find=false;
        int position=0;
        data.workbook=Workbook.createWorkbook(KettleVFS.getOutputStream(data.file,false),Workbook.getWorkbook(KettleVFS.getInputStream(data.file)));
        String listSheets[]=data.workbook.getSheetNames();
        for (int i=0; i < listSheets.length; i++) {
          if (listSheets[i].equals(data.realSheetname)) {
            find=true;
            position=i;
          }
        }
        if (find) {
          data.workbook.removeSheet(position);
        }
        data.sheet=data.workbook.createSheet(data.realSheetname,data.workbook.getNumberOfSheets() + 1);
      }
 else {
        data.workbook=Workbook.createWorkbook(KettleVFS.getOutputStream(data.file,false),ws);
        String sheetname="Sheet1";
        data.sheet=data.workbook.getSheet(sheetname);
        if (data.sheet == null) {
          data.sheet=data.workbook.createSheet(sheetname,0);
        }
      }
    }
 else {
      FileObject fo=KettleVFS.getFileObject(environmentSubstitute(meta.getTemplateFileName()));
      Workbook tmpWorkbook=Workbook.getWorkbook(KettleVFS.getInputStream(fo),ws);
      data.workbook=Workbook.createWorkbook(KettleVFS.getOutputStream(data.file,false),tmpWorkbook);
      tmpWorkbook.close();
      data.sheet=data.workbook.getSheet(0);
      data.templateColumns=data.sheet.getColumns();
    }
    if (!Const.isEmpty(environmentSubstitute(meta.getSheetname()))) {
      data.sheet.setName(data.realSheetname);
    }
    if (meta.isSheetProtected()) {
      data.sheet.getSettings().setProtected(true);
      data.sheet.getSettings().setPassword(environmentSubstitute(meta.getPassword()));
    }
    data.positionX=0;
    if (meta.isTemplateEnabled() && meta.isTemplateAppend()) {
      data.positionY=data.sheet.getRows();
    }
 else {
      data.positionY=0;
    }
    data.headerWrote=false;
    if (log.isDebug())     log.logDebug(toString(),Messages.getString("ExcelOutput.Log.FileOpened",filename));
    retval=true;
  }
 catch (  Exception e) {
    logError("Error opening new file",e);
    setErrors(1);
  }
  data.splitnr++;
  return retval;
}
