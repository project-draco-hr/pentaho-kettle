{
  if (!request.getRequestURI().equals(CONTEXT_PATH + "/"))   return;
  if (log.isDebug())   log.logDebug(toString(),"Addition of transformation requested");
  boolean useXML="Y".equalsIgnoreCase(request.getParameter("xml"));
  PrintWriter out=response.getWriter();
  InputStream is=request.getInputStream();
  if (useXML) {
    response.setContentType("text/xml");
    out.print(XMLHandler.getXMLHeader());
  }
 else {
    response.setContentType("text/html");
    out.println("<HTML>");
    out.println("<HEAD><TITLE>Add transformation</TITLE></HEAD>");
    out.println("<BODY>");
  }
  response.setStatus(HttpServletResponse.SC_OK);
  try {
    int c;
    StringBuffer xml=new StringBuffer();
    while ((c=is.read()) != -1) {
      xml.append((char)c);
    }
    TransConfiguration transConfiguration=TransConfiguration.fromXML(xml.toString());
    TransMeta transMeta=transConfiguration.getTransMeta();
    transMeta.injectVariables(transConfiguration.getTransExecutionConfiguration().getVariables());
    final Repository repository=transConfiguration.getTransExecutionConfiguration().getRepository();
    final Trans trans=new Trans(transMeta);
    trans.setRepository(repository);
    Trans oldOne=transformationMap.getTransformation(trans.getName());
    if (oldOne != null && !oldOne.isFinished()) {
      if (oldOne.isRunning() || oldOne.isPreparing() || oldOne.isInitializing()) {
        throw new Exception("A transformation with the same name exists and is not idle." + Const.CR + "Please stop the transformation first.");
      }
    }
    transformationMap.addTransformation(transMeta.getName(),trans,transConfiguration);
    if (repository != null) {
      new Thread(new Runnable(){
        public void run(){
          while (!trans.isFinished()) {
            try {
              Thread.sleep(250);
            }
 catch (            InterruptedException e) {
            }
          }
          repository.disconnect();
        }
      }
).start();
    }
    String message;
    if (oldOne != null) {
      message="Transformation '" + trans.getName() + "' was replaced in the list.";
    }
 else {
      message="Transformation '" + trans.getName() + "' was added to the list.";
    }
    if (useXML) {
      out.println(new WebResult(WebResult.STRING_OK,message));
    }
 else {
      out.println("<H1>" + message + "</H1>");
      out.println("<p><a href=\"/kettle/transStatus?name=" + trans.getName() + "\">Go to the transformation status page</a><p>");
    }
  }
 catch (  Exception ex) {
    if (useXML) {
      out.println(new WebResult(WebResult.STRING_ERROR,Const.getStackTracker(ex)));
    }
 else {
      out.println("<p>");
      out.println("<pre>");
      ex.printStackTrace(out);
      out.println("</pre>");
    }
  }
  if (!useXML) {
    out.println("<p>");
    out.println("</BODY>");
    out.println("</HTML>");
  }
}
