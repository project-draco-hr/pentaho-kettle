{
  InputStream inputStream=null;
  try {
    CsvInputMeta meta=new CsvInputMeta();
    getInfo(meta);
    String filename=transMeta.environmentSubstitute(meta.getFilename());
    FileObject fileObject=KettleVFS.getFileObject(filename);
    if (!(fileObject instanceof LocalFile)) {
      throw new KettleException(Messages.getString("CsvInput.Log.OnlyLocalFilesAreSupported"));
    }
    wFields.table.removeAll();
    inputStream=KettleVFS.getInputStream(fileObject);
    InputStreamReader reader=new InputStreamReader(inputStream);
    String line=TextFileInput.getLine(log,reader,TextFileInputMeta.FILE_FORMAT_MIXED,new StringBuffer(1000));
    String[] fieldNames=line.split(meta.getDelimiter());
    if (!meta.isHeaderPresent()) {
      DecimalFormat df=new DecimalFormat("000");
      for (int i=0; i < fieldNames.length; i++) {
        fieldNames[i]="Field_" + df.format(i);
      }
    }
    for (int i=0; i < fieldNames.length; i++) {
      TableItem item=new TableItem(wFields.table,SWT.NONE);
      item.setText(1,fieldNames[i]);
      item.setText(2,ValueMeta.getTypeDesc(ValueMetaInterface.TYPE_STRING));
    }
    wFields.removeEmptyRows();
    wFields.setRowNums();
    wFields.optWidth(true);
    String shellText=org.pentaho.di.trans.steps.textfileinput.Messages.getString("CsvInputDialog.LinesToSample.DialogTitle");
    String lineText=org.pentaho.di.trans.steps.textfileinput.Messages.getString("CsvInputDialog.LinesToSample.DialogMessage");
    EnterNumberDialog end=new EnterNumberDialog(shell,100,shellText,lineText);
    int samples=end.open();
    if (samples >= 0) {
      getInfo(meta);
      TextFileCSVImportProgressDialog pd=new TextFileCSVImportProgressDialog(shell,meta,transMeta,reader,samples,SWT.YES);
      String message=pd.open();
      if (message != null) {
        wFields.removeAll();
        getData(meta);
        wFields.removeEmptyRows();
        wFields.setRowNums();
        wFields.optWidth(true);
        EnterTextDialog etd=new EnterTextDialog(shell,Messages.getString("CsvInputDialog.ScanResults.DialogTitle"),Messages.getString("CsvInputDialog.ScanResults.DialogMessage"),message,true);
        etd.setReadOnly();
        etd.open();
      }
    }
  }
 catch (  IOException e) {
    new ErrorDialog(shell,Messages.getString("CsvInputDialog.IOError.DialogTitle"),Messages.getString("CsvInputDialog.IOError.DialogMessage"),e);
  }
catch (  KettleException e) {
    new ErrorDialog(shell,Messages.getString("System.Dialog.Error.Title"),Messages.getString("CsvInputDialog.ErrorGettingFileDesc.DialogMessage"),e);
  }
 finally {
    try {
      inputStream.close();
    }
 catch (    Exception e) {
    }
  }
}
