{
  meta=(SwitchCaseMeta)smi;
  data=(SwitchCaseData)sdi;
  Object[] r=getRow();
  if (r == null) {
    setOutputDone();
    return false;
  }
  if (first) {
    first=false;
    data.outputRowMeta=getInputRowMeta().clone();
    meta.getFields(getInputRowMeta(),getStepname(),null,null,this);
    data.fieldIndex=getInputRowMeta().indexOfValue(meta.getFieldname());
    if (data.fieldIndex < 0) {
      throw new KettleException(BaseMessages.getString(PKG,"SwitchCase.Exception.UnableToFindFieldName",meta.getFieldname()));
    }
    data.inputValueMeta=getInputRowMeta().getValueMeta(data.fieldIndex);
    try {
      StepIOMetaInterface ioMeta=meta.getStepIOMeta();
      List<StreamInterface> targetStreams=ioMeta.getTargetStreams();
      for (int i=0; i < targetStreams.size(); i++) {
        SwitchCaseTarget target=(SwitchCaseTarget)targetStreams.get(i).getSubject();
        if (target != null && target.caseTargetStep == null) {
          throw new KettleException(BaseMessages.getString(PKG,"SwitchCase.Log.NoTargetStepSpecifiedForValue",target.caseValue));
        }
 else         if (target != null) {
          RowSet rowSet=findOutputRowSet(target.caseTargetStep.getName());
          if (rowSet != null) {
            try {
              Object value=data.valueMeta.convertDataFromString(target.caseValue,data.stringValueMeta,null,null,ValueMeta.TRIM_TYPE_NONE);
              if (data.valueMeta.isNull(value)) {
                data.nullRowSet=rowSet;
              }
 else {
                data.outputMap.put(value,rowSet);
              }
            }
 catch (            Exception e) {
              throw new KettleException(BaseMessages.getString(PKG,"SwitchCase.Log.UnableToConvertValue",target.caseValue),e);
            }
          }
 else {
            throw new KettleException(BaseMessages.getString(PKG,"SwitchCase.Log.UnableToFindTargetRowSetForStep",target.caseTargetStep));
          }
        }
      }
      if (meta.getDefaultTargetStep() != null) {
        data.defaultRowSet=findOutputRowSet(meta.getDefaultTargetStep().getName());
      }
 else {
        data.defaultRowSet=null;
      }
      ;
    }
 catch (    Exception e) {
      throw new KettleException(e);
    }
  }
  Object lookupData=data.valueMeta.convertData(data.inputValueMeta,r[data.fieldIndex]);
  RowSet rowSet=null;
  if (data.inputValueMeta.isNull(lookupData)) {
    rowSet=data.nullRowSet;
  }
 else {
    rowSet=data.outputMap.get(lookupData);
  }
  if (rowSet == null) {
    if (data.defaultRowSet != null) {
      putRowTo(data.outputRowMeta,r,data.defaultRowSet);
    }
  }
 else {
    putRowTo(data.outputRowMeta,r,rowSet);
  }
  if (checkFeedback(getLinesRead())) {
    if (log.isBasic())     logBasic(BaseMessages.getString(PKG,"SwitchCase.Log.LineNumber") + getLinesRead());
  }
  return true;
}
