{
  Row lu=new Row();
  Row add;
  Value technicalKey;
  Value valueVersion;
  Value valueDate=null;
  Value valueDateFrom=null;
  Value valueDateTo=null;
  if (first) {
    first=false;
    determineTechKeyCreation();
    if (getCopy() == 0)     data.db.checkDimZero(meta.getSchemaName(),meta.getTableName(),meta.getKeyField(),meta.getVersionField(),meta.isAutoIncrement());
    data.db.setDimLookup(meta.getSchemaName(),meta.getTableName(),meta.getKeyLookup(),meta.getKeyField(),meta.getVersionField(),meta.getFieldLookup(),meta.getFieldStream(),meta.getDateFrom(),meta.getDateTo(),meta.getCacheSize() >= 0);
    data.keynrs=new int[meta.getKeyStream().length];
    for (int i=0; i < meta.getKeyStream().length; i++) {
      data.keynrs[i]=row.searchValueIndex(meta.getKeyStream()[i]);
      if (data.keynrs[i] < 0) {
        throw new KettleStepException(Messages.getString("DimensionLookup.Exception.KeyFieldNotFound",meta.getKeyStream()[i]));
      }
    }
    if (meta.isUpdate()) {
      data.fieldnrs=new int[meta.getFieldStream().length];
      for (int i=0; meta.getFieldStream() != null && i < meta.getFieldStream().length; i++) {
        data.fieldnrs[i]=row.searchValueIndex(meta.getFieldStream()[i]);
        if (data.fieldnrs[i] < 0) {
          throw new KettleStepException(Messages.getString("DimensionLookup.Exception.KeyFieldNotFound",meta.getFieldStream()[i]));
        }
      }
    }
    if (meta.getDateField() != null && meta.getDateField().length() > 0) {
      data.datefieldnr=row.searchValueIndex(meta.getDateField());
    }
 else {
      data.datefieldnr=-1;
    }
    data.notFoundTk=new Value(meta.getKeyField(),(long)meta.getDatabaseMeta().getNotFoundTK(meta.isAutoIncrement()));
    if (meta.getKeyRename() != null && meta.getKeyRename().length() > 0)     data.notFoundTk.setName(meta.getKeyRename());
    if (meta.getDateField() != null && data.datefieldnr >= 0) {
      data.valueDateNow=row.getValue(data.datefieldnr);
    }
 else {
      Calendar cal=Calendar.getInstance();
      data.valueDateNow=new Value("MIN",new Date(cal.getTimeInMillis()));
    }
    if (meta.getCacheSize() >= 0) {
      data.keyMeta=new Row();
      for (int i=0; i < data.keynrs.length; i++) {
        Value key=new Value(row.getValue(data.keynrs[i]));
        data.keyMeta.addValue(key.Clone());
      }
      data.cache=new ByteArrayHashIndex(meta.getCacheSize() > 0 ? meta.getCacheSize() : 5000,data.keyMeta);
    }
  }
  if (meta.getDateField() != null && data.datefieldnr >= 0) {
    data.valueDateNow=row.getValue(data.datefieldnr);
  }
  for (int i=0; i < meta.getKeyStream().length; i++) {
    try {
      lu.addValue(row.getValue(data.keynrs[i]));
    }
 catch (    Exception e) {
      throw new KettleStepException(Messages.getString("DimensionLookup.Exception.ErrorDetectedInGettingKey",i + "",data.keynrs[i] + "/" + row.size(),row.toString()));
    }
  }
  if (data.datefieldnr >= 0)   valueDate=row.getValue(data.datefieldnr);
 else   valueDate=data.valueDateNow;
  if (log.isDebug())   logDebug(Messages.getString("DimensionLookup.Log.LookupRow") + lu.toString() + " valueDate="+ valueDate.toString());
  add=null;
  if (meta.getCacheSize() >= 0) {
    add=getFromCache(lu,valueDate);
  }
  if (add == null) {
    data.db.setDimValues(lu,valueDate);
    add=data.db.getLookup();
    linesInput++;
    if (add != null && meta.getCacheSize() >= 0) {
      addToCache(lu,add);
    }
  }
  if (!meta.isUpdate()) {
    if (add == null) {
      add=new Row();
      add.addValue(data.notFoundTk);
      Value v;
      for (int i=0; i < meta.getFieldStream().length; i++) {
        if (meta.getFieldStream()[i] != null) {
          if (meta.getFieldStream()[i] != null)           v=new Value(meta.getFieldStream()[i],meta.getFieldUpdate()[i]);
 else           v=new Value(meta.getFieldLookup()[i],meta.getFieldUpdate()[i]);
          v.setNull();
          add.addValue(v);
        }
      }
      if (meta.getCacheSize() >= 0) {
        add.addValue(data.min_date.Clone());
        add.addValue(data.min_date.Clone());
      }
    }
 else {
      add.removeValue(1);
      if (meta.getKeyRename() != null && meta.getKeyRename().length() > 0)       add.getValue(0).setName(meta.getKeyRename());
    }
  }
 else {
    if (add == null) {
      if (log.isRowLevel())       logRowlevel(Messages.getString("DimensionLookup.Log.NoDimensionEntryFound") + lu + ")");
      valueDateFrom=new Value("MIN",meta.getMinDate());
      valueDateTo=new Value("MAX",meta.getMaxDate());
      valueVersion=new Value(meta.getVersionField(),1L);
      boolean autoinc=false;
      technicalKey=null;
switch (getTechKeyCreation()) {
case CREATION_METHOD_TABLEMAX:
        technicalKey=new Value(meta.getKeyField(),0L);
      data.db.getNextValue(getTransMeta().getCounters(),meta.getSchemaName(),meta.getTableName(),technicalKey);
    break;
case CREATION_METHOD_AUTOINC:
  autoinc=true;
technicalKey=new Value(meta.getKeyField(),0L);
break;
case CREATION_METHOD_SEQUENCE:
technicalKey=data.db.getNextSequenceValue(meta.getSchemaName(),meta.getSequenceName(),meta.getKeyField());
if (technicalKey != null && log.isRowLevel()) logRowlevel(Messages.getString("DimensionLookup.Log.FoundNextSequence") + technicalKey.toString());
break;
}
data.db.dimInsert(row,meta.getSchemaName(),meta.getTableName(),true,autoinc ? null : meta.getKeyField(),autoinc,technicalKey,meta.getVersionField(),valueVersion,meta.getDateFrom(),valueDateFrom,meta.getDateTo(),valueDateTo,meta.getFieldLookup(),data.fieldnrs,meta.getKeyStream(),meta.getKeyLookup(),data.keynrs);
linesOutput++;
add=new Row();
if (meta.getKeyRename() != null && meta.getKeyRename().length() > 0) technicalKey.setName(meta.getKeyRename());
add.addValue(technicalKey);
if (meta.getCacheSize() >= 0) {
Row values=getCacheValues(row,technicalKey,valueVersion,valueDateFrom,valueDateTo);
addToCache(lu,values);
}
if (log.isRowLevel()) logRowlevel(Messages.getString("DimensionLookup.Log.AddedDimensionEntry") + add.toString());
}
 else {
if (log.isRowLevel()) logRowlevel(Messages.getString("DimensionLookup.Log.DimensionEntryFound") + add);
technicalKey=add.getValue(0);
valueVersion=add.getValue(1);
valueDateFrom=new Value("MIN",meta.getMinDate());
valueDateTo=new Value("MAX",meta.getMaxDate());
int cmp;
boolean insert=false;
boolean identical=true;
boolean punch=false;
Value v1, v2;
for (int i=0; i < meta.getFieldStream().length; i++) {
v1=row.getValue(data.fieldnrs[i]);
v2=add.getValue(i + 2);
cmp=v1.compare(v2);
if (cmp != 0) identical=false;
if (cmp != 0 && meta.getFieldUpdate()[i] == DimensionLookupMeta.TYPE_UPDATE_DIM_INSERT) {
insert=true;
}
if (cmp != 0 && meta.getFieldUpdate()[i] == DimensionLookupMeta.TYPE_UPDATE_DIM_PUNCHTHROUGH) {
punch=true;
}
if (log.isRowLevel()) logRowlevel(Messages.getString("DimensionLookup.Log.ComparingValues","" + v1,"" + v2,String.valueOf(cmp),String.valueOf(identical),String.valueOf(insert),String.valueOf(punch)));
}
if (!insert) {
if (!identical) {
if (log.isRowLevel()) logRowlevel(Messages.getString("DimensionLookup.Log.UpdateRowWithValues") + row);
data.db.dimUpdate(row,meta.getSchemaName(),meta.getTableName(),meta.getFieldLookup(),data.fieldnrs,meta.getKeyField(),technicalKey);
linesUpdated++;
if (meta.getCacheSize() >= 0) {
Row values=getCacheValues(row,technicalKey,valueVersion,valueDateFrom,valueDateTo);
addToCache(lu,values);
}
}
 else {
if (log.isRowLevel()) logRowlevel(Messages.getString("DimensionLookup.Log.SkipLine"));
linesSkipped++;
}
}
 else {
if (log.isRowLevel()) logRowlevel(Messages.getString("DimensionLookup.Log.InsertNewVersion") + technicalKey.toString());
valueDateFrom=data.valueDateNow;
valueDateTo=new Value("MAX",meta.getMaxDate());
boolean autoinc=false;
if (meta.getDatabaseMeta().supportsAutoinc() && meta.isAutoIncrement()) {
autoinc=true;
technicalKey=new Value(meta.getKeyField(),0.0);
}
 else if (meta.getDatabaseMeta().supportsSequences() && meta.getSequenceName() != null && meta.getSequenceName().length() > 0) {
technicalKey=data.db.getNextSequenceValue(meta.getSchemaName(),meta.getSequenceName(),meta.getKeyField());
if (technicalKey != null && log.isRowLevel()) logRowlevel(Messages.getString("DimensionLookup.Log.FoundNextSequence2") + technicalKey.toString());
}
 else {
technicalKey=new Value(meta.getKeyField(),0L);
data.db.getNextValue(getTransMeta().getCounters(),meta.getSchemaName(),meta.getTableName(),technicalKey);
}
data.db.dimInsert(row,meta.getSchemaName(),meta.getTableName(),false,meta.getKeyField(),autoinc,technicalKey,meta.getVersionField(),valueVersion,meta.getDateFrom(),valueDateFrom,meta.getDateTo(),valueDateTo,meta.getFieldLookup(),data.fieldnrs,meta.getKeyStream(),meta.getKeyLookup(),data.keynrs);
linesOutput++;
if (meta.getCacheSize() >= 0) {
Row values=getCacheValues(row,technicalKey,valueVersion,valueDateFrom,valueDateTo);
addToCache(lu,values);
}
}
if (punch) {
data.db.dimPunchThrough(row,meta.getSchemaName(),meta.getTableName(),meta.getFieldUpdate(),meta.getFieldLookup(),data.fieldnrs,meta.getKeyStream(),meta.getKeyLookup(),data.keynrs);
linesUpdated++;
}
add=new Row();
if (meta.getKeyRename() != null && meta.getKeyRename().length() > 0) technicalKey.setName(meta.getKeyRename());
add.addValue(technicalKey);
if (log.isRowLevel()) logRowlevel(Messages.getString("DimensionLookup.Log.TechnicalKey") + technicalKey);
}
}
if (log.isRowLevel()) logRowlevel(Messages.getString("DimensionLookup.Log.AddValuesToRow") + add);
int size=add.size();
if (meta.getCacheSize() >= 0 && !meta.isUpdate()) {
size-=2;
}
for (int i=0; i < size; i++) {
row.addValue(add.getValue(i));
}
Value date;
if (data.datefieldnr >= 0) date=row.getValue(data.datefieldnr);
 else date=new Value("date",new Date());
if (data.min_date.compare(date) > 0) data.min_date.setValue(date.getDate());
if (data.max_date.compare(date) < 0) data.max_date.setValue(date.getDate());
}
