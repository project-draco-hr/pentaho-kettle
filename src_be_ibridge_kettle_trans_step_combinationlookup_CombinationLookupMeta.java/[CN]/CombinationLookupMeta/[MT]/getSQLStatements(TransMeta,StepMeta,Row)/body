{
  SQLStatement retval=new SQLStatement(stepMeta.getName(),database,null);
  int i;
  if (database != null) {
    if (prev != null && prev.size() > 0) {
      if (tablename != null && tablename.length() > 0) {
        Database db=new Database(database);
        try {
          boolean doHash=false;
          String cr_table=null;
          db.connect();
          Row fields=new Row();
          Value vkeyfield=new Value(technicalKeyField,Value.VALUE_TYPE_INTEGER);
          vkeyfield.setLength(10,0);
          Value vhashfield=null;
          if (useHash && hashField != null && hashField.length() > 0) {
            vhashfield=new Value(hashField,Value.VALUE_TYPE_INTEGER);
            vhashfield.setLength(15,0);
            doHash=true;
          }
          if (!db.checkTableExists(tablename)) {
            fields.addValue(vkeyfield);
            if (keyField != null && keyLookup != null) {
              int cnt=keyField.length;
              for (i=0; i < cnt; i++) {
                String error_field="";
                Value v=prev.searchValue(keyField[i]);
                if (v != null) {
                  String name=keyLookup[i];
                  Value newValue=(Value)v.clone();
                  newValue.setName(name);
                  if (name.equals(vkeyfield.getName()) || (doHash == true && name.equals(vhashfield.getName()))) {
                    error_field+=name;
                  }
                  if (error_field.length() > 0) {
                    retval.setError(Messages.getString("CombinationLookupMeta.ReturnValue.NameCollision",error_field));
                  }
 else {
                    fields.addValue(newValue);
                  }
                }
              }
            }
            if (doHash == true) {
              fields.addValue(vhashfield);
            }
          }
 else {
            Row tabFields=db.getTableFields(tablename);
            database.quoteReservedWords(tabFields);
            if (tabFields.searchValue(vkeyfield.getName()) == null) {
              fields.addValue(vkeyfield);
            }
            int cnt=tabFields.size();
            for (i=0; i < cnt; i++) {
              Value v=tabFields.getValue(i);
              fields.addValue(v);
            }
            String keyLookup[]=getKeyLookup();
            String keyField[]=getKeyField();
            if (keyField != null && keyLookup != null) {
              cnt=keyField.length;
              for (i=0; i < cnt; i++) {
                Value v=prev.searchValue(keyField[i]);
                if (v != null) {
                  Value newValue=(Value)v.clone();
                  newValue.setName(keyLookup[i]);
                  if (tabFields.searchValue(newValue.getName()) == null) {
                    fields.addValue(newValue);
                  }
                }
              }
            }
            if (doHash == true && tabFields.searchValue(vhashfield.getName()) == null) {
              fields.addValue(vhashfield);
            }
          }
          cr_table=db.getDDL(tablename,fields,(CREATION_METHOD_SEQUENCE.equals(getTechKeyCreation()) && sequenceFrom != null && sequenceFrom.length() == 0) ? technicalKeyField : null,CREATION_METHOD_AUTOINC.equals(getTechKeyCreation()),null,true);
          String cr_index="";
          String cr_uniq_index="";
          String idx_fields[]=null;
          if (useHash) {
            if (hashField != null && hashField.length() > 0) {
              idx_fields=new String[]{hashField};
            }
 else {
              retval.setError(Messages.getString("CombinationLookupMeta.ReturnValue.NotHashFieldSpecified"));
            }
          }
 else {
            if (keyLookup != null && keyLookup.length > 0) {
              int nrfields=keyLookup.length;
              if (nrfields > 32 && database.getDatabaseType() == DatabaseMeta.TYPE_DATABASE_ORACLE) {
                nrfields=32;
              }
              idx_fields=new String[nrfields];
              for (i=0; i < nrfields; i++)               idx_fields[i]=keyLookup[i];
            }
 else {
              retval.setError(Messages.getString("CombinationLookupMeta.ReturnValue.NotFieldsSpecified"));
            }
          }
          if (technicalKeyField != null) {
            String techKeyArr[]=new String[]{technicalKeyField};
            if (!db.checkIndexExists(tablename,techKeyArr)) {
              String indexname="idx_" + tablename + "_pk";
              cr_uniq_index=db.getCreateIndexStatement(tablename,indexname,techKeyArr,true,true,false,true);
              cr_uniq_index+=Const.CR;
            }
          }
          if (idx_fields != null && idx_fields.length > 0 && !db.checkIndexExists(tablename,idx_fields)) {
            String indexname="idx_" + tablename + "_lookup";
            cr_index=db.getCreateIndexStatement(tablename,indexname,idx_fields,false,false,false,true);
            cr_index+=Const.CR;
          }
          String cr_seq="";
          if ((database.getDatabaseType() == DatabaseMeta.TYPE_DATABASE_ORACLE) && CREATION_METHOD_SEQUENCE.equals(getTechKeyCreation()) && sequenceFrom != null && sequenceFrom.length() > 0) {
            if (!db.checkSequenceExists(sequenceFrom)) {
              cr_seq+=db.getCreateSequenceStatement(sequenceFrom,1L,1L,-1L,true);
              cr_seq+=Const.CR;
            }
          }
          retval.setSQL(cr_table + cr_uniq_index + cr_index+ cr_seq);
        }
 catch (        KettleException e) {
          retval.setError(Messages.getString("CombinationLookupMeta.ReturnValue.ErrorOccurred") + Const.CR + e.getMessage());
        }
      }
 else {
        retval.setError(Messages.getString("CombinationLookupMeta.ReturnValue.NotTableDefined"));
      }
    }
 else {
      retval.setError(Messages.getString("CombinationLookupMeta.ReturnValue.NotReceivingField"));
    }
  }
 else {
    retval.setError(Messages.getString("CombinationLookupMeta.ReturnValue.NotConnectionDefined"));
  }
  return retval;
}
