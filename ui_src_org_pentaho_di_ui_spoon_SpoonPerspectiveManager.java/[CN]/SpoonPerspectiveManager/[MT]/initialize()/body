{
  XulToolbar mainToolbar=(XulToolbar)domContainer.getDocumentRoot().getElementById("main-toolbar");
  SwtDeck deck=(SwtDeck)domContainer.getDocumentRoot().getElementById("canvas-deck");
  int y=0;
  int perspectiveIdx=0;
  Class<? extends SpoonPerspective> perClass=null;
  List<SpoonPerspective> perspectives=getPerspectives();
  if (this.startupPerspective != null) {
    for (int i=0; i < perspectives.size(); i++) {
      if (perspectives.get(i).getId().equals(this.startupPerspective)) {
        perspectiveIdx=i;
        break;
      }
    }
  }
  CCombo perspectivesCombo=null;
  if (PropsUI.getInstance().isLegacyPerspectiveMode()) {
    log.logDebug("Use legacy perspective switcher");
  }
 else {
    log.logDebug("Use new perspective switcher");
    final ToolBar toolbar=(ToolBar)mainToolbar.getManagedObject();
    perspectivesCombo=new CCombo(toolbar,SWT.SINGLE | SWT.READ_ONLY | SWT.BORDER);
    PropsUI.getInstance().setLook(perspectivesCombo);
    final CCombo c=perspectivesCombo;
    perspectivesCombo.addSelectionListener(new SelectionAdapter(){
      public void widgetSelected(      SelectionEvent se){
        Spoon.getInstance().loadPerspective(c.getData(c.getText()).toString());
        toolbar.forceFocus();
      }
    }
);
    perspectivesCombo.addKeyListener(new KeyAdapter(){
      public void keyPressed(      KeyEvent event){
        if (event.character == SWT.CR) {
          Spoon.getInstance().loadPerspective(c.getText());
        }
      }
    }
);
    ToolItem sep=new ToolItem(toolbar,SWT.SEPARATOR);
    sep.setWidth(120);
    if (Const.isLinux()) {
      sep.setWidth(150);
    }
    sep.setControl(perspectivesCombo);
    toolbar.forceFocus();
  }
  for (  final SpoonPerspective per : getPerspectives()) {
    if (installedPerspectives.contains(per)) {
      y++;
      continue;
    }
    String name=per.getDisplayName(LanguageChoice.getInstance().getDefaultLocale());
    SwtToolbarbutton btn=null;
    if (PropsUI.getInstance().isLegacyPerspectiveMode()) {
      try {
        btn=(SwtToolbarbutton)domContainer.getDocumentRoot().createElement("toolbarbutton");
      }
 catch (      XulException e) {
        log.logError("Error create toolbarbutton",e);
      }
      btn.setType("toggle");
      btn.setLabel(name);
      btn.setTooltiptext(name);
      btn.setOnclick("spoon.loadPerspective(" + y + ")");
      btn.setId("perspective-btn-" + per.getId());
      mainToolbar.addChild(btn);
      boolean iconSet=false;
      if (SpoonPerspectiveImageProvider.class.isAssignableFrom(per.getClass())) {
        String location=((SpoonPerspectiveImageProvider)per).getPerspectiveIconPath();
        Image image=GUIResource.getInstance().getImage(location,per.getClass().getClassLoader(),ConstUI.SMALL_ICON_SIZE,ConstUI.SMALL_ICON_SIZE);
        if (image != null) {
          btn.setImage(image);
          iconSet=true;
        }
      }
      if (!iconSet) {
        InputStream in=per.getPerspectiveIcon();
        if (in != null) {
          try {
            btn.setImageFromStream(in);
          }
  finally {
            IOUtils.closeQuietly(in);
          }
        }
      }
    }
 else {
      perspectivesCombo.add(name);
      perspectivesCombo.setData(name,per.getId());
    }
    XulVbox box=deck.createVBoxCard();
    box.setId("perspective-" + per.getId());
    box.setFlex(1);
    deck.addChild(box);
    PerspectiveInitializer perspectiveInitializer=new PerspectiveInitializer(per,box,mainToolbar,btn,perspectivesCombo,name);
    if (perspectiveIdx == y || y == 0) {
      if (perspectiveIdx == y) {
        if (btn != null) {
          btn.setSelected(true);
        }
        perClass=per.getClass();
      }
      perspectiveInitializer.initialize();
    }
 else {
      initializerMap.put(per,perspectiveInitializer);
    }
    y++;
    installedPerspectives.add(per);
  }
  deck.setSelectedIndex(perspectiveIdx);
  if (perClass != null) {
    try {
      activatePerspective(perClass);
      SpoonPerspectiveManager.getInstance().setForcePerspective(true);
    }
 catch (    KettleException e) {
    }
  }
}
