{
  try {
    if (ps != null) {
      if (!isAutoCommit()) {
        Integer batchCounter=batchCounterMap.get(ps);
        if (batch && getDatabaseMetaData().supportsBatchUpdates() && batchCounter != null && batchCounter.intValue() > 0) {
          ps.executeBatch();
          commit();
          batchCounterMap.remove(ps);
        }
 else {
          commit();
        }
      }
      ps.close();
    }
  }
 catch (  BatchUpdateException ex) {
    KettleDatabaseBatchException kdbe=new KettleDatabaseBatchException("Error updating batch",ex);
    kdbe.setUpdateCounts(ex.getUpdateCounts());
    List<Exception> exceptions=new ArrayList<Exception>();
    SQLException nextException=ex.getNextException();
    SQLException oldException=null;
    while ((nextException != null) && (oldException != nextException)) {
      exceptions.add(nextException);
      oldException=nextException;
      nextException=nextException.getNextException();
    }
    kdbe.setExceptionsList(exceptions);
    throw kdbe;
  }
catch (  SQLException ex) {
    throw new KettleDatabaseException("Unable to commit connection after having inserted rows.",ex);
  }
}
