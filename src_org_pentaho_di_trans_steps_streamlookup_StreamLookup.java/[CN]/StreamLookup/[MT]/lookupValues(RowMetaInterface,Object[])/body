{
  if (isStopped())   return null;
  if (lookupColumnIndex == -1) {
    String names[]=rowMeta.getFieldNames();
    for (int i=0; i < names.length; i++) {
      if (names[i].equals(data.lookupMeta.getValueMeta(0).getName())) {
        lookupColumnIndex=i;
        break;
      }
    }
  }
  if (lookupColumnIndex == -1) {
    throw new KettleStepException("The lookup column could not be found");
  }
  Object[] lu=RowDataUtil.resizeArray(row,data.keynrs.length);
  if (data.keyTypes != null) {
    for (int i=0; i < data.lookupMeta.size(); i++) {
      ValueMetaInterface inputValue=data.lookupMeta.getValueMeta(i);
      ValueMetaInterface lookupValue=data.keyTypes.getValueMeta(i);
      if (inputValue.getType() != lookupValue.getType()) {
        try {
          lu[i]=inputValue.convertData(lookupValue,lu[i]);
        }
 catch (        KettleValueException e) {
          throw new KettleStepException("Error converting data while looking up value",e);
        }
      }
    }
  }
  Object[] add;
  try {
    if (meta.getKeystream().length > 0) {
      Object lookupData[]=new Object[]{row[lookupColumnIndex]};
      add=getFromCache(data.lookupMeta,lookupData);
    }
 else {
      throw new KettleStepException(Messages.getString("StreamLookup.Log.GotRowWithoutKeys"));
    }
  }
 catch (  Exception e) {
    throw new KettleStepException(e);
  }
  if (add == null) {
    add=new Object[meta.getValue().length];
  }
  return RowDataUtil.addRowData(row,rowMeta.size(),add);
}
