{
  LDAPConnection connection=null;
  try {
    connection=new LDAPConnection(log,transMeta.environmentSubstitute(wHost.getText()),Const.toInt(transMeta.environmentSubstitute(wPort.getText()),LDAPConnection.DEFAULT_PORT));
    connection.setReferral(LDAPOutputMeta.getReferralTypeCode(LDAPOutputMeta.getReferralTypeByDesc(wReferral.getText())));
    connection.setDerefAliases(LDAPOutputMeta.getDerefAliasesCode(LDAPOutputMeta.getDerefAliasesTypeByDesc(wDerefAliases.getText())));
    if (wusingAuthentication.getSelection()) {
      String username=transMeta.environmentSubstitute(wUserName.getText());
      String password=Encr.decryptPasswordOptionallyEncrypted(transMeta.environmentSubstitute(wPassword.getText()));
      connection.connect(username,password);
    }
 else {
      connection.connect();
    }
    return connection.getFields(transMeta.environmentSubstitute(wBaseDN.getText()));
  }
  finally {
    if (connection != null) {
      try {
        connection.close();
      }
 catch (      Exception e) {
      }
      ;
    }
  }
}
