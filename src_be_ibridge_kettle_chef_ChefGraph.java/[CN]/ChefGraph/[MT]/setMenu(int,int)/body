{
  final JobEntryCopy je=chef.jobMeta.getChefGraphEntry(x,y,iconsize);
  if (je != null) {
    Menu mPop=new Menu((Control)this);
    MenuItem miNewHop=null;
    int sels=chef.jobMeta.nrSelected();
    if (sels == 2) {
      miNewHop=new MenuItem(mPop,SWT.CASCADE);
      miNewHop.setText("New hop");
    }
    final JobEntryInterface entry=je.getEntry();
switch (je.getType()) {
case JobEntryInterface.TYPE_JOBENTRY_TRANSFORMATION:
{
        MenuItem miLaunch=new MenuItem(mPop,SWT.CASCADE);
        miLaunch.setText("Launch Spoon");
        miLaunch.addSelectionListener(new SelectionAdapter(){
          public void widgetSelected(          SelectionEvent e){
            launchSpoon((JobEntryTrans)entry);
          }
        }
);
      }
    break;
case JobEntryInterface.TYPE_JOBENTRY_JOB:
{
    MenuItem miLaunch=new MenuItem(mPop,SWT.CASCADE);
    miLaunch.setText("Launch Chef");
    miLaunch.addSelectionListener(new SelectionAdapter(){
      public void widgetSelected(      SelectionEvent e){
        launchChef((JobEntryJob)entry);
      }
    }
);
  }
break;
default :
break;
}
MenuItem miEditStep=new MenuItem(mPop,SWT.CASCADE);
miEditStep.setText("Edit job entry");
MenuItem miEditDesc=new MenuItem(mPop,SWT.CASCADE);
miEditDesc.setText("Edit job entry description");
new MenuItem(mPop,SWT.SEPARATOR);
MenuItem miDupeStep=new MenuItem(mPop,SWT.CASCADE);
miDupeStep.setText("Duplicate job entry");
MenuItem miCopy=new MenuItem(mPop,SWT.CASCADE);
miCopy.setText("Copy selected entries to clipboard\tCTRL-C");
new MenuItem(mPop,SWT.SEPARATOR);
MenuItem miPopAD=new MenuItem(mPop,SWT.CASCADE);
miPopAD.setText("Allign / Distribute");
Menu mPopAD=new Menu(miPopAD);
MenuItem miPopALeft=new MenuItem(mPopAD,SWT.CASCADE);
miPopALeft.setText("Allign left\tCTRL-LEFT");
MenuItem miPopARight=new MenuItem(mPopAD,SWT.CASCADE);
miPopARight.setText("Allign right\tCTRL-RIGHT");
MenuItem miPopATop=new MenuItem(mPopAD,SWT.CASCADE);
miPopATop.setText("Allign top\tCTRL-UP");
MenuItem miPopABottom=new MenuItem(mPopAD,SWT.CASCADE);
miPopABottom.setText("Allign bottom\tCTRL-DOWN");
new MenuItem(mPopAD,SWT.SEPARATOR);
MenuItem miPopDHoriz=new MenuItem(mPopAD,SWT.CASCADE);
miPopDHoriz.setText("Distribute horizontally\tALT-RIGHT");
MenuItem miPopDVertic=new MenuItem(mPopAD,SWT.CASCADE);
miPopDVertic.setText("Distribute vertically\tALT-UP");
new MenuItem(mPopAD,SWT.SEPARATOR);
MenuItem miPopSSnap=new MenuItem(mPopAD,SWT.CASCADE);
miPopSSnap.setText("Snap to grid (size " + Const.GRID_SIZE + ")\tALT-HOME");
miPopAD.setMenu(mPopAD);
miPopALeft.addSelectionListener(new SelectionAdapter(){
public void widgetSelected(SelectionEvent e){
allignleft();
}
}
);
miPopARight.addSelectionListener(new SelectionAdapter(){
public void widgetSelected(SelectionEvent e){
allignright();
}
}
);
miPopATop.addSelectionListener(new SelectionAdapter(){
public void widgetSelected(SelectionEvent e){
alligntop();
}
}
);
miPopABottom.addSelectionListener(new SelectionAdapter(){
public void widgetSelected(SelectionEvent e){
allignbottom();
}
}
);
miPopDHoriz.addSelectionListener(new SelectionAdapter(){
public void widgetSelected(SelectionEvent e){
distributehorizontal();
}
}
);
miPopDVertic.addSelectionListener(new SelectionAdapter(){
public void widgetSelected(SelectionEvent e){
distributevertical();
}
}
);
miPopSSnap.addSelectionListener(new SelectionAdapter(){
public void widgetSelected(SelectionEvent e){
snaptogrid(Const.GRID_SIZE);
}
}
);
if (sels <= 1) {
miPopAD.setEnabled(false);
}
if (sels == 2) {
miNewHop.addSelectionListener(new SelectionAdapter(){
public void widgetSelected(SelectionEvent e){
selected_entries=null;
newHop();
}
}
);
}
miEditStep.addSelectionListener(new SelectionAdapter(){
public void widgetSelected(SelectionEvent e){
selected_entries=null;
editEntry(je);
}
}
);
miEditDesc.addSelectionListener(new SelectionAdapter(){
public void widgetSelected(SelectionEvent e){
String title="Step description dialog";
String message="Step description:";
EnterTextDialog dd=new EnterTextDialog(shell,chef.props,title,message,je.getDescription());
String des=dd.open();
if (des != null) je.setDescription(des);
}
}
);
miDupeStep.addSelectionListener(new SelectionAdapter(){
public void widgetSelected(SelectionEvent e){
chef.dupeChefGraphEntry(je.getName());
}
}
);
miCopy.addSelectionListener(new SelectionAdapter(){
public void widgetSelected(SelectionEvent e){
chef.copyJobEntries(chef.jobMeta.getSelectedEntries());
}
}
);
if (chef.jobMeta.isEntryUsedInHops(je)) {
new MenuItem(mPop,SWT.SEPARATOR);
MenuItem miDetach=new MenuItem(mPop,SWT.CASCADE);
miDetach.setText("Detach entry");
miDetach.addSelectionListener(new SelectionAdapter(){
public void widgetSelected(SelectionEvent e){
detach(je);
chef.jobMeta.unselectAll();
}
}
);
}
if (je.isDrawn() && !chef.jobMeta.isEntryUsedInHops(je)) {
new MenuItem(mPop,SWT.SEPARATOR);
MenuItem miHide=new MenuItem(mPop,SWT.CASCADE);
miHide.setText("Hide entry");
miHide.addSelectionListener(new SelectionAdapter(){
public void widgetSelected(SelectionEvent e){
je.setDrawn(false);
if (je.getNr() > 0) {
  int ind=chef.jobMeta.indexOfJobEntry(je);
  chef.jobMeta.removeJobEntry(ind);
  chef.addUndoDelete(new JobEntryCopy[]{je},new int[]{ind});
}
redraw();
}
}
);
}
setMenu(mPop);
}
 else {
final JobHopMeta hi=findJobHop(x,y);
if (hi != null) {
Menu mPop=new Menu((Control)this);
MenuItem miPopEval=new MenuItem(mPop,SWT.CASCADE);
miPopEval.setText("Evaluation");
Menu mPopAD=new Menu(miPopEval);
MenuItem miPopEvalUncond=new MenuItem(mPopAD,SWT.CASCADE | SWT.CHECK);
miPopEvalUncond.setText("Unconditional");
miPopEvalUncond.addSelectionListener(new SelectionAdapter(){
public void widgetSelected(SelectionEvent arg0){
hi.setUnconditional();
chef.refreshGraph();
}
}
);
MenuItem miPopEvalTrue=new MenuItem(mPopAD,SWT.CASCADE | SWT.CHECK);
miPopEvalTrue.setText("Follow when result is true");
miPopEvalTrue.addSelectionListener(new SelectionAdapter(){
public void widgetSelected(SelectionEvent arg0){
hi.setConditional();
hi.setEvaluation(true);
chef.refreshGraph();
}
}
);
MenuItem miPopEvalFalse=new MenuItem(mPopAD,SWT.CASCADE | SWT.CHECK);
miPopEvalFalse.setText("Follow when result is false");
miPopEvalFalse.addSelectionListener(new SelectionAdapter(){
public void widgetSelected(SelectionEvent arg0){
hi.setConditional();
hi.setEvaluation(false);
chef.refreshGraph();
}
}
);
if (hi.isUnconditional()) {
miPopEvalUncond.setSelection(true);
miPopEvalTrue.setSelection(false);
miPopEvalFalse.setSelection(false);
}
 else {
if (hi.getEvaluation()) {
miPopEvalUncond.setSelection(false);
miPopEvalTrue.setSelection(true);
miPopEvalFalse.setSelection(false);
}
 else {
miPopEvalUncond.setSelection(false);
miPopEvalTrue.setSelection(false);
miPopEvalFalse.setSelection(true);
}
}
if (!hi.from_entry.evaluates()) {
miPopEvalTrue.setEnabled(false);
miPopEvalFalse.setEnabled(false);
}
if (!hi.from_entry.isUnconditional()) {
miPopEvalUncond.setEnabled(false);
}
miPopEval.setMenu(mPopAD);
MenuItem miFlipHop=new MenuItem(mPop,SWT.CASCADE);
miFlipHop.setText("Flip direction");
MenuItem miDisHop=new MenuItem(mPop,SWT.CASCADE);
if (hi.isEnabled()) miDisHop.setText("Disable hop");
 else miDisHop.setText("Enable hop");
MenuItem miDelHop=new MenuItem(mPop,SWT.CASCADE);
miDelHop.setText("Delete hop");
miFlipHop.addSelectionListener(new SelectionAdapter(){
public void widgetSelected(SelectionEvent e){
selrect=null;
JobEntryCopy dummy=hi.from_entry;
hi.from_entry=hi.to_entry;
hi.to_entry=dummy;
if (chef.jobMeta.hasLoop(hi.from_entry)) {
  chef.refreshGraph();
  MessageBox mb=new MessageBox(shell,SWT.YES | SWT.ICON_WARNING);
  mb.setMessage("This hop flip causes a loop!  Loops are not allowed.");
  mb.setText("Warning!");
  mb.open();
  dummy=hi.from_entry;
  hi.from_entry=hi.to_entry;
  hi.to_entry=dummy;
  chef.refreshGraph();
}
 else {
  hi.setChanged();
  chef.refreshGraph();
  chef.refreshTree();
  chef.setShellText();
}
}
}
);
miDisHop.addSelectionListener(new SelectionAdapter(){
public void widgetSelected(SelectionEvent e){
selrect=null;
hi.setEnabled(!hi.isEnabled());
chef.refreshGraph();
chef.refreshTree();
}
}
);
miDelHop.addSelectionListener(new SelectionAdapter(){
public void widgetSelected(SelectionEvent e){
selrect=null;
int idx=chef.jobMeta.indexOfJobHop(hi);
chef.jobMeta.removeJobHop(idx);
chef.refreshTree();
chef.refreshGraph();
}
}
);
setMenu(mPop);
}
 else {
final NotePadMeta ni=chef.jobMeta.getNote(x,y);
if (ni != null) {
Menu mPop=new Menu((Control)this);
MenuItem miNoteEdit=new MenuItem(mPop,SWT.CASCADE);
miNoteEdit.setText("Edit note");
MenuItem miNoteDel=new MenuItem(mPop,SWT.CASCADE);
miNoteDel.setText("Delete note");
miNoteEdit.addSelectionListener(new SelectionAdapter(){
public void widgetSelected(SelectionEvent e){
  selrect=null;
  editNote(ni);
}
}
);
miNoteDel.addSelectionListener(new SelectionAdapter(){
public void widgetSelected(SelectionEvent e){
  selrect=null;
  int idx=chef.jobMeta.indexOfNote(ni);
  if (idx >= 0) {
    chef.jobMeta.removeNote(idx);
    chef.addUndoDelete(new NotePadMeta[]{ni},new int[]{idx});
  }
  redraw();
}
}
);
setMenu(mPop);
}
 else {
Menu mPop=new Menu((Control)this);
MenuItem miNoteNew=new MenuItem(mPop,SWT.CASCADE);
miNoteNew.setText("New note");
miNoteNew.addSelectionListener(new SelectionAdapter(){
public void widgetSelected(SelectionEvent e){
  selrect=null;
  String title="Notes";
  String message="Note text:";
  EnterTextDialog dd=new EnterTextDialog(shell,chef.props,title,message,"");
  String n=dd.open();
  if (n != null) {
    NotePadMeta npi=new NotePadMeta(n,lastclick.x,lastclick.y,Const.NOTE_MIN_SIZE,Const.NOTE_MIN_SIZE);
    chef.jobMeta.addNote(npi);
    chef.addUndoNew(new NotePadMeta[]{npi},new int[]{chef.jobMeta.indexOfNote(npi)});
    redraw();
  }
}
}
);
setMenu(mPop);
}
}
}
}
