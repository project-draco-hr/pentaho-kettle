{
  if (databaseMeta == null) {
    throw new KettleDatabaseException("No valid database connection defined!");
  }
  try {
    if (databaseMeta.isUsingConnectionPool() && databaseMeta.getAccessType() != DatabaseMeta.TYPE_ACCESS_JNDI) {
      try {
        this.connection=ConnectionPoolUtil.getConnection(log,databaseMeta,partitionId);
        if (getConnection().getAutoCommit() != isAutoCommit()) {
          setAutoCommit(isAutoCommit());
        }
      }
 catch (      Exception e) {
        throw new KettleDatabaseException("Error occurred while trying to connect to the database",e);
      }
    }
 else     if (databaseMeta.getAccessType() == DatabaseMeta.TYPE_ACCESS_JNDI) {
      final String jndiName=environmentSubstitute(databaseMeta.getDatabaseName());
      try {
        connectUsingJNDIDataSource(jndiName);
      }
 catch (      KettleDatabaseException kde) {
        if (log.isDetailed()) {
          log.logDetailed("Unable to find datasource using JNDI. Cause: " + kde.getLocalizedMessage());
        }
        connectUsingClass();
      }
    }
 else {
      connectUsingClass();
    }
    String sql=environmentSubstitute(databaseMeta.getConnectSQL());
    if (!Const.isEmpty(sql) && !Const.onlySpaces(sql)) {
      execStatements(sql);
      if (log.isDetailed()) {
        log.logDetailed("Executed connect time SQL statements:" + Const.CR + sql);
      }
    }
  }
 catch (  Exception e) {
    throw new KettleDatabaseException("Error occurred while trying to connect to the database",e);
  }
}
