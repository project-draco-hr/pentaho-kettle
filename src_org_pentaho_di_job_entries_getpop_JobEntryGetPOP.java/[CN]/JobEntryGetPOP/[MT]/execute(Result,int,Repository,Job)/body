{
  LogWriter log=LogWriter.getInstance();
  Result result=previousResult;
  result.setResult(false);
  FileObject fileObject=null;
  MailConnection mailConn=null;
  Date beginDate=null;
  Date endDate=null;
  SimpleDateFormat df=new SimpleDateFormat();
  df.applyPattern(DEFAULT_DATE_PATTERN);
  try {
    boolean usePOP3=getProtocol().equals(PROTOCOL_STRING_POP3);
    boolean moveafter=false;
    int nbrmailtoretrieve=usePOP3 ? getRetrievemails() == 2 ? Const.toInt(getFirstMails(),0) : 0 : Const.toInt(getFirstIMAPMails(),0);
    String realOutputFolder=getRealOutputDirectory();
    fileObject=KettleVFS.getFileObject(realOutputFolder);
    if (fileObject.exists()) {
      if (fileObject.getType() != FileType.FOLDER)       throw new KettleException(BaseMessages.getString(PKG,"JobGetMailsFromPOP.Error.NotAFolderNot",realOutputFolder));
      if (log.isDebug())       log.logDebug(toString(),BaseMessages.getString(PKG,"JobGetMailsFromPOP.Log.OutputFolderExists",realOutputFolder));
    }
 else {
      if (isCreateLocalFolder()) {
        if (log.isDetailed())         log.logDetailed(toString(),BaseMessages.getString(PKG,"JobGetMailsFromPOP.Log.OutputFolderNotExist",realOutputFolder));
        fileObject.createFolder();
      }
 else       throw new KettleException(BaseMessages.getString(PKG,"JobGetMailsFromPOP.FolderNotExists1.Label") + realOutputFolder + BaseMessages.getString(PKG,"JobGetMailsFromPOP.FolderNotExists2.Label"));
    }
    String targetAttachmentFolder=realOutputFolder;
    boolean useDifferentFolderForAttachment=(isSaveAttachment() && isDifferentFolderForAttachment());
    if (useDifferentFolderForAttachment) {
      String realFolderAttachment=environmentSubstitute(getAttachmentFolder());
      if (Const.isEmpty(realFolderAttachment))       throw new KettleException(BaseMessages.getString(PKG,"JobGetMailsFromPOP.Error.AttachmentFolderEmpty"));
      fileObject=KettleVFS.getFileObject(realFolderAttachment);
      if (!fileObject.exists())       throw new KettleException(BaseMessages.getString(PKG,"JobGetMailsFromPOP.Error.AttachmentFolderNotExist",realFolderAttachment));
      if (fileObject.getType() != FileType.FOLDER)       throw new KettleException(BaseMessages.getString(PKG,"JobGetMailsFromPOP.Error.AttachmentFolderNotAFolder",realFolderAttachment));
      targetAttachmentFolder=realFolderAttachment;
    }
    try {
      fileObject.close();
      fileObject=null;
    }
 catch (    IOException ex) {
    }
    ;
    String realMoveToIMAPFolder=environmentSubstitute(getMoveToIMAPFolder());
    if (getProtocol().equals(PROTOCOL_STRING_IMAP) && (getActionType() == ACTION_TYPE_MOVE) || (getActionType() == ACTION_TYPE_GET && getAfterGetIMAP() == AFTER_GET_IMAP_MOVE)) {
      if (Const.isEmpty(realMoveToIMAPFolder))       throw new KettleException(BaseMessages.getString(PKG,"JobGetMailsFromPOP.Error.MoveToIMAPFolderEmpty"));
      moveafter=true;
    }
switch (getConditionOnReceivedDate()) {
case JobEntryGetPOP.CONDITION_DATE_EQUAL:
case JobEntryGetPOP.CONDITION_DATE_GREATER:
case JobEntryGetPOP.CONDITION_DATE_SMALLER:
      String realBeginDate=environmentSubstitute(getReceivedDate1());
    if (Const.isEmpty(realBeginDate))     throw new KettleException(BaseMessages.getString(PKG,"JobGetMailsFromPOP.Error.ReceivedDateSearchTermEmpty"));
  beginDate=df.parse(realBeginDate);
break;
case JobEntryGetPOP.CONDITION_DATE_BETWEEN:
realBeginDate=environmentSubstitute(getReceivedDate1());
if (Const.isEmpty(realBeginDate)) throw new KettleException(BaseMessages.getString(PKG,"JobGetMailsFromPOP.Error.ReceivedDatesSearchTermEmpty"));
beginDate=df.parse(realBeginDate);
String realEndDate=environmentSubstitute(getReceivedDate2());
if (Const.isEmpty(realEndDate)) throw new KettleException(BaseMessages.getString(PKG,"JobGetMailsFromPOP.Error.ReceivedDatesSearchTermEmpty"));
endDate=df.parse(realEndDate);
break;
default :
break;
}
String realserver=getRealServername();
String realusername=getRealUsername();
String realpassword=getRealPassword();
String realFilenamePattern=getRealFilenamePattern();
int realport=Const.toInt(environmentSubstitute(sslport),-1);
String realIMAPFolder=environmentSubstitute(getIMAPFolder());
String realProxyUsername=getRealProxyUsername();
initVariables();
mailConn=new MailConnection(usePOP3 ? MailConnection.PROTOCOL_POP3 : MailConnection.PROTOCOL_IMAP,realserver,realport,realusername,realpassword,isUseSSL(),isUseProxy(),realProxyUsername,false);
mailConn.connect();
if (moveafter) {
mailConn.setDestinationFolder(realMoveToIMAPFolder,isCreateMoveToFolder());
}
String realSearchSender=environmentSubstitute(getSenderSearchTerm());
if (!Const.isEmpty(realSearchSender)) {
mailConn.setSenderTerm(realSearchSender,isNotTermSenderSearch());
}
String realSearchReceipient=environmentSubstitute(getReceipientSearch());
if (!Const.isEmpty(realSearchReceipient)) {
mailConn.setReceipientTerm(realSearchReceipient);
}
String realSearchSubject=environmentSubstitute(getSubjectSearch());
if (!Const.isEmpty(realSearchSubject)) {
mailConn.setSubjectTerm(realSearchSubject,isNotTermSubjectSearch());
}
switch (getConditionOnReceivedDate()) {
case CONDITION_DATE_EQUAL:
mailConn.setReceivedDateTermEQ(beginDate);
break;
case CONDITION_DATE_GREATER:
mailConn.setReceivedDateTermGT(beginDate);
break;
case CONDITION_DATE_SMALLER:
mailConn.setReceivedDateTermLT(beginDate);
break;
case CONDITION_DATE_BETWEEN:
mailConn.setReceivedDateTermBetween(beginDate,endDate);
break;
default :
break;
}
if (usePOP3) {
if (getRetrievemails() == 1) {
mailConn.setFlagTermNew();
}
}
 else {
switch (getValueImapList()) {
case VALUE_IMAP_LIST_NEW:
mailConn.setFlagTermNew();
break;
case VALUE_IMAP_LIST_OLD:
mailConn.setFlagTermOld();
break;
case VALUE_IMAP_LIST_READ:
mailConn.setFlagTermRead();
break;
case VALUE_IMAP_LIST_UNREAD:
mailConn.setFlagTermUnread();
break;
case VALUE_IMAP_LIST_FLAGGED:
mailConn.setFlagTermFlagged();
break;
case VALUE_IMAP_LIST_NOT_FLAGGED:
mailConn.setFlagTermNotFlagged();
break;
case VALUE_IMAP_LIST_DRAFT:
mailConn.setFlagTermDraft();
break;
case VALUE_IMAP_LIST_NOT_DRAFT:
mailConn.setFlagTermNotDraft();
break;
default :
break;
}
}
fetchOneFolder(mailConn,usePOP3,realIMAPFolder,realOutputFolder,targetAttachmentFolder,realMoveToIMAPFolder,realFilenamePattern,log,nbrmailtoretrieve,parentJob,df);
if (isIncludeSubFolders()) {
if (log.isDebug()) log.logDebug(toString(),BaseMessages.getString(PKG,"JobGetPOP.FetchingSubFolders"));
String[] subfolders=mailConn.returnAllFolders();
if (subfolders.length == 0) {
if (log.isDebug()) log.logDebug(toString(),BaseMessages.getString(PKG,"JobGetPOP.NoSubFolders"));
}
 else {
for (int i=0; i < subfolders.length; i++) {
fetchOneFolder(mailConn,usePOP3,subfolders[i],realOutputFolder,targetAttachmentFolder,realMoveToIMAPFolder,realFilenamePattern,log,nbrmailtoretrieve,parentJob,df);
}
}
}
result.setResult(true);
result.setNrFilesRetrieved(mailConn.getSavedAttachedFilesCounter());
result.setNrLinesWritten(mailConn.getSavedMessagesCounter());
result.setNrLinesDeleted(mailConn.getDeletedMessagesCounter());
result.setNrLinesUpdated(mailConn.getMovedMessagesCounter());
if (log.isDetailed()) {
log.logDetailed(toString(),"=======================================");
log.logDetailed(toString(),BaseMessages.getString(PKG,"JobGetPOP.Log.Info.SavedMessages","" + mailConn.getSavedMessagesCounter()));
log.logDetailed(toString(),BaseMessages.getString(PKG,"JobGetPOP.Log.Info.DeletedMessages","" + mailConn.getDeletedMessagesCounter()));
log.logDetailed(toString(),BaseMessages.getString(PKG,"JobGetPOP.Log.Info.MovedMessages","" + mailConn.getMovedMessagesCounter()));
if (getActionType() == JobEntryGetPOP.ACTION_TYPE_GET && isSaveAttachment()) log.logDetailed(toString(),BaseMessages.getString(PKG,"JobGetPOP.Log.Info.AttachedMessagesSuccess","" + mailConn.getSavedAttachedFilesCounter()));
log.logDetailed(toString(),"=======================================");
}
}
 catch (Exception e) {
result.setNrErrors(1);
log.logError(toString(),"Unexpected error: " + e.getMessage());
log.logError(toString(),Const.getStackTracker(e));
}
 finally {
if (fileObject != null) {
try {
fileObject.close();
fileObject=null;
}
 catch (IOException ex) {
}
;
}
try {
if (mailConn != null) {
mailConn.disconnect();
mailConn=null;
}
}
 catch (Exception e) {
}
;
}
return result;
}
