{
  Object next=null;
  if (meta.isCounterUsed()) {
synchronized (data.counter) {
      long prev=data.counter.getCounter();
      long nval=prev + meta.getIncrementBy();
      if (meta.getIncrementBy() > 0 && meta.getMaxValue() > meta.getStartAt() && nval > meta.getMaxValue())       nval=meta.getStartAt();
      if (meta.getIncrementBy() < 0 && meta.getMaxValue() < meta.getStartAt() && nval < meta.getMaxValue())       nval=meta.getStartAt();
      data.counter.setCounter(nval);
      next=prev;
    }
  }
 else   if (meta.isDatabaseUsed()) {
    try {
      next=data.getDb().getNextSequenceValue(environmentSubstitute(meta.getSchemaName()),environmentSubstitute(meta.getSequenceName()),meta.getValuename());
    }
 catch (    KettleDatabaseException dbe) {
      throw new KettleStepException(Messages.getString("AddSequence.Exception.ErrorReadingSequence",meta.getSequenceName()),dbe);
    }
  }
 else {
    throw new KettleStepException(Messages.getString("AddSequence.Exception.NoSpecifiedMethod"));
  }
  if (next != null) {
    Object[] outputRowData=inputRowData;
    if (inputRowData.length < inputRowMeta.size() + 1) {
      outputRowData=RowDataUtil.resizeArray(inputRowData,inputRowMeta.size() + 1);
    }
    outputRowData[inputRowMeta.size()]=next;
    return outputRowData;
  }
 else {
    throw new KettleStepException(Messages.getString("AddSequence.Exception.CouldNotFindNextValueForSequence") + meta.getValuename());
  }
}
