{
  if (r == null) {
    if (log.isDetailed())     logDetailed("Last line inserted: stop");
    return false;
  }
  PreparedStatement insertStatement=null;
  String tableName=null;
  Value removedValue=null;
  boolean sendToErrorRow=false;
  String errorMessage=null;
  boolean rowIsSafe=false;
  int[] updateCounts=null;
  List exceptionsList=null;
  boolean batchProblem=false;
  if (meta.isTableNameInField()) {
    if (data.indexOfTableNameField < 0) {
      data.indexOfTableNameField=r.searchValueIndex(meta.getTableNameField());
      if (data.indexOfTableNameField < 0) {
        String message="Unable to find table name field [" + meta.getTableNameField() + "] in input row";
        log.logError(toString(),message);
        throw new KettleStepException(message);
      }
    }
    tableName=r.getValue(data.indexOfTableNameField).getString();
    if (!meta.isTableNameInTable()) {
      removedValue=r.getValue(data.indexOfTableNameField);
      r.removeValue(data.indexOfTableNameField);
    }
  }
 else   if (meta.isPartitioningEnabled() && (meta.isPartitioningDaily() || meta.isPartitioningMonthly()) && (meta.getPartitioningField() != null && meta.getPartitioningField().length() > 0)) {
    if (data.indexOfPartitioningField < 0) {
      data.indexOfPartitioningField=r.searchValueIndex(meta.getPartitioningField());
      if (data.indexOfPartitioningField < 0) {
        throw new KettleStepException("Unable to find field [" + meta.getPartitioningField() + "] in the input row!");
      }
      if (meta.isPartitioningDaily()) {
        data.dateFormater=new SimpleDateFormat("yyyyMMdd");
      }
 else {
        data.dateFormater=new SimpleDateFormat("yyyyMM");
      }
    }
    Value partitioningValue=r.getValue(data.indexOfPartitioningField);
    if (!partitioningValue.isDate() || partitioningValue.isNull()) {
      throw new KettleStepException("Sorry, the partitioning field needs to contain a data value and can't be empty!");
    }
    tableName=StringUtil.environmentSubstitute(meta.getTablename()) + "_" + data.dateFormater.format(partitioningValue.getDate());
  }
 else {
    tableName=data.tableName;
  }
  if (Const.isEmpty(tableName)) {
    throw new KettleStepException("The tablename is not defined (empty)");
  }
  String schemaTable=data.db.getDatabaseMeta().getQuotedSchemaTableCombination(meta.getSchemaName(),tableName);
  insertStatement=(PreparedStatement)data.preparedStatements.get(schemaTable);
  if (insertStatement == null) {
    String sql=data.db.getInsertStatement(StringUtil.environmentSubstitute(meta.getSchemaName()),tableName,r);
    if (log.isDetailed())     logDetailed("Prepared statement : " + sql);
    insertStatement=data.db.prepareSQL(sql,meta.isReturningGeneratedKeys());
    data.preparedStatements.put(schemaTable,insertStatement);
  }
  try {
    data.db.setValues(r,insertStatement);
    rowIsSafe=data.db.insertRow(insertStatement,data.batchMode);
    if (meta.isReturningGeneratedKeys()) {
      Row extraKeys=data.db.getGeneratedKeys(insertStatement);
      Value keyVal=extraKeys.getValue(0);
      keyVal.setName(meta.getGeneratedKeyField());
      r.addValue(keyVal);
    }
  }
 catch (  KettleDatabaseBatchException be) {
    errorMessage=be.toString();
    batchProblem=true;
    sendToErrorRow=true;
    updateCounts=be.getUpdateCounts();
    exceptionsList=be.getExceptionsList();
    if (getStepMeta().isDoingErrorHandling()) {
      data.db.clearBatch(insertStatement);
      data.db.commit();
    }
 else {
      data.db.clearBatch(insertStatement);
      data.db.rollback();
      throw new KettleException("Error batch inserting rows into table [" + tableName + "]",be);
    }
  }
catch (  KettleDatabaseException dbe) {
    if (getStepMeta().isDoingErrorHandling()) {
      sendToErrorRow=true;
      errorMessage=dbe.toString();
    }
 else {
      if (meta.ignoreErrors()) {
        if (data.warnings < 20) {
          logBasic("WARNING: Couldn't insert row into table: " + r + Const.CR+ dbe.getMessage());
        }
 else         if (data.warnings == 20) {
          logBasic("FINAL WARNING (no more then 20 displayed): Couldn't insert row into table: " + r + Const.CR+ dbe.getMessage());
        }
        data.warnings++;
      }
 else {
        setErrors(getErrors() + 1);
        data.db.rollback();
        throw new KettleException("Error inserting row into table [" + tableName + "] with values: "+ r,dbe);
      }
    }
  }
  if (meta.isTableNameInField() && !meta.isTableNameInTable()) {
    r.addValue(data.indexOfTableNameField,removedValue);
  }
  if (data.batchMode) {
    if (sendToErrorRow) {
      if (batchProblem) {
        data.batchBuffer.add(r);
        r.setIgnore();
        processBatchException(errorMessage,updateCounts,exceptionsList);
      }
 else {
        putError(r,1L,errorMessage,null,"TOP001");
        r.setIgnore();
      }
    }
 else {
      data.batchBuffer.add(r);
      r.setIgnore();
      if (rowIsSafe) {
        for (int i=0; i < data.batchBuffer.size(); i++) {
          Row row=(Row)data.batchBuffer.get(i);
          putRow(row);
          linesOutput++;
        }
        data.batchBuffer.clear();
      }
    }
  }
 else {
    if (sendToErrorRow) {
      putError(r,1,errorMessage,null,"TOP001");
      r.setIgnore();
    }
  }
  return true;
}
