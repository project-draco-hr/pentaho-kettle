{
  meta=(TableOutputMeta)smi;
  data=(TableOutputData)sdi;
  try {
    Iterator preparedStatements=data.preparedStatements.values().iterator();
    while (preparedStatements.hasNext()) {
      PreparedStatement insertStatement=(PreparedStatement)preparedStatements.next();
      data.db.insertFinished(insertStatement,data.batchMode);
    }
  }
 catch (  KettleDatabaseBatchException be) {
    if (getStepMeta().isDoingErrorHandling()) {
      try {
        processBatchException(be.toString(),be.getUpdateCounts(),be.getExceptionsList());
      }
 catch (      KettleException e) {
        logError("Unexpected error processing batch error : " + e.toString());
        setErrors(1);
        stopAll();
      }
    }
 else {
      logError("Unexpected batch update error committing the database connection: " + be.toString());
      setErrors(1);
      stopAll();
    }
  }
catch (  Exception dbe) {
    logError("Unexpected error committing the database connection: " + dbe.toString());
    setErrors(1);
    stopAll();
  }
 finally {
    setOutputDone();
    if (getErrors() > 0) {
      try {
        data.db.rollback();
      }
 catch (      KettleDatabaseException e) {
        logError("Unexpected error rolling back the database connection: " + e.toString());
      }
    }
    data.db.disconnect();
    super.dispose(smi,sdi);
  }
}
