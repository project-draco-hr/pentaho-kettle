{
  if (r != null) {
    data.buffer.add(r);
  }
  if (data.files.size() == 0 && r == null) {
    quickSort(data.buffer);
  }
  if (data.buffer.size() == meta.getSortSize() || (data.files.size() > 0 && r == null && data.buffer.size() > 0)) {
    quickSort(data.buffer);
    DataOutputStream dos;
    GZIPOutputStream gzos;
    int p;
    Object[] previousRow=null;
    try {
      FileObject fileObject=KettleVFS.createTempFile(meta.getPrefix(),".tmp",environmentSubstitute(meta.getDirectory()));
      data.files.add(fileObject);
      OutputStream outputStream=fileObject.getContent().getOutputStream();
      if (meta.getCompress()) {
        gzos=new GZIPOutputStream(new BufferedOutputStream(outputStream));
        dos=new DataOutputStream(gzos);
      }
 else {
        dos=new DataOutputStream(outputStream);
        gzos=null;
      }
      if (meta.isOnlyPassingUniqueRows()) {
        int index=0;
        while (index < data.buffer.size()) {
          Object[] row=data.buffer.get(index);
          if (previousRow != null) {
            int result=data.outputRowMeta.compare(row,previousRow,data.fieldnrs);
            if (result == 0) {
              data.buffer.remove(index);
              if (log.isRowLevel())               logRowlevel("Duplicate row removed: " + data.outputRowMeta.getString(row));
            }
 else {
              index++;
            }
          }
 else {
            index++;
          }
          previousRow=row;
        }
      }
      data.bufferSizes.add(data.buffer.size());
      for (p=0; p < data.buffer.size(); p++) {
        rowMeta.writeData(dos,data.buffer.get(p));
      }
      data.buffer.clear();
      dos.close();
      if (gzos != null) {
        gzos.close();
      }
      outputStream.close();
    }
 catch (    Exception e) {
      logError("Error processing temp-file: " + e.toString());
      return false;
    }
    data.getBufferIndex=0;
  }
  return true;
}
