{
  File masterZipfile=null;
  Properties props=new Properties();
  if (Const.isEmpty(server)) {
    logError(BaseMessages.getString(PKG,"JobMail.Error.HostNotSpecified"));
    result.setNrErrors(1L);
    result.setResult(false);
    return result;
  }
  String protocol="smtp";
  if (usingSecureAuthentication) {
    if (secureConnectionType.equals("TLS")) {
      props.put("mail.smtp.starttls.enable","true");
    }
 else {
      protocol="smtps";
      props.put("mail.smtps.quitwait","false");
    }
  }
  props.put("mail." + protocol + ".host",environmentSubstitute(server));
  if (!Const.isEmpty(port))   props.put("mail." + protocol + ".port",environmentSubstitute(port));
  if (LogWriter.getInstance().isDebug())   props.put("mail.debug","true");
  if (usingAuthentication) {
    props.put("mail." + protocol + ".auth","true");
  }
  Session session=Session.getInstance(props);
  session.setDebug(LogWriter.getInstance().isDebug());
  try {
    Message msg=new MimeMessage(session);
    if (usePriority) {
      String priority_int="1";
      if (priority.equals("low")) {
        priority_int="3";
      }
      if (priority.equals("normal")) {
        priority_int="2";
      }
      msg.setHeader("X-Priority",priority_int);
      msg.setHeader("Importance",importance);
    }
    String sender_address=environmentSubstitute(replyAddress);
    if (!Const.isEmpty(sender_address)) {
      String sender_name=environmentSubstitute(replyName);
      if (!Const.isEmpty(sender_name))       sender_address=sender_name + '<' + sender_address+ '>';
      msg.setFrom(new InternetAddress(sender_address));
    }
 else {
      throw new MessagingException(BaseMessages.getString(PKG,"JobMail.Error.ReplyEmailNotFilled"));
    }
    String reply_to_address=environmentSubstitute(replyToAddresses);
    if (!Const.isEmpty(reply_to_address)) {
      String[] reply_Address_List=environmentSubstitute(reply_to_address).split(" ");
      InternetAddress[] address=new InternetAddress[reply_Address_List.length];
      for (int i=0; i < reply_Address_List.length; i++)       address[i]=new InternetAddress(reply_Address_List[i]);
      msg.setReplyTo(address);
    }
    String destinations[]=environmentSubstitute(destination).split(" ");
    InternetAddress[] address=new InternetAddress[destinations.length];
    for (int i=0; i < destinations.length; i++)     address[i]=new InternetAddress(destinations[i]);
    msg.setRecipients(Message.RecipientType.TO,address);
    if (!Const.isEmpty(destinationCc)) {
      String destinationsCc[]=environmentSubstitute(destinationCc).split(" ");
      InternetAddress[] addressCc=new InternetAddress[destinationsCc.length];
      for (int i=0; i < destinationsCc.length; i++)       addressCc[i]=new InternetAddress(destinationsCc[i]);
      msg.setRecipients(Message.RecipientType.CC,addressCc);
    }
    if (!Const.isEmpty(destinationBCc)) {
      String destinationsBCc[]=environmentSubstitute(destinationBCc).split(" ");
      InternetAddress[] addressBCc=new InternetAddress[destinationsBCc.length];
      for (int i=0; i < destinationsBCc.length; i++)       addressBCc[i]=new InternetAddress(destinationsBCc[i]);
      msg.setRecipients(Message.RecipientType.BCC,addressBCc);
    }
    String realSubject=environmentSubstitute(subject);
    if (!Const.isEmpty(realSubject)) {
      msg.setSubject(realSubject);
    }
    msg.setSentDate(new Date());
    StringBuffer messageText=new StringBuffer();
    if (comment != null) {
      messageText.append(environmentSubstitute(comment)).append(Const.CR).append(Const.CR);
    }
    if (!onlySendComment) {
      messageText.append(BaseMessages.getString(PKG,"JobMail.Log.Comment.Job")).append(Const.CR);
      messageText.append("-----").append(Const.CR);
      messageText.append(BaseMessages.getString(PKG,"JobMail.Log.Comment.JobName") + "    : ").append(parentJob.getJobMeta().getName()).append(Const.CR);
      messageText.append(BaseMessages.getString(PKG,"JobMail.Log.Comment.JobDirectory") + "  : ").append(parentJob.getJobMeta().getRepositoryDirectory()).append(Const.CR);
      messageText.append(BaseMessages.getString(PKG,"JobMail.Log.Comment.JobEntry") + "   : ").append(getName()).append(Const.CR);
      messageText.append(Const.CR);
    }
    if (includeDate) {
      messageText.append(Const.CR).append(BaseMessages.getString(PKG,"JobMail.Log.Comment.MsgDate") + ": ").append(XMLHandler.date2string(new Date())).append(Const.CR).append(Const.CR);
    }
    if (!onlySendComment && result != null) {
      messageText.append(BaseMessages.getString(PKG,"JobMail.Log.Comment.PreviousResult") + ":").append(Const.CR);
      messageText.append("-----------------").append(Const.CR);
      messageText.append(BaseMessages.getString(PKG,"JobMail.Log.Comment.JobEntryNr") + "         : ").append(result.getEntryNr()).append(Const.CR);
      messageText.append(BaseMessages.getString(PKG,"JobMail.Log.Comment.Errors") + "               : ").append(result.getNrErrors()).append(Const.CR);
      messageText.append(BaseMessages.getString(PKG,"JobMail.Log.Comment.LinesRead") + "           : ").append(result.getNrLinesRead()).append(Const.CR);
      messageText.append(BaseMessages.getString(PKG,"JobMail.Log.Comment.LinesWritten") + "        : ").append(result.getNrLinesWritten()).append(Const.CR);
      messageText.append(BaseMessages.getString(PKG,"JobMail.Log.Comment.LinesInput") + "          : ").append(result.getNrLinesInput()).append(Const.CR);
      messageText.append(BaseMessages.getString(PKG,"JobMail.Log.Comment.LinesOutput") + "         : ").append(result.getNrLinesOutput()).append(Const.CR);
      messageText.append(BaseMessages.getString(PKG,"JobMail.Log.Comment.LinesUpdated") + "        : ").append(result.getNrLinesUpdated()).append(Const.CR);
      messageText.append(BaseMessages.getString(PKG,"JobMail.Log.Comment.LinesRejected") + "       : ").append(result.getNrLinesRejected()).append(Const.CR);
      messageText.append(BaseMessages.getString(PKG,"JobMail.Log.Comment.Status") + "  : ").append(result.getExitStatus()).append(Const.CR);
      messageText.append(BaseMessages.getString(PKG,"JobMail.Log.Comment.Result") + "               : ").append(result.getResult()).append(Const.CR);
      messageText.append(Const.CR);
    }
    if (!onlySendComment && (!Const.isEmpty(environmentSubstitute(contactPerson)) || !Const.isEmpty(environmentSubstitute(contactPhone)))) {
      messageText.append(BaseMessages.getString(PKG,"JobMail.Log.Comment.ContactInfo") + " :").append(Const.CR);
      messageText.append("---------------------").append(Const.CR);
      messageText.append(BaseMessages.getString(PKG,"JobMail.Log.Comment.PersonToContact") + " : ").append(environmentSubstitute(contactPerson)).append(Const.CR);
      messageText.append(BaseMessages.getString(PKG,"JobMail.Log.Comment.Tel") + "  : ").append(environmentSubstitute(contactPhone)).append(Const.CR);
      messageText.append(Const.CR);
    }
    if (!onlySendComment) {
      JobTracker jobTracker=parentJob.getJobTracker();
      if (jobTracker != null) {
        messageText.append(BaseMessages.getString(PKG,"JobMail.Log.Comment.PathToJobentry") + ":").append(Const.CR);
        messageText.append("------------------------").append(Const.CR);
        addBacktracking(jobTracker,messageText);
      }
    }
    MimeMultipart parts=new MimeMultipart();
    MimeBodyPart part1=new MimeBodyPart();
    int nrattachedFiles=0;
    if (useHTML) {
      if (!Const.isEmpty(getEncoding())) {
        part1.setContent(messageText.toString(),"text/html; " + "charset=" + getEncoding());
      }
 else {
        part1.setContent(messageText.toString(),"text/html; " + "charset=ISO-8859-1");
      }
    }
 else     part1.setText(messageText.toString());
    parts.addBodyPart(part1);
    if (includingFiles && result != null) {
      List<ResultFile> resultFiles=result.getResultFilesList();
      if (resultFiles != null && !resultFiles.isEmpty()) {
        if (!zipFiles) {
          for (          ResultFile resultFile : resultFiles) {
            FileObject file=resultFile.getFile();
            if (file != null && file.exists()) {
              boolean found=false;
              for (int i=0; i < fileType.length; i++) {
                if (fileType[i] == resultFile.getType())                 found=true;
              }
              if (found) {
                MimeBodyPart files=new MimeBodyPart();
                URLDataSource fds=new URLDataSource(file.getURL());
                files.setDataHandler(new DataHandler(fds));
                files.setFileName(file.getName().getBaseName());
                parts.addBodyPart(files);
                nrattachedFiles++;
                logBasic("Added file '" + fds.getName() + "' to the mail message.");
              }
            }
          }
        }
 else {
          masterZipfile=new File(System.getProperty("java.io.tmpdir") + Const.FILE_SEPARATOR + environmentSubstitute(zipFilename));
          ZipOutputStream zipOutputStream=null;
          try {
            zipOutputStream=new ZipOutputStream(new FileOutputStream(masterZipfile));
            for (            ResultFile resultFile : resultFiles) {
              boolean found=false;
              for (int i=0; i < fileType.length; i++) {
                if (fileType[i] == resultFile.getType())                 found=true;
              }
              if (found) {
                FileObject file=resultFile.getFile();
                ZipEntry zipEntry=new ZipEntry(file.getName().getBaseName());
                zipOutputStream.putNextEntry(zipEntry);
                BufferedInputStream inputStream=new BufferedInputStream(KettleVFS.getInputStream(file));
                try {
                  int c;
                  while ((c=inputStream.read()) >= 0) {
                    zipOutputStream.write(c);
                  }
                }
  finally {
                  inputStream.close();
                }
                zipOutputStream.closeEntry();
                nrattachedFiles++;
                logBasic("Added file '" + file.getName().getURI() + "' to the mail message in a zip archive.");
              }
            }
          }
 catch (          Exception e) {
            logError("Error zipping attachement files into file [" + masterZipfile.getPath() + "] : "+ e.toString());
            logError(Const.getStackTracker(e));
            result.setNrErrors(1);
          }
 finally {
            if (zipOutputStream != null) {
              try {
                zipOutputStream.finish();
                zipOutputStream.close();
              }
 catch (              IOException e) {
                logError("Unable to close attachement zip file archive : " + e.toString());
                logError(Const.getStackTracker(e));
                result.setNrErrors(1);
              }
            }
          }
          if (result.getNrErrors() == 0) {
            MimeBodyPart files=new MimeBodyPart();
            FileDataSource fds=new FileDataSource(masterZipfile);
            files.setDataHandler(new DataHandler(fds));
            files.setFileName(fds.getName());
            parts.addBodyPart(files);
          }
        }
      }
    }
    int nrEmbeddedImages=0;
    if (embeddedimages != null && embeddedimages.length > 0) {
      FileObject imageFile=null;
      for (int i=0; i < embeddedimages.length; i++) {
        String realImageFile=environmentSubstitute(embeddedimages[i]);
        String realcontenID=environmentSubstitute(contentids[i]);
        if (messageText.indexOf("cid:" + realcontenID) < 0) {
          if (log.isDebug())           log.logDebug("Image [" + realImageFile + "] is not used in message body!");
        }
 else {
          try {
            boolean found=false;
            imageFile=KettleVFS.getFileObject(realImageFile,this);
            if (imageFile.exists() && imageFile.getType() == FileType.FILE)             found=true;
 else             log.logError("We can not find [" + realImageFile + "] or it is not a file");
            if (found) {
              MimeBodyPart messageBodyPart=new MimeBodyPart();
              URLDataSource fds=new URLDataSource(imageFile.getURL());
              messageBodyPart.setDataHandler(new DataHandler(fds));
              messageBodyPart.setHeader("Content-ID","<" + realcontenID + ">");
              parts.addBodyPart(messageBodyPart);
              nrEmbeddedImages++;
              log.logBasic("Image '" + fds.getName() + "' was embedded in message.");
            }
          }
 catch (          Exception e) {
            log.logError("Error embedding image [" + realImageFile + "] in message : "+ e.toString());
            log.logError(Const.getStackTracker(e));
            result.setNrErrors(1);
          }
 finally {
            if (imageFile != null) {
              try {
                imageFile.close();
              }
 catch (              Exception e) {
              }
              ;
            }
          }
        }
      }
    }
    if (nrEmbeddedImages > 0 && nrattachedFiles == 0) {
      parts.setSubType("related");
    }
    msg.setContent(parts);
    Transport transport=null;
    try {
      transport=session.getTransport(protocol);
      if (usingAuthentication) {
        if (!Const.isEmpty(port)) {
          transport.connect(environmentSubstitute(Const.NVL(server,"")),Integer.parseInt(environmentSubstitute(Const.NVL(port,""))),environmentSubstitute(Const.NVL(authenticationUser,"")),environmentSubstitute(Const.NVL(authenticationPassword,"")));
        }
 else {
          transport.connect(environmentSubstitute(Const.NVL(server,"")),environmentSubstitute(Const.NVL(authenticationUser,"")),environmentSubstitute(Const.NVL(authenticationPassword,"")));
        }
      }
 else {
        transport.connect();
      }
      transport.sendMessage(msg,msg.getAllRecipients());
    }
  finally {
      if (transport != null)       transport.close();
    }
  }
 catch (  IOException e) {
    logError("Problem while sending message: " + e.toString());
    result.setNrErrors(1);
  }
catch (  MessagingException mex) {
    logError("Problem while sending message: " + mex.toString());
    result.setNrErrors(1);
    Exception ex=mex;
    do {
      if (ex instanceof SendFailedException) {
        SendFailedException sfex=(SendFailedException)ex;
        Address[] invalid=sfex.getInvalidAddresses();
        if (invalid != null) {
          logError("    ** Invalid Addresses");
          for (int i=0; i < invalid.length; i++) {
            logError("         " + invalid[i]);
            result.setNrErrors(1);
          }
        }
        Address[] validUnsent=sfex.getValidUnsentAddresses();
        if (validUnsent != null) {
          logError("    ** ValidUnsent Addresses");
          for (int i=0; i < validUnsent.length; i++) {
            logError("         " + validUnsent[i]);
            result.setNrErrors(1);
          }
        }
        Address[] validSent=sfex.getValidSentAddresses();
        if (validSent != null) {
          for (int i=0; i < validSent.length; i++) {
            logError("         " + validSent[i]);
            result.setNrErrors(1);
          }
        }
      }
      if (ex instanceof MessagingException) {
        ex=((MessagingException)ex).getNextException();
      }
 else {
        ex=null;
      }
    }
 while (ex != null);
  }
 finally {
    if (masterZipfile != null && masterZipfile.exists()) {
      masterZipfile.delete();
    }
  }
  if (result.getNrErrors() > 0) {
    result.setResult(false);
  }
 else {
    result.setResult(true);
  }
  return result;
}
