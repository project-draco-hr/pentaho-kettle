{
  init();
  ClusterGenerator clusterGenerator=new ClusterGenerator();
  try {
    clusterGenerator.launchSlaveServers();
    ClusterSchema clusterSchema=clusterGenerator.getClusterSchema();
    SlaveServer master=clusterSchema.findMaster();
    List<SlaveServer> slaves=clusterSchema.getSlaveServersFromMasterOrLocal();
    SlaveServer slave1=slaves.get(0);
    SlaveServer slave2=slaves.get(1);
    SlaveServer slave3=slaves.get(2);
    int port1=master.allocateServerSocket(40000,"localhost","trans1",master.getName(),"A","0",slave1.getName(),"B","0");
    assertEquals(40000,port1);
    int port1b=master.allocateServerSocket(40000,"localhost","trans1",master.getName(),"A","0",slave1.getName(),"B","0");
    assertEquals(port1,port1b);
    int port2=master.allocateServerSocket(40000,"localhost","trans1",master.getName(),"A","0",slave2.getName(),"B","0");
    assertEquals(40001,port2);
    int port3=master.allocateServerSocket(40000,"localhost","trans1",master.getName(),"A","0",slave3.getName(),"B","0");
    assertEquals(40002,port3);
    master.deAllocateServerSockets("trans1",null);
    port1=master.allocateServerSocket(40000,"localhost","trans2",master.getName(),"A","0",slave1.getName(),"B","0");
    assertEquals(40000,port1);
  }
  finally {
    clusterGenerator.stopSlaveServers();
  }
}
