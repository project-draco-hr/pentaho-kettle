{
  meta=(SetVariableMeta)smi;
  data=(SetVariableData)sdi;
  Object[] rowData=getRow();
  if (rowData == null) {
    logBasic("Finished after " + linesWritten + " rows.");
    setOutputDone();
    return false;
  }
  if (first) {
    first=false;
    data.outputMeta=(RowMetaInterface)getInputRowMeta().clone();
    logBasic("Setting environment variables...");
    for (int i=0; i < meta.getFieldName().length; i++) {
      String value=data.outputMeta.getString(rowData,meta.getFieldName()[i],"");
      String varname=meta.getVariableName()[i];
      if (Const.isEmpty(varname)) {
        if (Const.isEmpty(value)) {
          throw new KettleException("Variable name nor value was specified on line #" + (i + 1));
        }
 else {
          throw new KettleException("There was no variable name specified for value [" + value + "]");
        }
      }
switch (meta.getVariableType()[i]) {
case SetVariableMeta.VARIABLE_TYPE_JVM:
        System.setProperty(varname,value);
      break;
case SetVariableMeta.VARIABLE_TYPE_ROOT_JOB:
{
      KettleVariables.getInstance().setVariable(varname,value);
      Job parentJob1=getTrans().getParentJob();
      Job rootJob1=parentJob1;
      while (parentJob1 != null) {
        KettleVariables vars=LocalVariables.getKettleVariables(parentJob1.getName());
        vars.setVariable(varname,value);
        rootJob1=parentJob1;
        parentJob1=parentJob1.getParentJob();
      }
      if (rootJob1 == null) {
        throw new KettleStepException("Can't set variable [" + varname + "] on root job: the root job is not available (meaning: not even the parent job)");
      }
      setVariable(varname,value);
      VariableSpace rootJob=null;
      VariableSpace parentJob=getParentVariableSpace();
      while (parentJob != null) {
        parentJob.setVariable(varname,value);
        rootJob=parentJob;
        parentJob=parentJob.getParentVariableSpace();
      }
      if (rootJob == null) {
        throw new KettleStepException("Can't set variable [" + varname + "] on root job: the root job is not available (meaning: not even the parent job)");
      }
    }
  break;
case SetVariableMeta.VARIABLE_TYPE_GRAND_PARENT_JOB:
{
  KettleVariables.getInstance().setVariable(varname,value);
  Job parentJob1=getTrans().getParentJob();
  if (parentJob1 != null) {
    parentJob1.getKettleVariables().setVariable(varname,value);
    Job gpJob=parentJob1.getParentJob();
    if (gpJob != null) {
      gpJob.getKettleVariables().setVariable(varname,value);
    }
 else {
      throw new KettleStepException("Can't set variable [" + varname + "] on grand parent job: the grand parent job is not available");
    }
  }
 else {
    throw new KettleStepException("Can't set variable [" + varname + "] on grand parent job: the parent job is not available");
  }
  setVariable(varname,value);
  VariableSpace parentJob=getParentVariableSpace();
  if (parentJob != null) {
    parentJob.setVariable(varname,value);
    VariableSpace gpJob=parentJob.getParentVariableSpace();
    if (gpJob != null) {
      gpJob.setVariable(varname,value);
    }
 else {
      throw new KettleStepException("Can't set variable [" + varname + "] on grand parent job: the grand parent job is not available");
    }
  }
 else {
    throw new KettleStepException("Can't set variable [" + varname + "] on grand parent job: the parent job is not available");
  }
}
case SetVariableMeta.VARIABLE_TYPE_PARENT_JOB:
{
KettleVariables.getInstance().setVariable(varname,value);
setVariable(varname,value);
VariableSpace parentJob=getParentVariableSpace();
parentJob.setVariable(varname,value);
}
}
logBasic("Set variable " + meta.getVariableName()[i] + " to value ["+ value+ "]");
}
putRow(data.outputMeta,rowData);
return true;
}
throw new KettleStepException(Messages.getString("SetVariable.RuntimeError.MoreThanOneRowReceived.SETVARIABLE0007"));
}
