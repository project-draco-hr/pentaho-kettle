{
  KettleEnvironment.init();
  String sqlQuery="SELECT Country, COUNT(Category) as \"Number of categories\", MIN( sales_amount) min_sales, MAX( products_sold) max_count FROM Service GROUP BY Country ORDER BY COUNT(Category) ASC";
  SqlTransExecutor executor=new SqlTransExecutor(sqlQuery,getServicesMap());
  final List<RowMetaAndData> rows=new ArrayList<RowMetaAndData>();
  executor.executeQuery(new RowAdapter(){
    @Override public void rowWrittenEvent(    RowMetaInterface rowMeta,    Object[] row) throws KettleStepException {
      rows.add(new RowMetaAndData(rowMeta,row));
    }
  }
);
  File file=new File("/tmp/gen.ktr");
  FileOutputStream fos=new FileOutputStream(file);
  fos.write(org.pentaho.di.core.xml.XMLHandler.getXMLHeader().getBytes("UTF-8"));
  fos.write(executor.getGenTransMeta().getXML().getBytes("UTF-8"));
  fos.close();
  executor.waitUntilFinished();
  assertEquals(4,rows.size());
  int rowNr=0;
  assertEquals("France",rows.get(rowNr).getString("Country",null));
  assertEquals(2,rows.get(rowNr).getInteger("Number of categories",-1));
  assertEquals(724,Math.round(rows.get(rowNr).getNumber("min_sales",-1.0)));
  assertEquals(12,Math.round(rows.get(rowNr).getNumber("max_count",-1.0)));
  rowNr++;
  assertEquals("Belgium",rows.get(rowNr).getString("Country",null));
  assertEquals(2,rows.get(rowNr).getInteger("Number of categories",-1));
  assertEquals(257,Math.round(rows.get(rowNr).getNumber("min_sales",-1.0)));
  assertEquals(5,Math.round(rows.get(rowNr).getNumber("max_count",-1.0)));
  rowNr++;
  assertEquals("Germany",rows.get(rowNr).getString("Country",null));
  assertEquals(2,rows.get(rowNr).getInteger("Number of categories",-1));
  assertEquals(2864,Math.round(rows.get(rowNr).getNumber("min_sales",-1.0)));
  assertEquals(38,Math.round(rows.get(rowNr).getNumber("max_count",-1.0)));
  rowNr++;
  assertEquals("Great Britain",rows.get(rowNr).getString("Country",null));
  assertEquals(2,rows.get(rowNr).getInteger("Number of categories",-1));
  assertEquals(4298,Math.round(rows.get(rowNr).getNumber("min_sales",-1.0)));
  assertEquals(9,Math.round(rows.get(rowNr).getNumber("max_count",-1.0)));
}
