{
  Row r=new Row(baserow);
  boolean errorHandled=false;
  for (int i=startcolumn; i < excelInputRow.cells.length && i - startcolumn < r.size(); i++) {
    Cell cell=excelInputRow.cells[i];
    int rowcolumn=i - startcolumn;
    Value v=r.getValue(rowcolumn);
    try {
      checkType(cell,v);
    }
 catch (    KettleException ex) {
      if (!meta.isErrorIgnored())       throw ex;
      logBasic("Warning processing [" + v + "] from Excel file ["+ data.filename+ "] : "+ ex.getMessage());
      if (!errorHandled) {
        data.errorHandler.handleLineError(excelInputRow.rownr,excelInputRow.sheetName);
        errorHandled=true;
      }
      if (meta.isErrorLineSkipped()) {
        r.setIgnore();
        return r;
      }
    }
    CellType cellType=cell.getType();
    if (CellType.BOOLEAN.equals(cellType) || CellType.BOOLEAN_FORMULA.equals(cellType)) {
      v.setValue(((BooleanCell)cell).getValue());
    }
 else {
      if (CellType.DATE.equals(cellType) || CellType.DATE_FORMULA.equals(cellType)) {
        Date date=((DateCell)cell).getDate();
        long time=date.getTime();
        int offset=TimeZone.getDefault().getOffset(time);
        v.setValue(new Date(time - offset));
      }
 else {
        if (CellType.LABEL.equals(cellType) || CellType.STRING_FORMULA.equals(cellType)) {
          v.setValue(((LabelCell)cell).getString());
switch (meta.getField()[rowcolumn].getTrimType()) {
case ExcelInputMeta.TYPE_TRIM_LEFT:
            v.ltrim();
          break;
case ExcelInputMeta.TYPE_TRIM_RIGHT:
        v.rtrim();
      break;
case ExcelInputMeta.TYPE_TRIM_BOTH:
    v.trim();
  break;
default :
break;
}
}
 else {
if (CellType.NUMBER.equals(cellType) || CellType.NUMBER_FORMULA.equals(cellType)) {
v.setValue(((NumberCell)cell).getValue());
}
 else {
if (log.isDetailed()) logDetailed("Unknown type : " + cell.getType().toString() + " : ["+ cell.getContents()+ "]");
v.setNull();
}
}
}
}
ExcelInputField field=meta.getField()[rowcolumn];
try {
if (v.getType() != field.getType()) {
switch (v.getType()) {
case Value.VALUE_TYPE_STRING:
switch (field.getType()) {
case Value.VALUE_TYPE_DATE:
v.str2dat(field.getFormat());
break;
case Value.VALUE_TYPE_NUMBER:
v.str2num(field.getFormat(),field.getDecimalSymbol(),field.getGroupSymbol(),field.getCurrencySymbol());
break;
default :
v.setType(field.getType());
break;
}
break;
case Value.VALUE_TYPE_NUMBER:
case Value.VALUE_TYPE_INTEGER:
switch (field.getType()) {
case Value.VALUE_TYPE_STRING:
v.num2str(field.getFormat(),field.getDecimalSymbol(),field.getGroupSymbol(),field.getCurrencySymbol());
break;
case Value.VALUE_TYPE_DATE:
v.num2str("#").str2dat(field.getFormat());
break;
default :
v.setType(field.getType());
break;
}
break;
case Value.VALUE_TYPE_DATE:
switch (field.getType()) {
case Value.VALUE_TYPE_STRING:
v.dat2str(field.getFormat());
break;
default :
v.setType(field.getType());
break;
}
break;
default :
v.setType(field.getType());
}
}
}
 catch (KettleException ex) {
if (!meta.isErrorIgnored()) throw ex;
logBasic("Warning processing [" + v + "] from Excel file ["+ data.filename+ "] : "+ ex.toString());
if (!errorHandled) {
data.errorHandler.handleLineError(excelInputRow.rownr,excelInputRow.sheetName);
errorHandled=true;
}
if (meta.isErrorLineSkipped()) {
r.setIgnore();
return r;
}
 else {
v.setNull();
}
}
v.setLength(meta.getField()[rowcolumn].getLength(),meta.getField()[rowcolumn].getPrecision());
}
if (meta.getFileField() != null && meta.getFileField().length() > 0) {
Value value=new Value(meta.getFileField(),data.filename);
value.setLength(data.maxfilelength);
r.addValue(value);
}
if (meta.getSheetField() != null && meta.getSheetField().length() > 0) {
Value value=new Value(meta.getSheetField(),excelInputRow.sheetName);
value.setLength(data.maxsheetlength);
r.addValue(value);
}
if (meta.getSheetRowNumberField() != null && meta.getSheetRowNumberField().length() > 0) {
Value value=new Value(meta.getSheetRowNumberField(),Value.VALUE_TYPE_INTEGER);
value.setValue(data.rownr);
r.addValue(value);
}
if (meta.getRowNumberField() != null && meta.getRowNumberField().length() > 0) {
Value value=new Value(meta.getRowNumberField(),Value.VALUE_TYPE_INTEGER);
value.setValue(linesWritten + 1);
r.addValue(value);
}
return r;
}
