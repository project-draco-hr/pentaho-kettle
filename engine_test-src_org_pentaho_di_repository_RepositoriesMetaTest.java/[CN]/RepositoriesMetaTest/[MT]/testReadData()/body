{
  RepositoriesMeta meta=new RepositoriesMeta();
  RepositoriesMeta spy=Mockito.spy(meta);
  LogChannel log=mock(LogChannel.class);
  when(spy.getKettleUserRepositoriesFile()).thenReturn(getClass().getResource("repositories.xml").getPath());
  when(spy.newLogChannel()).thenReturn(log);
  spy.readData();
  String repositoriesXml="<?xml version=\"1.0\" encoding=\"UTF-8\"?>" + Const.CR + "<repositories>"+ Const.CR+ "  <connection>"+ Const.CR+ "    <name>local postgres</name>"+ Const.CR+ "    <server>localhost</server>"+ Const.CR+ "    <type>POSTGRESQL</type>"+ Const.CR+ "    <access>Native</access>"+ Const.CR+ "    <database>hibernate</database>"+ Const.CR+ "    <port>5432</port>"+ Const.CR+ "    <username>auser</username>"+ Const.CR+ "    <password>Encrypted 2be98afc86aa7f285bb18bd63c99dbdde</password>"+ Const.CR+ "    <servername/>"+ Const.CR+ "    <data_tablespace/>"+ Const.CR+ "    <index_tablespace/>"+ Const.CR+ "    <attributes>"+ Const.CR+ "      <attribute><code>FORCE_IDENTIFIERS_TO_LOWERCASE</code><attribute>N</attribute></attribute>"+ Const.CR+ "      <attribute><code>FORCE_IDENTIFIERS_TO_UPPERCASE</code><attribute>N</attribute></attribute>"+ Const.CR+ "      <attribute><code>IS_CLUSTERED</code><attribute>N</attribute></attribute>"+ Const.CR+ "      <attribute><code>PORT_NUMBER</code><attribute>5432</attribute></attribute>"+ Const.CR+ "      <attribute><code>PRESERVE_RESERVED_WORD_CASE</code><attribute>N</attribute></attribute>"+ Const.CR+ "      <attribute><code>QUOTE_ALL_FIELDS</code><attribute>N</attribute></attribute>"+ Const.CR+ "      <attribute><code>SUPPORTS_BOOLEAN_DATA_TYPE</code><attribute>Y</attribute></attribute>"+ Const.CR+ "      <attribute><code>SUPPORTS_TIMESTAMP_DATA_TYPE</code><attribute>Y</attribute></attribute>"+ Const.CR+ "      <attribute><code>USE_POOLING</code><attribute>N</attribute></attribute>"+ Const.CR+ "    </attributes>"+ Const.CR+ "  </connection>"+ Const.CR+ "  <repository>    <id>KettleFileRepository</id>"+ Const.CR+ "    <name>Test Repository</name>"+ Const.CR+ "    <description>Test Repository Description</description>"+ Const.CR+ "    <is_default>false</is_default>"+ Const.CR+ "    <base_directory>test-repository</base_directory>"+ Const.CR+ "    <read_only>N</read_only>"+ Const.CR+ "    <hides_hidden_files>N</hides_hidden_files>"+ Const.CR+ "  </repository>  </repositories>"+ Const.CR;
  assertEquals(repositoriesXml,spy.getXML());
  RepositoriesMeta clone=spy.clone();
  assertEquals(repositoriesXml,spy.getXML());
  assertNotSame(clone,spy);
  assertEquals(1,spy.nrRepositories());
  RepositoryMeta repository=spy.getRepository(0);
  assertEquals("Test Repository",repository.getName());
  assertEquals("Test Repository Description",repository.getDescription());
  assertEquals("  <repository>    <id>KettleFileRepository</id>" + Const.CR + "    <name>Test Repository</name>"+ Const.CR+ "    <description>Test Repository Description</description>"+ Const.CR+ "    <is_default>false</is_default>"+ Const.CR+ "    <base_directory>test-repository</base_directory>"+ Const.CR+ "    <read_only>N</read_only>"+ Const.CR+ "    <hides_hidden_files>N</hides_hidden_files>"+ Const.CR+ "  </repository>",repository.getXML());
  assertSame(repository,spy.searchRepository("Test Repository"));
  assertSame(repository,spy.findRepositoryById("KettleFileRepository"));
  assertSame(repository,spy.findRepository("Test Repository"));
  assertNull(spy.findRepository("not found"));
  assertNull(spy.findRepositoryById("not found"));
  assertEquals(0,spy.indexOfRepository(repository));
  spy.removeRepository(0);
  assertEquals(0,spy.nrRepositories());
  assertNull(spy.searchRepository("Test Repository"));
  spy.addRepository(0,repository);
  assertEquals(1,spy.nrRepositories());
  spy.removeRepository(1);
  assertEquals(1,spy.nrRepositories());
  assertEquals(1,spy.nrDatabases());
  assertEquals("local postgres",spy.getDatabase(0).getName());
  DatabaseMeta searchDatabase=spy.searchDatabase("local postgres");
  assertSame(searchDatabase,spy.getDatabase(0));
  assertEquals(0,spy.indexOfDatabase(searchDatabase));
  spy.removeDatabase(0);
  assertEquals(0,spy.nrDatabases());
  assertNull(spy.searchDatabase("local postgres"));
  spy.addDatabase(0,searchDatabase);
  assertEquals(1,spy.nrDatabases());
  spy.removeDatabase(1);
  assertEquals(1,spy.nrDatabases());
  assertEquals("Unable to read repository with id [junk]. RepositoryMeta is not available.",spy.getErrorMessage());
}
