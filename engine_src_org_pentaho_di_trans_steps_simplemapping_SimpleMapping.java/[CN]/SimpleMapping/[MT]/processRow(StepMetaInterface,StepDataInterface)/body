{
  try {
    meta=(SimpleMappingMeta)smi;
    setData((SimpleMappingData)sdi);
    if (first) {
      first=false;
      getData().wasStarted=true;
      String mappingInputStepname=getData().mappingInput.getStepname();
      RowProducer rowProducer=getData().mappingTrans.addRowProducer(mappingInputStepname,0);
      getData().rowDataInputMapper=new RowDataInputMapper(meta.getInputMapping(),rowProducer);
      String mappingOutputStepname=getData().mappingOutput.getStepname();
      StepInterface outputStepInterface=getData().mappingTrans.findStepInterface(mappingOutputStepname,0);
      RowOutputDataMapper outputDataMapper=new RowOutputDataMapper(meta.getInputMapping(),meta.getOutputMapping(),new PutRowInterface(){
        @Override public void putRow(        RowMetaInterface rowMeta,        Object[] rowData) throws KettleStepException {
          SimpleMapping.this.putRow(rowMeta,rowData);
        }
      }
);
      outputStepInterface.addRowListener(outputDataMapper);
      getData().mappingTrans.startThreads();
    }
    Object[] row=getRow();
    boolean rowWasPut=false;
    if (row != null) {
      while (!(data.mappingTrans.isFinishedOrStopped() || rowWasPut)) {
        rowWasPut=data.rowDataInputMapper.putRow(getInputRowMeta(),row);
      }
    }
    if (!rowWasPut) {
      getData().rowDataInputMapper.finished();
      getData().mappingTrans.waitUntilFinished();
      setOutputDone();
      return false;
    }
    return true;
  }
 catch (  Throwable t) {
    if (getData().mappingTrans != null) {
      getData().mappingTrans.stopAll();
    }
    throw new KettleException(t);
  }
}
