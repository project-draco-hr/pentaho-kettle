{
  LogWriter log=LogWriter.getInstance();
  Result result=new Result(nr);
  result.setResult(false);
  boolean Fileexists=false;
  String realZipfilename=StringUtil.environmentSubstitute(ZipFilename);
  String realWildcard=StringUtil.environmentSubstitute(wildcard);
  String realWildcardExclude=StringUtil.environmentSubstitute(wildcardexclude);
  String realTargetdirectory=StringUtil.environmentSubstitute(targetdirectory);
  String realMovetodirectory=StringUtil.environmentSubstitute(movetodirectory);
  if (ZipFilename != null) {
    FileObject fileObject=null;
    try {
      fileObject=KettleVFS.getFileObject(realZipfilename);
      if (fileObject.exists()) {
        Fileexists=true;
        log.logDebug(toString(),Messages.getString("JobZipFiles.Zip_FileExists1.Label") + ZipFilename + Messages.getString("JobZipFiles.Zip_FileExists2.Label"));
      }
 else {
        Fileexists=false;
      }
      if (ifzipfileexists == 3 && Fileexists) {
        result.setResult(false);
        result.setNrErrors(1);
      }
 else       if (ifzipfileexists == 2 && Fileexists) {
        result.setResult(true);
      }
 else       if (afterzip == 2 && realMovetodirectory == null) {
        result.setResult(false);
        result.setNrErrors(1);
        log.logError(toString(),Messages.getString("JobZipFiles.AfterZip_No_DestinationFolder_Defined.Label"));
      }
 else {
        if (ifzipfileexists == 0 && Fileexists) {
          DateFormat dateFormat=new SimpleDateFormat("hhmmss_mmddyyyy");
          ZipFilename=ZipFilename + "_" + dateFormat.format(new Date())+ ".zip";
          log.logDebug(toString(),Messages.getString("JobZipFiles.Zip_FileNameChange1.Label") + ZipFilename + Messages.getString("JobZipFiles.Zip_FileNameChange1.Label"));
        }
 else         if (ifzipfileexists == 1 && Fileexists) {
          log.logDebug(toString(),Messages.getString("JobZipFiles.Zip_FileAppend1.Label") + ZipFilename + Messages.getString("JobZipFiles.Zip_FileAppend2.Label"));
        }
        File f=new File(realTargetdirectory);
        String[] filelist=f.list();
        log.logDetailed(toString(),Messages.getString("JobZipFiles.Files_Found1.Label") + filelist.length + Messages.getString("JobZipFiles.Files_Found2.Label")+ realTargetdirectory+ Messages.getString("JobZipFiles.Files_Found3.Label"));
        Pattern pattern=null;
        if (!Const.isEmpty(realWildcard)) {
          pattern=Pattern.compile(realWildcard);
        }
        Pattern patternexclude=null;
        if (!Const.isEmpty(realWildcardExclude)) {
          patternexclude=Pattern.compile(realWildcardExclude);
        }
        byte[] buffer=new byte[18024];
        FileOutputStream dest=new FileOutputStream(ZipFilename);
        BufferedOutputStream buff=new BufferedOutputStream(dest);
        ZipOutputStream out=new ZipOutputStream(buff);
        out.setMethod(ZipOutputStream.DEFLATED);
        if (compressionrate == 0) {
          out.setLevel(Deflater.NO_COMPRESSION);
        }
 else         if (compressionrate == 1) {
          out.setLevel(Deflater.DEFAULT_COMPRESSION);
        }
        if (compressionrate == 2) {
          out.setLevel(Deflater.BEST_COMPRESSION);
        }
        if (compressionrate == 3) {
          out.setLevel(Deflater.BEST_SPEED);
        }
        String[] ZippedFiles=new String[filelist.length];
        int FileNum=0;
        for (int i=0; i < filelist.length && !parentJob.isStopped(); i++) {
          boolean getIt=true;
          boolean getItexclude=false;
          if (pattern != null) {
            Matcher matcher=pattern.matcher(filelist[i]);
            getIt=matcher.matches();
          }
          if (patternexclude != null) {
            Matcher matcherexclude=patternexclude.matcher(filelist[i]);
            getItexclude=matcherexclude.matches();
          }
          String targetFilename=realTargetdirectory + Const.FILE_SEPARATOR + filelist[i];
          File file=new File(targetFilename);
          if (getIt && !getItexclude && !file.isDirectory()) {
            log.logDebug(toString(),Messages.getString("JobZipFiles.Add_FilesToZip1.Label") + filelist[i] + Messages.getString("JobZipFiles.Add_FilesToZip2.Label")+ realTargetdirectory+ Messages.getString("JobZipFiles.Add_FilesToZip3.Label"));
            FileInputStream in=new FileInputStream(targetFilename);
            out.putNextEntry(new ZipEntry(filelist[i]));
            int len;
            while ((len=in.read(buffer)) > 0) {
              out.write(buffer,0,len);
            }
            out.closeEntry();
            in.close();
            ZippedFiles[FileNum]=filelist[i];
            FileNum=FileNum + 1;
          }
        }
        out.close();
        if (afterzip == 1 || afterzip == 2) {
          for (int i=0; i < ZippedFiles.length; i++) {
            if (ZippedFiles[i] != null) {
              FileObject fileObjectd=KettleVFS.getFileObject(realTargetdirectory + Const.FILE_SEPARATOR + ZippedFiles[i]);
              if (afterzip == 1) {
                boolean deleted=fileObjectd.delete();
                if (!deleted) {
                  result.setResult(false);
                  result.setNrErrors(1);
                  log.logError(toString(),Messages.getString("JobZipFiles.Can_Delete_File1.Label") + realTargetdirectory + Const.FILE_SEPARATOR+ ZippedFiles[i]+ Messages.getString("JobZipFiles.Can_Delete_File2.Label"));
                }
                log.logDebug(toString(),Messages.getString("JobZipFiles.File_Deleted1.Label") + realTargetdirectory + Const.FILE_SEPARATOR+ ZippedFiles[i]+ Messages.getString("JobZipFiles.File_Deleted2.Label"));
              }
 else               if (afterzip == 2) {
                try {
                  FileObject fileObjectm=KettleVFS.getFileObject(realMovetodirectory + Const.FILE_SEPARATOR + ZippedFiles[i]);
                  fileObjectd.moveTo(fileObjectm);
                }
 catch (                IOException e) {
                  log.logError(toString(),Messages.getString("JobZipFiles.Can_Move_File1.Label") + ZippedFiles[i] + Messages.getString("JobZipFiles.Can_Move_File2.Label")+ e.getMessage());
                  result.setResult(false);
                  result.setNrErrors(1);
                }
                log.logDebug(toString(),Messages.getString("JobZipFiles.File_Moved1.Label") + ZippedFiles[i] + Messages.getString("JobZipFiles.File_Moved2.Label"));
              }
            }
          }
        }
        result.setResult(true);
      }
    }
 catch (    IOException e) {
      log.logError(toString(),Messages.getString("JobZipFiles.Can_CreateZipFile1.Label") + realZipfilename + Messages.getString("JobZipFiles.Can_CreateZipFile2.Label")+ e.getMessage());
      result.setResult(false);
      result.setNrErrors(1);
    }
 finally {
      if (fileObject != null) {
        try {
          fileObject.close();
        }
 catch (        IOException ex) {
        }
        ;
      }
    }
  }
 else {
    result.setResult(false);
    result.setNrErrors(1);
    log.logError(toString(),Messages.getString("JobZipFiles.No_ZipFile_Defined.Label"));
  }
  return result;
}
