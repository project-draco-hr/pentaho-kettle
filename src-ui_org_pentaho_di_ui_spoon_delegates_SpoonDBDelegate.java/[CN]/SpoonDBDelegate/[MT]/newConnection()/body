{
  HasDatabasesInterface hasDatabasesInterface=spoon.getActiveHasDatabasesInterface();
  if (hasDatabasesInterface == null && spoon.rep == null) {
    return;
  }
  DatabaseMeta databaseMeta=new DatabaseMeta();
  DatabaseDialog con=new DatabaseDialog(spoon.getShell(),databaseMeta);
  String con_name=con.open();
  if (!Const.isEmpty(con_name)) {
    if (hasDatabasesInterface != null) {
      databaseMeta.verifyAndModifyDatabaseName(hasDatabasesInterface.getDatabases(),null);
      hasDatabasesInterface.addDatabase(databaseMeta);
      spoon.addUndoNew((UndoInterface)hasDatabasesInterface,new DatabaseMeta[]{(DatabaseMeta)databaseMeta.clone()},new int[]{hasDatabasesInterface.indexOfDatabase(databaseMeta)});
      saveConnection(databaseMeta);
      spoon.refreshTree();
    }
 else {
      try {
        if (!spoon.rep.userinfo.isReadonly()) {
          databaseMeta.saveRep(spoon.rep);
        }
 else {
          throw new KettleException(Messages.getString("Spoon.Dialog.Exception.ReadOnlyRepositoryUser"));
        }
      }
 catch (      KettleException e) {
        new ErrorDialog(spoon.getShell(),Messages.getString("Spoon.Dialog.ErrorSavingConnection.Title"),Messages.getString("Spoon.Dialog.ErrorSavingConnection.Message",databaseMeta.getName()),e);
      }
    }
  }
}
