{
  String TakeFirstNbrLines="";
  String LineTerminatedby="";
  String FieldTerminatedby="";
  boolean useFieldSeparator=false;
  String UseCodepage="";
  String ErrorfileName="";
  LogWriter log=LogWriter.getInstance();
  Result result=previousResult;
  result.setResult(false);
  String vfsFilename=environmentSubstitute(filename);
  FileObject fileObject=null;
  if (!Const.isEmpty(vfsFilename)) {
    try {
      fileObject=KettleVFS.getFileObject(vfsFilename);
      if (!(fileObject instanceof LocalFile)) {
        throw new KettleException(BaseMessages.getString(PKG,"JobMssqlBulkLoad.Error.OnlyLocalFileSupported",vfsFilename));
      }
      String realFilename=KettleVFS.getFilename(fileObject);
      File file=new File(realFilename);
      if (file.exists() && file.canRead()) {
        if (log.isDetailed())         log.logDetailed(toString(),BaseMessages.getString(PKG,"JobMssqlBulkLoad.FileExists.Label",realFilename));
        if (connection != null) {
          Database db=new Database(connection);
          if (db.getDatabaseMeta().getDatabaseType() != DatabaseMeta.TYPE_DATABASE_MSSQL) {
            log.logError(toString(),BaseMessages.getString(PKG,"JobMssqlBulkLoad.Error.DbNotMSSQL",connection.getDatabaseName()));
            return result;
          }
          db.shareVariablesWith(this);
          try {
            db.connect();
            String realSchemaname=environmentSubstitute(schemaname);
            String realTablename=environmentSubstitute(tablename);
            if (db.checkTableExists(realTablename)) {
              if (log.isDetailed())               log.logDetailed(toString(),BaseMessages.getString(PKG,"JobMssqlBulkLoad.TableExists.Label",realTablename));
              if (schemaname != null)               realTablename=realSchemaname + "." + realTablename;
              String Fieldterminator=getRealFieldTerminator();
              if (Const.isEmpty(Fieldterminator) && (datafiletype.equals("char") || datafiletype.equals("widechar"))) {
                log.logError(toString(),BaseMessages.getString(PKG,"JobMssqlBulkLoad.Error.FieldTerminatorMissing"));
                return result;
              }
 else {
                if (datafiletype.equals("char") || datafiletype.equals("widechar")) {
                  useFieldSeparator=true;
                  FieldTerminatedby="FIELDTERMINATOR='" + Fieldterminator + "'";
                }
              }
              if (codepage.equals("Specific")) {
                if (specificcodepage.length() < 0) {
                  log.logError(toString(),BaseMessages.getString(PKG,"JobMssqlBulkLoad.Error.SpecificCodePageMissing"));
                  return result;
                }
 else                 UseCodepage="CODEPAGE = '" + specificcodepage + "'";
              }
 else {
                UseCodepage="CODEPAGE = '" + codepage + "'";
              }
              if (errorfilename != null) {
                File errorfile=new File(errorfilename);
                if (errorfile.exists() && !adddatetime) {
                  log.logError(toString(),BaseMessages.getString(PKG,"JobMssqlBulkLoad.Error.ErrorFileExists"));
                  return result;
                }
                if (adddatetime) {
                  SimpleDateFormat daf=new SimpleDateFormat();
                  Date now=new Date();
                  daf.applyPattern("yyyMMdd_HHmmss");
                  String d=daf.format(now);
                  ErrorfileName="ERRORFILE ='" + errorfilename + "_"+ d+ "'";
                }
 else                 ErrorfileName="ERRORFILE ='" + errorfilename + "'";
              }
              String Rowterminator=getRealLineterminated();
              if (!Const.isEmpty(Rowterminator))               LineTerminatedby="ROWTERMINATOR='" + Rowterminator + "'";
              if (startfile > 0)               TakeFirstNbrLines="FIRSTROW=" + startfile;
              if (endfile > 0)               TakeFirstNbrLines="LASTROW=" + endfile;
              String SQLBULKLOAD="";
              if (truncate)               SQLBULKLOAD="TRUNCATE " + realTablename + ";";
              SQLBULKLOAD=SQLBULKLOAD + "BULK INSERT " + realTablename+ " FROM "+ "'"+ realFilename.replace('\\','/')+ "'";
              SQLBULKLOAD=SQLBULKLOAD + " WITH (";
              if (useFieldSeparator)               SQLBULKLOAD=SQLBULKLOAD + FieldTerminatedby;
 else               SQLBULKLOAD=SQLBULKLOAD + "DATAFILETYPE ='" + datafiletype+ "'";
              if (LineTerminatedby.length() > 0)               SQLBULKLOAD=SQLBULKLOAD + "," + LineTerminatedby;
              if (TakeFirstNbrLines.length() > 0)               SQLBULKLOAD=SQLBULKLOAD + "," + TakeFirstNbrLines;
              if (UseCodepage.length() > 0)               SQLBULKLOAD=SQLBULKLOAD + "," + UseCodepage;
              if (formatfilename != null)               SQLBULKLOAD=SQLBULKLOAD + ", FORMATFILE='" + formatfilename+ "'";
              if (firetriggers)               SQLBULKLOAD=SQLBULKLOAD + ",FIRE_TRIGGERS";
              if (keepnulls)               SQLBULKLOAD=SQLBULKLOAD + ",KEEPNULLS";
              if (keepidentity)               SQLBULKLOAD=SQLBULKLOAD + ",KEEPIDENTITY";
              if (checkconstraints)               SQLBULKLOAD=SQLBULKLOAD + ",CHECK_CONSTRAINTS";
              if (tablock)               SQLBULKLOAD=SQLBULKLOAD + ",TABLOCK";
              if (orderby != null)               SQLBULKLOAD=SQLBULKLOAD + ",ORDER ( " + orderby+ " "+ orderdirection+ ")";
              if (ErrorfileName.length() > 0)               SQLBULKLOAD=SQLBULKLOAD + ", " + ErrorfileName;
              if (maxerrors > 0)               SQLBULKLOAD=SQLBULKLOAD + ", MAXERRORS=" + maxerrors;
              if (batchsize > 0)               SQLBULKLOAD=SQLBULKLOAD + ", BATCHSIZE=" + batchsize;
              if (rowsperbatch > 0)               SQLBULKLOAD=SQLBULKLOAD + ", ROWS_PER_BATCH=" + rowsperbatch;
              SQLBULKLOAD=SQLBULKLOAD + ")";
              try {
                db.execStatements(SQLBULKLOAD);
                db.disconnect();
                if (isAddFileToResult()) {
                  ResultFile resultFile=new ResultFile(ResultFile.FILE_TYPE_GENERAL,KettleVFS.getFileObject(realFilename),parentJob.getJobname(),toString());
                  result.getResultFiles().put(resultFile.getFile().toString(),resultFile);
                }
                result.setResult(true);
              }
 catch (              KettleDatabaseException je) {
                result.setNrErrors(1);
                log.logError(toString(),"An error occurred executing this job entry : " + je.getMessage());
              }
catch (              IOException e) {
                log.logError(toString(),"An error occurred executing this job entry : " + e.getMessage());
                result.setNrErrors(1);
              }
 finally {
                if (db != null) {
                  db.disconnect();
                  db=null;
                }
              }
            }
 else {
              db.disconnect();
              result.setNrErrors(1);
              if (log.isDetailed())               log.logDetailed(toString(),BaseMessages.getString(PKG,"JobMssqlBulkLoad.Error.TableNotExists",realTablename));
            }
          }
 catch (          KettleDatabaseException dbe) {
            db.disconnect();
            result.setNrErrors(1);
            log.logError(toString(),"An error occurred executing this entry: " + dbe.getMessage());
          }
        }
 else {
          result.setNrErrors(1);
          log.logError(toString(),BaseMessages.getString(PKG,"JobMssqlBulkLoad.Nodatabase.Label"));
        }
      }
 else {
        result.setNrErrors(1);
        log.logError(toString(),BaseMessages.getString(PKG,"JobMssqlBulkLoad.Error.FileNotExists",realFilename));
      }
    }
 catch (    Exception e) {
      result.setNrErrors(1);
      log.logError(toString(),BaseMessages.getString(PKG,"JobMssqlBulkLoad.UnexpectedError.Label"),e);
    }
 finally {
      try {
        if (fileObject != null)         fileObject.close();
      }
 catch (      Exception e) {
      }
    }
  }
 else {
    result.setNrErrors(1);
    log.logError(toString(),BaseMessages.getString(PKG,"JobMssqlBulkLoad.Nofilename.Label"));
  }
  return result;
}
