{
  System.out.println("Loading repository info...");
  RepositoryMeta repinfo=new RepositoryMeta();
  getInfo(repinfo);
  if (repinfo.getConnection() != null) {
    System.out.println("Allocating repository...");
    Repository rep=new Repository(log,repinfo,null);
    System.out.println("Connecting to database for repository creation...");
    if (rep.connect(true,false,getClass().getName())) {
      boolean upgrade=false;
      String cu=Messages.getString("RepositoryDialog.Dialog.CreateUpgrade.Create");
      try {
        upgrade=rep.getDatabase().checkTableExists("R_USER");
        if (upgrade)         cu=Messages.getString("RepositoryDialog.Dialog.CreateUpgrade.Upgrade");
      }
 catch (      KettleDatabaseException dbe) {
        rep.rollback();
      }
      MessageBox qmb=new MessageBox(shell,SWT.ICON_WARNING | SWT.YES | SWT.NO);
      qmb.setMessage(Messages.getString("RepositoryDialog.Dialog.CreateUpgrade.Message1") + cu + Messages.getString("RepositoryDialog.Dialog.CreateUpgrade.Message2"));
      qmb.setText(Messages.getString("RepositoryDialog.Dialog.CreateUpgrade.Title"));
      int answer=qmb.open();
      if (answer == SWT.YES) {
        boolean goAhead=!upgrade;
        if (!goAhead) {
          EnterPasswordDialog etd=new EnterPasswordDialog(shell,props,Messages.getString("RepositoryDialog.Dialog.EnterPassword.Title"),Messages.getString("RepositoryDialog.Dialog.EnterPassword.Message"),"");
          String pwd=etd.open();
          if (pwd != null) {
            try {
              UserInfo ui=new UserInfo(rep,"admin");
              if (pwd.equalsIgnoreCase(ui.getPassword())) {
                goAhead=true;
              }
 else {
                MessageBox mb=new MessageBox(shell,SWT.ICON_ERROR | SWT.OK);
                mb.setMessage(Messages.getString("RepositoryDialog.Dialog.UpgradePasswordNotCorrect.Message"));
                mb.setText(Messages.getString("RepositoryDialog.Dialog.UpgradePasswordNotCorrect.Title"));
                mb.open();
              }
            }
 catch (            KettleException e) {
              new ErrorDialog(shell,props,Messages.getString("RepositoryDialog.Dialog.UnableToVerifyUser.Title"),Messages.getString("RepositoryDialog.Dialog.UnableToVerifyUser.Message"),e);
            }
          }
        }
        if (goAhead) {
          System.out.println(Messages.getString("RepositoryDialog.Dialog.TryingToUpgradeRepository.Message1") + cu + Messages.getString("RepositoryDialog.Dialog.TryingToUpgradeRepository.Message2"));
          UpgradeRepositoryProgressDialog urpd=new UpgradeRepositoryProgressDialog(log,props,shell,rep,upgrade);
          if (urpd.open()) {
            MessageBox mb=new MessageBox(shell,SWT.ICON_INFORMATION | SWT.OK);
            mb.setMessage(Messages.getString("RepositoryDialog.Dialog.UpgradeFinished.Message1") + cu + Messages.getString("RepositoryDialog.Dialog.UpgradeFinished.Message2"));
            mb.setText(Messages.getString("RepositoryDialog.Dialog.UpgradeFinished.Title"));
            mb.open();
          }
        }
      }
      rep.disconnect();
    }
 else {
      MessageBox mb=new MessageBox(shell,SWT.ICON_ERROR | SWT.OK);
      mb.setMessage(Messages.getString("RepositoryDialog.Dialog.UnableToConnectToUpgrade.Message") + Const.CR);
      mb.setText(Messages.getString("RepositoryDialog.Dialog.UnableToConnectToUpgrade.Title"));
      mb.open();
    }
  }
 else {
    MessageBox mb=new MessageBox(shell,SWT.ICON_ERROR | SWT.OK);
    mb.setMessage(Messages.getString("RepositoryDialog.Dialog.FirstCreateAValidConnection.Message"));
    mb.setText(Messages.getString("RepositoryDialog.Dialog.FirstCreateAValidConnection.Title"));
    mb.open();
  }
}
