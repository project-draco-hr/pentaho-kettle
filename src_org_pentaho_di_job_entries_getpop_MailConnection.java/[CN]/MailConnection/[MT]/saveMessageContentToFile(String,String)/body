{
  File file=null;
  OutputStream os=null;
  InputStream is=null;
  Enumeration<Header> enums=null;
  try {
    file=new File(foldername,filename);
    os=new FileOutputStream(file);
    enums=getMessage().getAllHeaders();
    while (enums.hasMoreElements()) {
      Header header=(Header)enums.nextElement();
      os.write(new StringBuilder(header.getName()).append(": ").append(header.getValue()).append("\r\n").toString().getBytes());
    }
    os.write("\r\n".getBytes());
    is=getMessage().getInputStream();
    byte[] buffer=new byte[1024];
    int length=0;
    while ((length=is.read(buffer,0,1024)) != -1) {
      os.write(buffer,0,length);
    }
    os.close();
    updateSavedMessagesCounter();
  }
 catch (  Exception e) {
    throw new KettleException(BaseMessages.getString(PKG,"MailConnection.Error.SavingMessageContent","" + this.message.getMessageNumber(),filename,foldername),e);
  }
 finally {
    if (os != null) {
      try {
        os.close();
        os=null;
      }
 catch (      Exception e) {
      }
      ;
    }
    if (is != null) {
      try {
        is.close();
        is=null;
      }
 catch (      Exception e) {
      }
      ;
    }
    if (file != null)     file=null;
    if (enums != null)     enums=null;
  }
}
