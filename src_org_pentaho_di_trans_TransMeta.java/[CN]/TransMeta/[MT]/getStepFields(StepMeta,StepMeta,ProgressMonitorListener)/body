{
  RowMetaInterface row=new RowMeta();
  if (stepMeta == null)   return row;
  String fromToCacheEntry=stepMeta.getName() + (targetStep != null ? ("-" + targetStep.getName()) : "");
  RowMetaInterface rowMeta=stepsFieldsCache.get(fromToCacheEntry);
  if (rowMeta != null) {
    return rowMeta;
  }
  if (targetStep != null && stepMeta.isSendingErrorRowsToStep(targetStep)) {
    row=getPrevStepFields(stepMeta);
    StepErrorMeta stepErrorMeta=stepMeta.getStepErrorMeta();
    row.addRowMeta(stepErrorMeta.getErrorFields());
    stepsFieldsCache.put(fromToCacheEntry,row);
    return row;
  }
  log.logDebug(toString(),Messages.getString("TransMeta.Log.FromStepALookingAtPreviousStep",stepMeta.getName(),String.valueOf(findNrPrevSteps(stepMeta))));
  for (int i=0; i < findNrPrevSteps(stepMeta); i++) {
    StepMeta prevStepMeta=findPrevStep(stepMeta,i);
    if (monitor != null) {
      monitor.subTask(Messages.getString("TransMeta.Monitor.CheckingStepTask.Title",prevStepMeta.getName()));
    }
    RowMetaInterface add=getStepFields(prevStepMeta,stepMeta,monitor);
    if (add == null)     add=new RowMeta();
    log.logDebug(toString(),Messages.getString("TransMeta.Log.FoundFieldsToAdd") + add.toString());
    if (i == 0) {
      row.addRowMeta(add);
    }
 else {
      for (int x=0; x < add.size(); x++) {
        ValueMetaInterface v=add.getValueMeta(x);
        ValueMetaInterface s=row.searchValueMeta(v.getName());
        if (s == null) {
          row.addValueMeta(v);
        }
      }
    }
  }
  rowMeta=getThisStepFields(stepMeta,targetStep,row,monitor);
  stepsFieldsCache.put(fromToCacheEntry,rowMeta);
  return rowMeta;
}
