{
  try {
    meta=(TransExecutorMeta)smi;
    setData((TransExecutorData)sdi);
    Object[] row=getRow();
    if (row == null) {
      if (!getData().groupBuffer.isEmpty()) {
        executeTrans();
      }
      setOutputDone();
      return false;
    }
    if (first) {
      first=false;
      getData().inputRowMeta=getInputRowMeta();
      getData().executionResultsOutputRowMeta=getData().inputRowMeta.clone();
      getData().resultRowsOutputRowMeta=getData().inputRowMeta.clone();
      getData().resultFilesOutputRowMeta=getData().inputRowMeta.clone();
      if (meta.getExecutionResultTargetStepMeta() != null) {
        meta.getFields(getData().executionResultsOutputRowMeta,getStepname(),null,meta.getExecutionResultTargetStepMeta(),this,repository,metaStore);
        getData().executionResultRowSet=findOutputRowSet(meta.getExecutionResultTargetStepMeta().getName());
      }
      if (meta.getResultFilesTargetStepMeta() != null) {
        meta.getFields(getData().resultFilesOutputRowMeta,getStepname(),null,meta.getResultFilesTargetStepMeta(),this,repository,metaStore);
        getData().resultFilesRowSet=findOutputRowSet(meta.getResultFilesTargetStepMeta().getName());
      }
      getData().groupFieldIndex=-1;
      if (!Const.isEmpty(getData().groupField)) {
        getData().groupFieldIndex=getInputRowMeta().indexOfValue(getData().groupField);
        if (getData().groupFieldIndex < 0) {
          throw new KettleException(BaseMessages.getString(PKG,"TransExecutor.Exception.GroupFieldNotFound",getData().groupField));
        }
        getData().groupFieldMeta=getInputRowMeta().getValueMeta(getData().groupFieldIndex);
      }
    }
    boolean newGroup=false;
    if (getData().groupSize >= 0) {
      if (getData().groupSize != 0) {
        if (getData().groupBuffer.size() >= getData().groupSize) {
          newGroup=true;
        }
      }
    }
 else     if (getData().groupFieldIndex >= 0) {
      Object groupFieldData=row[getData().groupFieldIndex];
      if (getData().prevGroupFieldData != null) {
        if (getData().groupFieldMeta.compare(getData().prevGroupFieldData,groupFieldData) != 0) {
          newGroup=true;
        }
      }
      getData().prevGroupFieldData=groupFieldData;
    }
 else     if (getData().groupTime > 0) {
      long now=System.currentTimeMillis();
      if (now - getData().groupTimeStart >= getData().groupTime) {
        newGroup=true;
      }
    }
    if (newGroup) {
      executeTrans();
    }
    getData().groupBuffer.add(new RowMetaAndData(getInputRowMeta(),row));
    return true;
  }
 catch (  Exception e) {
    throw new KettleException(BaseMessages.getString(PKG,"TransExecutor.UnexpectedError"),e);
  }
}
