{
  if (trans != null) {
    if (trans.isFinished() && (running || halted)) {
      log.logMinimal(Spoon.APP_NAME,Messages.getString("TransLog.Log.TransformationHasFinished"));
      running=false;
      initialized=false;
      halted=false;
      halting=false;
      try {
        trans.endProcessing("end");
        if (spoonHistoryRefresher != null)         spoonHistoryRefresher.markRefreshNeeded();
      }
 catch (      KettleException e) {
        new ErrorDialog(shell,Messages.getString("TransLog.Dialog.ErrorWritingLogRecord.Title"),Messages.getString("TransLog.Dialog.ErrorWritingLogRecord.Message"),e);
      }
      wStart.setEnabled(true);
      wPause.setEnabled(false);
      wStop.setEnabled(false);
      if (debug && lastTransDebugMeta != null && lastTransDebugMeta.getTotalNumberOfHits() == 0) {
        showLastPreviewResults();
      }
      debug=false;
    }
  }
}
