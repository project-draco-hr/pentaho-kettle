{
  meta=(ValueMapperMeta)smi;
  data=(ValueMapperData)sdi;
  Row r=getRow();
  if (r == null) {
    setOutputDone();
    return false;
  }
  if (first) {
    first=false;
    data.keynr=r.searchValueIndex(meta.getFieldToUse());
    if (data.keynr < 0) {
      String message=Messages.getString("ValueMapper.RuntimeError.FieldToUseNotFound.VALUEMAPPER0001",meta.getFieldToUse(),Const.CR,r.toString());
      log.logError(toString(),message);
      setErrors(1);
      stopAll();
      return false;
    }
    for (int i=0; i < meta.getSourceValue().length; i++) {
      if (Const.isEmpty(meta.getSourceValue()[i])) {
        if (data.emptyFieldIndex < 0) {
          data.emptyFieldIndex=i;
        }
 else {
          throw new KettleException(Messages.getString("ValueMapper.RuntimeError.OnlyOneEmptyMappingAllowed.VALUEMAPPER0004"));
        }
      }
    }
  }
  Value value=r.getValue(data.keynr);
  String source=value.getString();
  String target=null;
  if (data.emptyFieldIndex >= 0 && (value.isNull() || Const.isEmpty(source))) {
    target=meta.getTargetValue()[data.emptyFieldIndex];
  }
 else {
    if (!Const.isEmpty(source)) {
      target=(String)data.hashtable.get(source);
    }
  }
  if (!Const.isEmpty(meta.getTargetField())) {
    Value extraValue=new Value(meta.getTargetField(),target);
    if (Const.isEmpty(target))     extraValue.setNull();
    r.addValue(extraValue);
  }
 else {
    int type=value.getType();
    if (!Const.isEmpty(target))     value.setValue(target);
    if (type != value.getType()) {
      value.setType(type);
    }
  }
  putRow(r);
  return true;
}
