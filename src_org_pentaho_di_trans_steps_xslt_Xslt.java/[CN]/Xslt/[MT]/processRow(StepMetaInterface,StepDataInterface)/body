{
  meta=(XsltMeta)smi;
  data=(XsltData)sdi;
  Object[] row=getRow();
  if (row == null) {
    setOutputDone();
    return false;
  }
  if (first) {
    first=false;
    data.outputRowMeta=getInputRowMeta().clone();
    meta.getFields(data.outputRowMeta,getStepname(),null,null,this);
    if (Const.isEmpty(meta.getResultfieldname())) {
      logError(BaseMessages.getString(PKG,"Xslt.Log.ErrorResultFieldMissing"));
      throw new KettleStepException(BaseMessages.getString(PKG,"Xslt.Exception.ErrorResultFieldMissing"));
    }
    if (Const.isEmpty(meta.getFieldname())) {
      logError(BaseMessages.getString(PKG,"Xslt.Exception.ErrorXMLFieldMissing"));
      throw new KettleStepException(BaseMessages.getString(PKG,"Xslt.Exception.ErrorXMLFieldMissing"));
    }
    data.fieldposition=getInputRowMeta().indexOfValue(meta.getFieldname());
    if (data.fieldposition < 0) {
      logError(BaseMessages.getString(PKG,"Xslt.Log.ErrorFindingField") + "[" + meta.getFieldname()+ "]");
      throw new KettleStepException(BaseMessages.getString(PKG,"Xslt.Exception.CouldnotFindField",meta.getFieldname()));
    }
    if (meta.useXSLFileFieldUse()) {
      if (Const.isEmpty(meta.getXSLFileField())) {
        logError(BaseMessages.getString(PKG,"Xslt.Log.ErrorXSLFileFieldMissing"));
        throw new KettleStepException(BaseMessages.getString(PKG,"Xslt.Exception.ErrorXSLFileFieldMissing"));
      }
      data.fielxslfiledposition=getInputRowMeta().indexOfValue(meta.getXSLFileField());
      if (data.fielxslfiledposition < 0) {
        logError(BaseMessages.getString(PKG,"Xslt.Log.ErrorXSLFileFieldFinding") + "[" + meta.getXSLFileField()+ "]");
        throw new KettleStepException(BaseMessages.getString(PKG,"Xslt.Exception.ErrorXSLFileFieldFinding",meta.getXSLFileField()));
      }
    }
 else {
      if (Const.isEmpty(meta.getXslFilename())) {
        logError(BaseMessages.getString(PKG,"Xslt.Log.ErrorXSLFile"));
        throw new KettleStepException(BaseMessages.getString(PKG,"Xslt.Exception.ErrorXSLFile"));
      }
      data.xslfilename=environmentSubstitute(meta.getXslFilename());
      java.io.File file=new java.io.File(data.xslfilename);
      if (!file.exists()) {
        logError(BaseMessages.getString(PKG,"Xslt.Log.ErrorXSLFileNotExists",data.xslfilename));
        throw new KettleStepException(BaseMessages.getString(PKG,"Xslt.Exception.ErrorXSLFileNotExists",data.xslfilename));
      }
      if (!file.isFile()) {
        logError(BaseMessages.getString(PKG,"Xslt.Log.ErrorXSLNotAFile",data.xslfilename));
        throw new KettleStepException(BaseMessages.getString(PKG,"Xslt.Exception.ErrorXSLNotAFile",data.xslfilename));
      }
    }
  }
  String Fieldvalue=getInputRowMeta().getString(row,data.fieldposition);
  String xmlString=null;
  if (meta.useXSLFileFieldUse()) {
    data.xslfilename=getInputRowMeta().getString(row,data.fielxslfiledposition);
    if (log.isDetailed())     logDetailed(BaseMessages.getString(PKG,"Xslt.Log.XslfileNameFromFied",data.xslfilename,meta.getXSLFileField()));
  }
  boolean sendToErrorRow=false;
  String errorMessage=null;
  try {
    if (log.isDetailed())     logDetailed(BaseMessages.getString(PKG,"Xslt.Log.Filexsl") + data.xslfilename);
    TransformerFactory factory=TransformerFactory.newInstance();
    if (meta.getXSLFactory().equals("SAXON")) {
      factory=new net.sf.saxon.TransformerFactoryImpl();
    }
    FileInputStream xslInputStream=new FileInputStream(data.xslfilename);
    try {
      Templates template=factory.newTemplates(new StreamSource(xslInputStream));
      Transformer xformer=template.newTransformer();
      Source source=new StreamSource(new StringReader(Fieldvalue));
      StreamResult resultat=new StreamResult(new StringWriter());
      xformer.transform(source,resultat);
      xmlString=resultat.getWriter().toString();
      if (log.isDetailed()) {
        logDetailed(BaseMessages.getString(PKG,"Xslt.Log.FileResult"));
        logDetailed(xmlString);
      }
      Object[] outputRowData=RowDataUtil.addValueData(row,getInputRowMeta().size(),xmlString);
      if (log.isRowLevel()) {
        logRowlevel(BaseMessages.getString(PKG,"Xslt.Log.ReadRow") + " " + getInputRowMeta().getString(row));
      }
      putRow(data.outputRowMeta,outputRowData);
    }
  finally {
      BaseStep.closeQuietly(xslInputStream);
    }
  }
 catch (  Exception e) {
    if (getStepMeta().isDoingErrorHandling()) {
      sendToErrorRow=true;
      errorMessage=e.getMessage();
    }
    if (sendToErrorRow) {
      putError(getInputRowMeta(),row,1,errorMessage,meta.getResultfieldname(),"XSLT01");
    }
 else {
      logError(BaseMessages.getString(PKG,"Xslt.ErrorProcesing" + " : " + e.getMessage()));
      throw new KettleStepException(BaseMessages.getString(PKG,"Xslt.ErrorProcesing"),e);
    }
  }
  return true;
}
