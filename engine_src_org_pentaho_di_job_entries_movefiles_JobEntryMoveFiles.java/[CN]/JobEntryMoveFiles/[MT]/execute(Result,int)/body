{
  Result result=previousResult;
  List<RowMetaAndData> rows=result.getRows();
  RowMetaAndData resultRow=null;
  result.setNrErrors(1);
  result.setResult(false);
  NrErrors=0;
  NrSuccess=0;
  successConditionBroken=false;
  successConditionBrokenExit=false;
  limitFiles=Const.toInt(environmentSubstitute(getNrErrorsLessThan()),10);
  if (log.isDetailed()) {
    if (simulate) {
      logDetailed(BaseMessages.getString(PKG,"JobMoveFiles.Log.SimulationOn"));
    }
    if (include_subfolders) {
      logDetailed(BaseMessages.getString(PKG,"JobMoveFiles.Log.IncludeSubFoldersOn"));
    }
  }
  String MoveToFolder=environmentSubstitute(destinationFolder);
  String[] vsourcefilefolder=source_filefolder;
  String[] vdestinationfilefolder=destination_filefolder;
  String[] vwildcard=wildcard;
  if (iffileexists.equals("move_file")) {
    if (Utils.isEmpty(MoveToFolder)) {
      logError(BaseMessages.getString(PKG,"JobMoveFiles.Log.Error.MoveToFolderMissing"));
      return result;
    }
    FileObject folder=null;
    try {
      folder=KettleVFS.getFileObject(MoveToFolder,this);
      if (!folder.exists()) {
        if (log.isDetailed()) {
          logDetailed(BaseMessages.getString(PKG,"JobMoveFiles.Log.Error.FolderMissing",MoveToFolder));
        }
        if (create_move_to_folder) {
          folder.createFolder();
        }
 else {
          logError(BaseMessages.getString(PKG,"JobMoveFiles.Log.Error.FolderMissing",MoveToFolder));
          return result;
        }
      }
      if (!folder.getType().equals(FileType.FOLDER)) {
        logError(BaseMessages.getString(PKG,"JobMoveFiles.Log.Error.NotFolder",MoveToFolder));
        return result;
      }
    }
 catch (    Exception e) {
      logError(BaseMessages.getString(PKG,"JobMoveFiles.Log.Error.GettingMoveToFolder",MoveToFolder,e.getMessage()));
      return result;
    }
 finally {
      if (folder != null) {
        try {
          folder.close();
        }
 catch (        IOException ex) {
        }
      }
    }
  }
  if (arg_from_previous) {
    if (log.isDetailed()) {
      logDetailed(BaseMessages.getString(PKG,"JobMoveFiles.Log.ArgFromPrevious.Found",(rows != null ? rows.size() : 0) + ""));
    }
  }
  if (arg_from_previous && rows != null) {
    for (int iteration=0; iteration < rows.size() && !parentJob.isStopped(); iteration++) {
      if (successConditionBroken) {
        if (!successConditionBrokenExit) {
          logError(BaseMessages.getString(PKG,"JobMoveFiles.Error.SuccessConditionbroken","" + NrErrors));
          successConditionBrokenExit=true;
        }
        result.setNrErrors(NrErrors);
        displayResults();
        return result;
      }
      resultRow=rows.get(iteration);
      String vsourcefilefolder_previous=resultRow.getString(0,null);
      String vdestinationfilefolder_previous=resultRow.getString(1,null);
      String vwildcard_previous=resultRow.getString(2,null);
      if (!Utils.isEmpty(vsourcefilefolder_previous) && !Utils.isEmpty(vdestinationfilefolder_previous)) {
        if (log.isDetailed()) {
          logDetailed(BaseMessages.getString(PKG,"JobMoveFiles.Log.ProcessingRow",vsourcefilefolder_previous,vdestinationfilefolder_previous,vwildcard_previous));
        }
        if (!ProcessFileFolder(vsourcefilefolder_previous,vdestinationfilefolder_previous,vwildcard_previous,parentJob,result,MoveToFolder)) {
          updateErrors();
        }
      }
 else {
        if (log.isDetailed()) {
          logDetailed(BaseMessages.getString(PKG,"JobMoveFiles.Log.IgnoringRow",vsourcefilefolder[iteration],vdestinationfilefolder[iteration],vwildcard[iteration]));
        }
      }
    }
  }
 else   if (vsourcefilefolder != null && vdestinationfilefolder != null) {
    for (int i=0; i < vsourcefilefolder.length && !parentJob.isStopped(); i++) {
      if (successConditionBroken) {
        if (!successConditionBrokenExit) {
          logError(BaseMessages.getString(PKG,"JobMoveFiles.Error.SuccessConditionbroken","" + NrErrors));
          successConditionBrokenExit=true;
        }
        result.setNrErrors(NrErrors);
        displayResults();
        return result;
      }
      if (!Utils.isEmpty(vsourcefilefolder[i]) && !Utils.isEmpty(vdestinationfilefolder[i])) {
        if (log.isDetailed()) {
          logDetailed(BaseMessages.getString(PKG,"JobMoveFiles.Log.ProcessingRow",vsourcefilefolder[i],vdestinationfilefolder[i],vwildcard[i]));
        }
        if (!ProcessFileFolder(vsourcefilefolder[i],vdestinationfilefolder[i],vwildcard[i],parentJob,result,MoveToFolder)) {
          updateErrors();
        }
      }
 else {
        if (log.isDetailed()) {
          logDetailed(BaseMessages.getString(PKG,"JobMoveFiles.Log.IgnoringRow",vsourcefilefolder[i],vdestinationfilefolder[i],vwildcard[i]));
        }
      }
    }
  }
  result.setNrErrors(NrErrors);
  result.setNrLinesWritten(NrSuccess);
  if (getSuccessStatus()) {
    result.setResult(true);
  }
  displayResults();
  return result;
}
