{
  Row lu=new Row();
  Row add=null;
  debug="Start of lookupValues()";
  if (first) {
    debug="First part";
    first=false;
    data.keynrs=new int[meta.getKeystream().length];
    for (int i=0; i < meta.getKeystream().length; i++) {
      data.keynrs[i]=row.searchValueIndex(meta.getKeystream()[i]);
      if (data.keynrs[i] < 0) {
        logError(Messages.getString("StreamLookup.Log.FieldNotFound",meta.getKeystream()[i],"" + row));
        setErrors(1);
        stopAll();
        return false;
      }
 else {
        if (log.isDetailed())         logDetailed(Messages.getString("StreamLookup.Log.FieldInfo",meta.getKeystream()[i],"" + data.keynrs[i]));
      }
    }
    handleNullIf();
    debug="first: do lookup";
    try {
      if (meta.getKeystream().length > 0) {
        add=(Row)data.look.get(lu);
      }
 else {
        add=data.firstrow;
        if (log.isRowLevel())         logRowlevel(Messages.getString("StreamLookup.Log.GotRowWithoutKeys") + add);
      }
    }
 catch (    Exception e) {
      add=null;
    }
  }
  if (stopped)   return false;
  debug="Copy value references to lookup table";
  for (int i=0; i < meta.getKeystream().length; i++) {
    int valueNr=data.keynrs[i];
    Value value=row.getValue(valueNr);
    lu.addValue(value);
  }
  debug="start lookupValues";
  if (log.isDebug())   debug="lookup size = " + lu.size();
  if (data.keyTypes != null) {
    for (int i=0; i < lu.size(); i++) {
      Value inputValue=lu.getValue(i);
      Value lookupValue=data.keyTypes.getValue(i);
      if (inputValue.getType() != lookupValue.getType()) {
        Value newValue=new Value(inputValue);
        newValue.setType(lookupValue.getType());
        lu.setValue(i,newValue);
      }
    }
  }
  try {
    debug="do lookup";
    if (meta.getKeystream().length > 0) {
      add=(Row)data.look.get(lu);
    }
 else {
      add=data.firstrow;
      if (log.isRowLevel())       logRowlevel(Messages.getString("StreamLookup.Log.GotRowWithoutKeys") + add);
    }
  }
 catch (  Exception e) {
    add=null;
  }
  if (add == null) {
    debug="add null values";
    add=new Row();
    for (int i=0; i < meta.getValue().length; i++) {
      add.addValue(new Value(data.nullIf[i]));
    }
  }
  debug="add returned values";
  try {
    for (int i=0; i < add.size(); i++) {
      Value v=add.getValue(i);
      if (log.isDebug())       debug="add returned value #" + i + " : "+ v.toString()+ " ("+ v.toStringMeta()+ ")";
      if (v.getType() != meta.getValueDefaultType()[i]) {
        v.setType(meta.getValueDefaultType()[i]);
      }
      if (meta.getValueName()[i] != null && meta.getValueName()[i].length() > 0) {
        v.setName(meta.getValueName()[i]);
      }
      row.addValue(v);
    }
  }
 catch (  Exception e) {
    throw new RuntimeException(e);
  }
  debug="Finished lookupValues";
  return true;
}
