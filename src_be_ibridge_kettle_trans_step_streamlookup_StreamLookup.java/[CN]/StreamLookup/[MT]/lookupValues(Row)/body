{
  Row lu=new Row();
  Row add=null;
  debug=Messages.getString("StreamLookup.Debug.StartLookupValues");
  if (first) {
    debug=Messages.getString("StreamLookup.Debug.FirstPart");
    first=false;
    data.keynrs=new int[meta.getKeystream().length];
    for (int i=0; i < meta.getKeystream().length; i++) {
      data.keynrs[i]=row.searchValueIndex(meta.getKeystream()[i]);
      if (data.keynrs[i] < 0) {
        logError(Messages.getString("StreamLookup.Log.FieldNotFound",meta.getKeystream()[i],"" + row));
        setErrors(1);
        stopAll();
        return false;
      }
 else {
        if (log.isDetailed())         logDetailed(Messages.getString("StreamLookup.Log.FieldInfo",meta.getKeystream()[i],"" + data.keynrs[i]));
      }
    }
    handleNullIf();
    debug=Messages.getString("StreamLookup.Debug.FirstDoLookupValues");
    try {
      if (meta.getKeystream().length > 0) {
        add=(Row)data.look.get(lu);
      }
 else {
        add=data.firstrow;
        if (log.isRowLevel())         logRowlevel(Messages.getString("StreamLookup.Log.GotRowWithoutKeys") + add);
      }
    }
 catch (    Exception e) {
      add=null;
    }
  }
  if (stopped)   return false;
  debug=Messages.getString("StreamLookup.Debug.CopyValueReference");
  for (int i=0; i < meta.getKeystream().length; i++) {
    int valueNr=data.keynrs[i];
    Value value=row.getValue(valueNr);
    lu.addValue(value);
  }
  debug=Messages.getString("StreamLookup.Debug.HandleConflictingTypes");
  debug=Messages.getString("StreamLookup.Debug.LookupSize") + lu.size();
  if (data.keyTypes != null) {
    for (int i=0; i < lu.size(); i++) {
      Value inputValue=lu.getValue(i);
      Value lookupValue=data.keyTypes.getValue(i);
      if (inputValue.getType() != lookupValue.getType()) {
        Value newValue=new Value(inputValue);
        newValue.setType(lookupValue.getType());
        lu.setValue(i,newValue);
      }
    }
  }
  try {
    debug="do lookup";
    if (meta.getKeystream().length > 0) {
      add=(Row)data.look.get(lu);
    }
 else {
      add=data.firstrow;
      if (log.isRowLevel())       logRowlevel(Messages.getString("StreamLookup.Log.GotRowWithoutKeys") + add);
    }
  }
 catch (  Exception e) {
    add=null;
  }
  if (add == null) {
    debug=Messages.getString("StreamLookup.Debug.AddNullValues");
    add=new Row();
    for (int i=0; i < meta.getValue().length; i++) {
      add.addValue(new Value(data.nullIf[i]));
    }
  }
  debug=Messages.getString("StreamLookup.Debug.AddReturnedValues");
  try {
    for (int i=0; i < add.size(); i++) {
      Value v=add.getValue(i);
      debug=Messages.getString("StreamLookup.Debug.AddReturnedValues2") + i + " : "+ v.toString()+ " ("+ v.toStringMeta()+ ")";
      if (v.getType() != meta.getValueDefaultType()[i]) {
        v.setType(meta.getValueDefaultType()[i]);
      }
      if (meta.getValueName()[i] != null && meta.getValueName()[i].length() > 0) {
        v.setName(meta.getValueName()[i]);
      }
      row.addValue(v);
    }
  }
 catch (  Exception e) {
    throw new RuntimeException(e);
  }
  debug=Messages.getString("StreamLookup.Debug.FinishedLookupValues");
  return true;
}
