{
  if (sp != null) {
    try {
      Class<?> cl=null;
switch (sp.getType()) {
case JobPlugin.TYPE_NATIVE:
{
          cl=Class.forName(sp.getClassname());
        }
      break;
case JobPlugin.TYPE_PLUGIN:
{
      String jarfiles[]=sp.getJarfiles();
      URL urls[]=new URL[jarfiles.length];
      for (int i=0; i < jarfiles.length; i++) {
        FileSystemManager mgr=VFS.getManager();
        FileObject jarfile=mgr.resolveFile(jarfiles[i]);
        urls[i]=new URL(jarfile.getName().getURI());
      }
      ClassLoader classLoader=getClass().getClassLoader();
      URLClassLoader ucl=(URLClassLoader)classLoaders.get(sp.getID());
      if (ucl == null) {
        ucl=new URLClassLoader(urls,classLoader);
        classLoaders.put(sp.getID(),ucl);
      }
      cl=ucl.loadClass(sp.getClassname());
    }
  break;
default :
throw new KettleStepLoaderException("Unknown plugin type : " + sp.getType());
}
JobEntryInterface res=(JobEntryInterface)cl.newInstance();
if (sp.getType() == JobPlugin.TYPE_PLUGIN) {
res.setPluginID(sp.getID());
}
res.setDescription(sp.getDescription());
res.setName(sp.getID());
res.setConfigId(sp.getID());
if (res.getJobEntryType() == null) res.setJobEntryType(sp.getJobType());
return res;
}
 catch (ClassNotFoundException e) {
throw new KettleStepLoaderException("Class not found",e);
}
catch (InstantiationException e) {
throw new KettleStepLoaderException("Unable to instantiate class",e);
}
catch (IllegalAccessException e) {
throw new KettleStepLoaderException("Illegal access to class",e);
}
catch (Throwable e) {
throw new KettleStepLoaderException("Unexpected error loading class",e);
}
}
 else {
throw new KettleStepLoaderException("No valid step/plugin specified (plugin=null).");
}
}
