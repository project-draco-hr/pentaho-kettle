{
  try {
    Object[] outputRowData=RowDataUtil.createResizedCopy(r,data.outputRowMeta.size());
    int tempIndex=rowMeta.size();
    data.context.setRowData(outputRowData);
    if (data.formulas == null) {
      data.formulas=new org.pentaho.reporting.libraries.formula.Formula[meta.getFormula().length];
      for (int i=0; i < meta.getFormula().length; i++) {
        FormulaMetaFunction fn=meta.getFormula()[i];
        if (!Const.isEmpty(fn.getFieldName())) {
          data.formulas[i]=data.createFormula(meta.getFormula()[i].getFormula());
        }
 else {
          throw new KettleException("Unable to find field name for formula [" + Const.NVL(fn.getFormula(),"") + "]");
        }
      }
    }
    for (int i=0; i < meta.getFormula().length; i++) {
      FormulaMetaFunction fn=meta.getFormula()[i];
      if (!Const.isEmpty(fn.getFieldName())) {
        if (data.formulas[i] == null) {
          data.formulas[i]=data.createFormula(meta.getFormula()[i].getFormula());
        }
        Object formulaResult=data.formulas[i].evaluate();
        if (formulaResult instanceof LibFormulaErrorValue) {
          throw new KettleException("Error calculate formula. Formula " + fn.getFormula() + " output field: "+ fn.getFieldName()+ ", error is: "+ formulaResult.toString());
        }
        if (data.returnType[i] < 0) {
          if (formulaResult instanceof String) {
            data.returnType[i]=FormulaData.RETURN_TYPE_STRING;
            fn.setNeedDataConversion(fn.getValueType() != ValueMetaInterface.TYPE_STRING);
          }
 else           if (formulaResult instanceof Integer) {
            data.returnType[i]=FormulaData.RETURN_TYPE_INTEGER;
            fn.setNeedDataConversion(fn.getValueType() != ValueMetaInterface.TYPE_INTEGER);
          }
 else           if (formulaResult instanceof Long) {
            data.returnType[i]=FormulaData.RETURN_TYPE_LONG;
            fn.setNeedDataConversion(fn.getValueType() != ValueMetaInterface.TYPE_INTEGER);
          }
 else           if (formulaResult instanceof Date) {
            data.returnType[i]=FormulaData.RETURN_TYPE_DATE;
            fn.setNeedDataConversion(fn.getValueType() != ValueMetaInterface.TYPE_DATE);
          }
 else           if (formulaResult instanceof BigDecimal) {
            data.returnType[i]=FormulaData.RETURN_TYPE_BIGDECIMAL;
            fn.setNeedDataConversion(fn.getValueType() != ValueMetaInterface.TYPE_BIGNUMBER);
          }
 else           if (formulaResult instanceof Number) {
            data.returnType[i]=FormulaData.RETURN_TYPE_NUMBER;
            fn.setNeedDataConversion(fn.getValueType() != ValueMetaInterface.TYPE_NUMBER);
          }
 else           if (formulaResult instanceof byte[]) {
            data.returnType[i]=FormulaData.RETURN_TYPE_BYTE_ARRAY;
            if (fn.getValueType() != ValueMetaInterface.TYPE_BINARY) {
              throw new KettleValueException("Please specify a Binary type for field [" + fn.getFieldName() + "] as a result of formula ["+ fn.getFormula()+ "]");
            }
          }
 else           if (formulaResult instanceof Boolean) {
            data.returnType[i]=FormulaData.RETURN_TYPE_BOOLEAN;
            if (fn.getValueType() != ValueMetaInterface.TYPE_BOOLEAN) {
              throw new KettleValueException("Please specify a Boolean type for field [" + fn.getFieldName() + "] as a result of formula ["+ fn.getFormula()+ "]");
            }
          }
 else {
            data.returnType[i]=FormulaData.RETURN_TYPE_STRING;
          }
        }
        Object value=null;
        int realIndex=(data.replaceIndex[i] < 0) ? tempIndex++ : data.replaceIndex[i];
switch (data.returnType[i]) {
case FormulaData.RETURN_TYPE_STRING:
          if (formulaResult == null) {
            value=null;
          }
        if (fn.isNeedDataConversion()) {
          value=convertDataToTargetValueMeta(realIndex,formulaResult);
        }
 else {
          value=formulaResult.toString();
        }
      break;
case FormulaData.RETURN_TYPE_NUMBER:
    if (fn.isNeedDataConversion()) {
      value=convertDataToTargetValueMeta(realIndex,formulaResult);
    }
 else {
      value=new Double(((Number)formulaResult).doubleValue());
    }
  break;
case FormulaData.RETURN_TYPE_INTEGER:
if (fn.isNeedDataConversion()) {
  value=convertDataToTargetValueMeta(realIndex,formulaResult);
}
 else {
  value=new Long(((Integer)formulaResult).intValue());
}
break;
case FormulaData.RETURN_TYPE_LONG:
if (fn.isNeedDataConversion()) {
value=convertDataToTargetValueMeta(realIndex,formulaResult);
}
 else {
value=formulaResult;
}
break;
case FormulaData.RETURN_TYPE_DATE:
if (fn.isNeedDataConversion()) {
value=convertDataToTargetValueMeta(realIndex,formulaResult);
}
 else {
value=formulaResult;
}
break;
case FormulaData.RETURN_TYPE_BIGDECIMAL:
if (fn.isNeedDataConversion()) {
value=convertDataToTargetValueMeta(realIndex,formulaResult);
}
 else {
value=formulaResult;
}
break;
case FormulaData.RETURN_TYPE_BYTE_ARRAY:
value=formulaResult;
break;
case FormulaData.RETURN_TYPE_BOOLEAN:
value=formulaResult;
break;
}
outputRowData[realIndex]=value;
}
}
return outputRowData;
}
 catch (Throwable e) {
throw new KettleValueException(e);
}
}
