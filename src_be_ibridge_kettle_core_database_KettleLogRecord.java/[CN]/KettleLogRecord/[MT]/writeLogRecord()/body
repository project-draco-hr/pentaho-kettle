{
  Database ldb=new Database(logConnection);
  try {
    ldb.connect();
    String sql="";
    Row r=new Row();
    if (!status.equalsIgnoreCase("start") && batchIdUsed) {
      sql="UPDATE " + logTable + " SET STATUS=?, LINES_READ=?, LINES_WRITTEN=?, LINES_INPUT=?,"+ " LINES_OUTPUT=?, LINES_UPDATED=?, ERRORS=?, STARTDATE=?, ENDDATE=?, LOGDATE=?, DEPDATE=?";
      if (logString != null)       sql+=", LOG_FIELD=? ";
      sql+="WHERE ID_BATCH=?";
      r.addValue(new Value("STATUS",status));
      r.addValue(new Value("LINES_READ",(long)read));
      r.addValue(new Value("LINES_WRITTEN",(long)written));
      r.addValue(new Value("LINES_INPUT",(long)input));
      r.addValue(new Value("LINES_OUTPUT",(long)output));
      r.addValue(new Value("LINES_UPDATED",(long)updated));
      r.addValue(new Value("ERRORS",(long)errors));
      r.addValue(new Value("STARTDATE",startdate));
      r.addValue(new Value("ENDDATE",enddate));
      r.addValue(new Value("LOGDATE",logdate));
      r.addValue(new Value("DEPDATE",depdate));
      if (logString != null) {
        Value logfield=new Value("LOG_FIELD",logString);
        logfield.setLength(DatabaseMeta.CLOB_LENGTH);
        r.addValue(logfield);
      }
      r.addValue(new Value("ID_BATCH",batchId));
    }
 else {
      sql+="INSERT INTO " + logTable;
    }
  }
 catch (  Exception e) {
    throw new KettleException("Error writing log record to table [" + logTable + "]",e);
  }
 finally {
    ldb.disconnect();
  }
}
