{
  Long nextValue=null;
  String schemaTable=databaseMeta.getQuotedSchemaTableCombination(schemaName,tableName);
  String lookup=schemaTable + "." + databaseMeta.quoteField(val_key.getName());
  Counter counter=null;
  if (counters != null)   counter=(Counter)counters.get(lookup);
  if (counter == null) {
    RowMetaAndData rmad=getOneRow("SELECT MAX(" + databaseMeta.quoteField(val_key.getName()) + ") FROM "+ schemaTable);
    if (rmad != null) {
      long previous;
      try {
        previous=rmad.getRowMeta().getInteger(rmad.getData(),0).longValue();
      }
 catch (      KettleValueException e) {
        throw new KettleDatabaseException("Error getting the first long value from the max value returned from table : " + schemaTable);
      }
      counter=new Counter(previous + 1,1);
      nextValue=new Long(counter.next());
      if (counters != null)       counters.put(lookup,counter);
    }
 else {
      throw new KettleDatabaseException("Couldn't find maximum key value from table " + schemaTable);
    }
  }
 else {
    nextValue=new Long(counter.next());
  }
  return nextValue;
}
