{
  LogWriter log=LogWriter.getInstance();
  Result result=previousResult;
  result.setResult(false);
  long filesRetrieved=0;
  if (log.isDetailed())   log.logDetailed(toString(),"Start of SFTP job entry");
  SFTPClient sftpclient=null;
  String realServerName=environmentSubstitute(serverName);
  String realServerPort=environmentSubstitute(serverPort);
  String realUsername=environmentSubstitute(userName);
  String realPassword=environmentSubstitute(password);
  String realSftpDirString=environmentSubstitute(sftpDirectory);
  String realWildcard=environmentSubstitute(wildcard);
  String realTargetDirectory=environmentSubstitute(targetDirectory);
  try {
    sftpclient=new SFTPClient(InetAddress.getByName(realServerName),Const.toInt(realServerPort,22),realUsername);
    if (log.isDetailed())     log.logDetailed(toString(),Messages.getString("SFTP.Log.OpenedConnection",realServerName,realServerPort,realUsername));
    sftpclient.login(realPassword);
    if (!Const.isEmpty(realSftpDirString)) {
      sftpclient.chdir(realSftpDirString);
      if (log.isDetailed())       log.logDetailed(toString(),Messages.getString("SFTP.Log.ChangedDirectory",realSftpDirString));
    }
    String[] filelist=sftpclient.dir();
    if (log.isDetailed())     log.logDetailed(toString(),Messages.getString("SFTP.Log.Found","" + filelist.length));
    Pattern pattern=null;
    if (!Const.isEmpty(realWildcard)) {
      pattern=Pattern.compile(realWildcard);
    }
    for (int i=0; i < filelist.length && !parentJob.isStopped(); i++) {
      boolean getIt=true;
      if (pattern != null) {
        Matcher matcher=pattern.matcher(filelist[i]);
        getIt=matcher.matches();
      }
      if (getIt) {
        if (log.isDebug())         log.logDebug(toString(),Messages.getString("SFTP.Log.GettingFiles",filelist[i],realTargetDirectory));
        String targetFilename=realTargetDirectory + Const.FILE_SEPARATOR + filelist[i];
        sftpclient.get(targetFilename,filelist[i]);
        filesRetrieved++;
        ResultFile resultFile=new ResultFile(ResultFile.FILE_TYPE_GENERAL,KettleVFS.getFileObject(targetFilename),parentJob.getJobname(),toString());
        result.getResultFiles().put(resultFile.getFile().toString(),resultFile);
        if (log.isDetailed())         log.logDetailed(toString(),Messages.getString("SFTP.Log.TransferedFile",filelist[i]));
        if (remove) {
          sftpclient.delete(filelist[i]);
          if (log.isDetailed())           log.logDetailed(toString(),Messages.getString("SFTP.Log.DeletedFile",filelist[i]));
        }
      }
    }
    result.setResult(true);
    result.setNrFilesRetrieved(filesRetrieved);
  }
 catch (  Exception e) {
    result.setNrErrors(1);
    log.logError(toString(),Messages.getString("SFTP.Error.GettingFiles",e.getMessage()));
    log.logError(toString(),Const.getStackTracker(e));
  }
 finally {
    try {
      if (sftpclient != null)       sftpclient.disconnect();
    }
 catch (    Exception e) {
    }
  }
  return result;
}
