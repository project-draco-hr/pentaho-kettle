{
  if (monitor != null) {
    monitor.beginTask("Getting information from the database...",8);
  }
  Database db=new Database(dbInfo);
  try {
    if (monitor != null)     monitor.subTask("Connecting to database");
    db.connect();
    if (monitor != null)     monitor.worked(1);
    if (monitor != null && monitor.isCanceled())     return;
    if (monitor != null)     monitor.subTask("Getting database metadata");
    DatabaseMetaData dbmd=db.getDatabaseMetaData();
    if (monitor != null)     monitor.worked(1);
    if (monitor != null && monitor.isCanceled())     return;
    if (monitor != null)     monitor.subTask("Getting catalog information");
    if (dbInfo.supportsCatalogs() && dbmd.supportsCatalogsInTableDefinitions()) {
      ArrayList<Catalog> catalogList=new ArrayList<Catalog>();
      ResultSet catalogResultSet=dbmd.getCatalogs();
      while (catalogResultSet != null && catalogResultSet.next()) {
        String catalogName=catalogResultSet.getString(1);
        catalogList.add(new Catalog(catalogName));
      }
      catalogResultSet.close();
      for (      Catalog catalog : catalogList) {
        ArrayList<String> catalogTables=new ArrayList<String>();
        try {
          ResultSet catalogTablesResultSet=dbmd.getTables(catalog.getCatalogName(),null,null,null);
          while (catalogTablesResultSet.next()) {
            String tableName=catalogTablesResultSet.getString(3);
            if (!db.isSystemTable(tableName)) {
              catalogTables.add(tableName);
            }
          }
          catalogTablesResultSet.close();
          Collections.sort(catalogTables);
        }
 catch (        Exception e) {
          LogWriter.getInstance().logError(getClass().getName(),"Unexpected error getting catalog information",e);
        }
        catalog.setItems(catalogTables.toArray(new String[catalogTables.size()]));
      }
      setCatalogs(catalogList.toArray(new Catalog[catalogList.size()]));
    }
    if (monitor != null)     monitor.worked(1);
    if (monitor != null && monitor.isCanceled())     return;
    if (monitor != null)     monitor.subTask("Getting schema information");
    if (dbInfo.supportsSchemas() && dbmd.supportsSchemasInTableDefinitions()) {
      ArrayList<Schema> schemaList=new ArrayList<Schema>();
      try {
        ResultSet schemaResultSet=dbmd.getSchemas();
        while (schemaResultSet != null && schemaResultSet.next()) {
          String schemaName=schemaResultSet.getString(1);
          schemaList.add(new Schema(schemaName));
        }
        schemaResultSet.close();
        for (        Schema schema : schemaList) {
          ArrayList<String> schemaTables=new ArrayList<String>();
          try {
            ResultSet schemaTablesResultSet=dbmd.getTables(null,schema.getSchemaName(),null,null);
            while (schemaTablesResultSet.next()) {
              String tableName=schemaTablesResultSet.getString(3);
              if (!db.isSystemTable(tableName)) {
                schemaTables.add(tableName);
              }
            }
            schemaTablesResultSet.close();
            Collections.sort(schemaTables);
          }
 catch (          Exception e) {
          }
          schema.setItems(schemaTables.toArray(new String[schemaTables.size()]));
        }
      }
 catch (      Exception e) {
        LogWriter.getInstance().logError(getClass().getName(),"Unexpected error getting schema information",e);
      }
      setSchemas(schemaList.toArray(new Schema[schemaList.size()]));
    }
    if (monitor != null)     monitor.worked(1);
    if (monitor != null && monitor.isCanceled())     return;
    if (monitor != null)     monitor.subTask("Getting tables");
    setTables(db.getTablenames());
    if (monitor != null)     monitor.worked(1);
    if (monitor != null && monitor.isCanceled())     return;
    if (monitor != null)     monitor.subTask("Getting views");
    if (dbInfo.supportsViews()) {
      setViews(db.getViews());
    }
    if (monitor != null)     monitor.worked(1);
    if (monitor != null && monitor.isCanceled())     return;
    if (monitor != null)     monitor.subTask("Getting synonyms");
    if (dbInfo.supportsSynonyms()) {
      setSynonyms(db.getSynonyms());
    }
    if (monitor != null)     monitor.worked(1);
  }
 catch (  Exception e) {
    throw new KettleDatabaseException("Unable to retrieve database information because of an error",e);
  }
 finally {
    if (monitor != null)     monitor.subTask("Closing database connection");
    db.disconnect();
    if (monitor != null)     monitor.worked(1);
  }
  if (monitor != null)   monitor.done();
}
