{
  try {
    if (data.sfBuffer.length > data.iBufferPos) {
      SObject[] smallBuffer=new SObject[data.iBufferPos];
      System.arraycopy(data.sfBuffer,0,smallBuffer,0,data.iBufferPos);
      data.sfBuffer=smallBuffer;
    }
    data.upsertResult=data.connection.upsert(meta.getUpsertField(),data.sfBuffer);
    int nr=data.upsertResult.length;
    for (int j=0; j < nr; j++) {
      if (data.upsertResult[j].isSuccess()) {
        String id=data.upsertResult[j].getId();
        if (data.upsertResult[j].isCreated()) {
          incrementLinesOutput();
          if (log.isDetailed()) {
            logDetailed(BaseMessages.getString(PKG,"SalesforceUpsert.ObjectCreated",id));
          }
        }
 else {
          incrementLinesUpdated();
          if (log.isDetailed()) {
            logDetailed(BaseMessages.getString(PKG,"SalesforceUpsert.ObjectUpdated",id));
          }
        }
        Object[] newRow=RowDataUtil.resizeArray(data.outputBuffer[j],data.outputRowMeta.size());
        if (data.realSalesforceFieldName != null) {
          int newIndex=data.inputRowMeta.size();
          newRow[newIndex++]=id;
        }
        if (log.isDetailed()) {
          logDetailed(BaseMessages.getString(PKG,"SalesforceUpsert.NewRow",newRow[0]));
        }
        putRow(data.outputRowMeta,newRow);
        if (checkFeedback(getLinesInput())) {
          if (log.isDetailed()) {
            logDetailed(BaseMessages.getString(PKG,"SalesforceUpsert.log.LineRow","" + getLinesInput()));
          }
        }
      }
 else {
        if (!getStepMeta().isDoingErrorHandling()) {
          if (log.isDetailed()) {
            logDetailed(BaseMessages.getString(PKG,"SalesforceUpsert.ErrorFound"));
          }
          com.sforce.soap.partner.Error err=data.upsertResult[j].getErrors()[0];
          throw new KettleException(BaseMessages.getString(PKG,"SalesforceUpsert.Error.FlushBuffer",new Integer(j),err.getStatusCode(),err.getMessage()));
        }
        String errorMessage="";
        for (int i=0; i < data.upsertResult[j].getErrors().length; i++) {
          com.sforce.soap.partner.Error err=data.upsertResult[j].getErrors()[i];
          errorMessage+=BaseMessages.getString(PKG,"SalesforceUpsert.Error.FlushBuffer",new Integer(j),err.getStatusCode(),err.getMessage());
        }
        if (log.isDebug()) {
          logDebug(BaseMessages.getString(PKG,"SalesforceUpsert.PassingRowToErrorStep"));
        }
        putError(getInputRowMeta(),data.outputBuffer[j],1,errorMessage,null,"SalesforceUpsert001");
      }
    }
    data.sfBuffer=new SObject[meta.getBatchSizeInt()];
    data.outputBuffer=new Object[meta.getBatchSizeInt()][];
    data.iBufferPos=0;
  }
 catch (  Exception e) {
    if (!getStepMeta().isDoingErrorHandling()) {
      if (e instanceof KettleException) {
        throw (KettleException)e;
      }
 else {
        throw new KettleException(BaseMessages.getString(PKG,"SalesforceUpsert.FailedUpsert",e.getMessage()),e);
      }
    }
    if (log.isDebug()) {
      logDebug("Passing row to error step");
    }
    for (int i=0; i < data.iBufferPos; i++) {
      putError(data.inputRowMeta,data.outputBuffer[i],1,e.getMessage(),null,"SalesforceUpsert002");
    }
  }
 finally {
    if (data.upsertResult != null) {
      data.upsertResult=null;
    }
  }
}
