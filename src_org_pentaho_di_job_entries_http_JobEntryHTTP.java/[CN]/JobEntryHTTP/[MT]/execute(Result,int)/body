{
  LogWriter log=LogWriter.getInstance();
  Result result=previousResult;
  result.setResult(false);
  logBasic("Start of HTTP job entry.");
  List<RowMetaAndData> resultRows;
  String urlFieldnameToUse;
  if (Const.isEmpty(urlFieldname))   urlFieldnameToUse=URL_FIELDNAME;
 else   urlFieldnameToUse=urlFieldname;
  if (runForEveryRow) {
    resultRows=previousResult.getRows();
    if (resultRows == null) {
      result.setNrErrors(1);
      logError("Unable to get result from previous job entry : can't continue.");
      return result;
    }
  }
 else {
    resultRows=new ArrayList<RowMetaAndData>();
    RowMetaAndData row=new RowMetaAndData();
    row.addValue(new ValueMeta(urlFieldnameToUse,ValueMetaInterface.TYPE_STRING),environmentSubstitute(url));
    resultRows.add(row);
    System.out.println("Added one row to rows: " + row);
  }
  URL server=null;
  String beforeProxyHost=System.getProperty("http.proxyHost");
  String beforeProxyPort=System.getProperty("http.proxyPort");
  String beforeNonProxyHosts=System.getProperty("http.nonProxyHosts");
  for (int i=0; i < resultRows.size() && result.getNrErrors() == 0; i++) {
    RowMetaAndData row=(RowMetaAndData)resultRows.get(i);
    OutputStream outputFile=null;
    OutputStream uploadStream=null;
    BufferedInputStream fileStream=null;
    InputStream input=null;
    try {
      String urlToUse=environmentSubstitute(row.getString(urlFieldnameToUse,""));
      logBasic("Connecting to URL: " + urlToUse);
      if (!Const.isEmpty(proxyHostname)) {
        System.setProperty("http.proxyHost",environmentSubstitute(proxyHostname));
        System.setProperty("http.proxyPort",environmentSubstitute(proxyPort));
        if (nonProxyHosts != null)         System.setProperty("http.nonProxyHosts",environmentSubstitute(nonProxyHosts));
      }
      if (!Const.isEmpty(username)) {
        Authenticator.setDefault(new Authenticator(){
          protected PasswordAuthentication getPasswordAuthentication(){
            String realPassword=environmentSubstitute(password);
            return new PasswordAuthentication(environmentSubstitute(username),realPassword != null ? realPassword.toCharArray() : new char[]{});
          }
        }
);
      }
      String realTargetFile=environmentSubstitute(targetFilename);
      if (dateTimeAdded) {
        SimpleDateFormat daf=new SimpleDateFormat();
        Date now=new Date();
        daf.applyPattern("yyyMMdd");
        realTargetFile+="_" + daf.format(now);
        daf.applyPattern("HHmmss");
        realTargetFile+="_" + daf.format(now);
        if (!Const.isEmpty(targetFilenameExtention)) {
          realTargetFile+="." + environmentSubstitute(targetFilenameExtention);
        }
      }
      outputFile=KettleVFS.getOutputStream(realTargetFile,fileAppended);
      server=new URL(urlToUse);
      URLConnection connection=server.openConnection();
      String realUploadFilename=environmentSubstitute(uploadFilename);
      if (!Const.isEmpty(realUploadFilename)) {
        if (log.isDetailed())         logDetailed("Start sending content of file [" + realUploadFilename + "] to server.");
        connection.setDoOutput(true);
        uploadStream=connection.getOutputStream();
        fileStream=new BufferedInputStream(new FileInputStream(new File(realUploadFilename)));
        int c;
        while ((c=fileStream.read()) >= 0) {
          uploadStream.write(c);
        }
        uploadStream.close();
        uploadStream=null;
        fileStream.close();
        fileStream=null;
        if (log.isDetailed())         logDetailed("Finished sending content to server.");
      }
      if (log.isDetailed())       logDetailed("Start reading reply from webserver.");
      input=server.openStream();
      Date date=new Date(connection.getLastModified());
      logBasic("Resource type: \"" + connection.getContentType() + "\", last modified on: \""+ date+ "\".");
      int oneChar;
      long bytesRead=0L;
      while ((oneChar=input.read()) != -1) {
        outputFile.write(oneChar);
        bytesRead++;
      }
      logBasic("Finished writing " + bytesRead + " bytes to result file ["+ realTargetFile+ "]");
      ResultFile resultFile=new ResultFile(ResultFile.FILE_TYPE_GENERAL,KettleVFS.getFileObject(realTargetFile),parentJob.getJobname(),toString());
      result.getResultFiles().put(resultFile.getFile().toString(),resultFile);
      result.setResult(true);
    }
 catch (    MalformedURLException e) {
      result.setNrErrors(1);
      logError("The specified URL is not valid [" + url + "] : "+ e.getMessage());
      logError(Const.getStackTracker(e));
    }
catch (    IOException e) {
      result.setNrErrors(1);
      logError("I was unable to save the HTTP result to file because of a I/O error: " + e.getMessage());
      logError(Const.getStackTracker(e));
    }
catch (    Exception e) {
      result.setNrErrors(1);
      logError("Error getting file from HTTP : " + e.getMessage());
      logError(Const.getStackTracker(e));
    }
 finally {
      try {
        if (uploadStream != null)         uploadStream.close();
        if (fileStream != null)         fileStream.close();
        if (input != null)         input.close();
        if (outputFile != null)         outputFile.close();
      }
 catch (      Exception e) {
        logError("Unable to close streams : " + e.getMessage());
        result.setNrErrors(1);
      }
      System.setProperty("http.proxyHost",Const.NVL(beforeProxyHost,""));
      System.setProperty("http.proxyPort",Const.NVL(beforeProxyPort,""));
      System.setProperty("http.nonProxyHosts",Const.NVL(beforeNonProxyHosts,""));
    }
  }
  return result;
}
