{
  Object[] outputRow=new Object[data.outputRowMeta.size()];
  for (int i=0; i < inputRowMeta.size(); i++) {
    outputRow[i]=row[i];
  }
  Object[] lookupRow=new Object[data.lookupMeta.size()];
  int lookupIndex=0;
  for (int i=0; i < meta.getStreamKeyField1().length; i++) {
    if (data.keynrs[i] >= 0) {
      ValueMetaInterface input=inputRowMeta.getValueMeta(data.keynrs[i]);
      ValueMetaInterface value=data.lookupMeta.getValueMeta(lookupIndex);
      lookupRow[lookupIndex]=row[data.keynrs[i]];
      if (value.getType() != data.keytypes[i]) {
        lookupRow[lookupIndex]=value.convertData(input,lookupRow[lookupIndex]);
      }
      lookupIndex++;
    }
    if (data.keynrs2[i] >= 0) {
      ValueMetaInterface input=inputRowMeta.getValueMeta(data.keynrs2[i]);
      ValueMetaInterface value=data.lookupMeta.getValueMeta(lookupIndex);
      lookupRow[lookupIndex]=row[data.keynrs2[i]];
      if (value.getType() != data.keytypes[i]) {
        lookupRow[lookupIndex]=value.convertData(input,lookupRow[lookupIndex]);
      }
      lookupIndex++;
    }
  }
  Object[] add=null;
  boolean cache_now=false;
  if (meta.isCached()) {
    TimedRow timedRow=(TimedRow)data.look.get(new RowMetaAndData(data.lookupMeta,lookupRow));
    if (timedRow != null) {
      add=timedRow.getRow();
    }
  }
 else   add=null;
  if (add == null) {
    if (log.isRowLevel())     logRowlevel(Messages.getString("DatabaseLookup.Log.AddedValuesToLookupRow1") + meta.getStreamKeyField1().length + Messages.getString("DatabaseLookup.Log.AddedValuesToLookupRow2")+ data.lookupMeta.getString(lookupRow));
    data.db.setValuesLookup(data.lookupMeta,lookupRow);
    add=data.db.getLookup(meta.isFailingOnMultipleResults());
    cache_now=true;
  }
  if (add == null) {
    if (meta.isEatingRowOnLookupFailure()) {
      return null;
    }
    if (getStepMeta().isDoingErrorHandling()) {
      putError(getInputRowMeta(),row,1L,"No lookup found",null,"DBL001");
      return null;
    }
    if (log.isRowLevel())     logRowlevel(Messages.getString("DatabaseLookup.Log.NoResultsFoundAfterLookup"));
    add=new Object[data.returnMeta.size()];
    for (int i=0; i < meta.getReturnValueField().length; i++) {
      if (data.nullif[i] != null) {
        add[i]=data.nullif[i];
      }
 else {
        add[i]=null;
      }
    }
  }
 else {
    if (log.isRowLevel())     logRowlevel(Messages.getString("DatabaseLookup.Log.FoundResultsAfterLookup") + add);
    int types[]=meta.getReturnValueDefaultType();
    for (int i=0; i < types.length; i++) {
      ValueMetaInterface returned=data.db.getReturnRowMeta().getValueMeta(i);
      ValueMetaInterface expected=data.returnMeta.getValueMeta(i);
      if (returned != null && types[i] > 0 && types[i] != returned.getType()) {
        add[i]=expected.convertData(returned,add[i]);
      }
    }
  }
  if (meta.isCached() && cache_now) {
    data.look.put(new RowMetaAndData(data.lookupMeta,lookupRow),new TimedRow(add));
    if (meta.getCacheSize() > 0 && data.look.size() > meta.getCacheSize()) {
      List<RowMetaAndData> keys=new ArrayList<RowMetaAndData>(data.look.keySet());
      List<Date> samples=new ArrayList<Date>();
      int incr=keys.size() / 10;
      if (incr == 0)       incr=1;
      for (int k=0; k < keys.size(); k+=incr) {
        RowMetaAndData key=(RowMetaAndData)keys.get(k);
        TimedRow timedRow=(TimedRow)data.look.get(key);
        samples.add(timedRow.getLogDate());
      }
      Collections.sort(samples);
      if (samples.size() > 1) {
        Date smallest=(Date)samples.get(1);
        for (int k=0; k < keys.size(); k++) {
          RowMetaAndData key=(RowMetaAndData)keys.get(k);
          TimedRow timedRow=(TimedRow)data.look.get(key);
          if (timedRow.getLogDate().compareTo(smallest) < 0) {
            data.look.remove(key);
          }
        }
      }
    }
  }
  for (int i=0; i < add.length; i++) {
    outputRow[inputRowMeta.size() + i]=add[i];
  }
  return outputRow;
}
