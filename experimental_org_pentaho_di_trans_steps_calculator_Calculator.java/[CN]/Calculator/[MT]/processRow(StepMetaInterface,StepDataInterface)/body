{
  meta=(CalculatorMeta)smi;
  data=(CalculatorData)sdi;
  Object[] r=getRow();
  if (r == null) {
    setOutputDone();
    return false;
  }
  if (first) {
    first=false;
    data.outputRowMeta=(RowMetaInterface)getInputRowMeta().clone();
    meta.getFields(data.outputRowMeta,getStepname(),null);
    data.calcRowMeta=meta.getAllFields(getInputRowMeta());
    data.fieldIndexes=new FieldIndexes[meta.getCalculation().length];
    List tempIndexes=new ArrayList();
    for (int i=0; i < meta.getCalculation().length; i++) {
      CalculatorMetaFunction function=meta.getCalculation()[i];
      data.fieldIndexes[i]=new FieldIndexes();
      if (!Const.isEmpty(function.getFieldName())) {
        data.fieldIndexes[i].indexName=data.outputRowMeta.indexOfValue(function.getFieldName());
        if (data.fieldIndexes[i].indexName < 0) {
          data.fieldIndexes[i].indexName=data.tempRowMeta.indexOfValue(function.getFieldName());
          if (data.fieldIndexes[i].indexName < 0) {
            throw new KettleStepException("Unable to find the specified fieldname '" + function.getFieldName() + " for calculation #"+ (i + 1));
          }
        }
      }
 else {
        throw new KettleStepException("There is no name specified for calculated field #" + (i + 1));
      }
      if (!Const.isEmpty(function.getFieldA())) {
        data.fieldIndexes[i].indexA=data.outputRowMeta.indexOfValue(function.getFieldA());
        if (data.fieldIndexes[i].indexA < 0) {
          data.fieldIndexes[i].indexA=data.tempRowMeta.indexOfValue(function.getFieldA());
          if (data.fieldIndexes[i].indexA < 0) {
            throw new KettleStepException("Unable to find the first argument field '" + function.getFieldName() + " for calculation #"+ (i + 1));
          }
        }
      }
 else {
        throw new KettleStepException("There is no first argument specified for calculated field #" + (i + 1));
      }
      if (!Const.isEmpty(function.getFieldB())) {
        data.fieldIndexes[i].indexB=data.outputRowMeta.indexOfValue(function.getFieldB());
        if (data.fieldIndexes[i].indexB < 0) {
          data.fieldIndexes[i].indexB=data.tempRowMeta.indexOfValue(function.getFieldB());
          if (data.fieldIndexes[i].indexB < 0) {
            throw new KettleStepException("Unable to find the second argument field '" + function.getFieldName() + " for calculation #"+ (i + 1));
          }
        }
      }
      if (!Const.isEmpty(function.getFieldC())) {
        data.fieldIndexes[i].indexC=data.outputRowMeta.indexOfValue(function.getFieldC());
        if (data.fieldIndexes[i].indexC < 0) {
          data.fieldIndexes[i].indexC=data.tempRowMeta.indexOfValue(function.getFieldC());
          if (data.fieldIndexes[i].indexC < 0) {
            throw new KettleStepException("Unable to find the third argument field '" + function.getFieldName() + " for calculation #"+ (i + 1));
          }
        }
      }
      if (function.isRemovedFromResult()) {
        tempIndexes.add(new Integer(getInputRowMeta().size() + i));
      }
    }
    data.tempIndexes=new int[tempIndexes.size()];
    for (int i=0; i < data.tempIndexes.length; i++) {
      data.tempIndexes[i]=((Integer)tempIndexes.get(i)).intValue();
    }
  }
  if (log.isRowLevel())   log.logRowlevel(toString(),"Read row #" + linesRead + " : "+ r);
  Object[] row=calcFields(getInputRowMeta(),data.outputRowMeta,r);
  putRow(data.outputRowMeta,row);
  if (log.isRowLevel())   log.logRowlevel(toString(),"Wrote row #" + linesWritten + " : "+ r);
  if (checkFeedback(linesRead))   logBasic("Linenr " + linesRead);
  return true;
}
