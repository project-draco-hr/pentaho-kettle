{
  if (!request.getContextPath().equals(CONTEXT_PATH))   return;
  if (!isStarted())   return;
  if (log.isDebug())   log.logDebug(toString(),"Uploading Kettle transformation...");
  ByteArrayOutputStream buf=new ByteArrayOutputStream(2048);
  PrintWriter writer=new PrintWriter(new OutputStreamWriter(buf));
  response.setContentType("text/html");
  File file=null;
  try {
    file=getTransformationFile(request);
    Document doc=XMLHandler.loadXMLFile(file);
    Node transNode=XMLHandler.getSubNode(doc,"transformation");
    TransMeta transMeta=new TransMeta(transNode);
    Trans trans=new Trans(log,transMeta);
    transformationMap.addTransformation(trans.getName(),trans,new TransConfiguration(trans.getTransMeta(),new TransExecutionConfiguration()));
    response.setContentType("text/html");
    writer.write("<html><title>Uploaded a Kettle transformation</title>");
    writer.write("<body>");
    writer.write("<h1>Uploaded of the Kettle transformation was succesful.</h1>");
    writer.write("<p><a href=\"/kettle/status\">Back to the status page</a><p>");
    writer.write("</body>");
    writer.write("</html>");
  }
 catch (  Exception e) {
    log.logError(toString(),"The uploading of a transformation failed:" + e.toString());
    log.logError(toString(),Const.getStackTracker(e));
    response.setContentType("text/html");
    writer.write("<html><title>Uploaded of Kettle transformation failed</title>");
    writer.write("<body>");
    writer.write("<h1>The upload of the Kettle transformation failed!</h1>");
    writer.write("<pre>");
    writer.write(Const.getStackTracker(e));
    writer.write("</pre>");
    writer.write("<p><a href=\"/kettle/status\">Back to the status page</a><p>");
    writer.write("</body>");
    writer.write("</html>");
  }
  writer.flush();
  OutputStream out=response.getOutputStream();
  buf.writeTo(out);
  Request baseRequest=(request instanceof Request) ? (Request)request : HttpConnection.getCurrentConnection().getRequest();
  baseRequest.setHandled(true);
}
