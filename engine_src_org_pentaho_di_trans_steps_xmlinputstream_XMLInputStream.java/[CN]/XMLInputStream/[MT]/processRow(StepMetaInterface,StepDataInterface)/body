{
  if (first) {
    first=false;
    data.filename=this.environmentSubstitute(meta.getFilename());
    data.nrRowsToSkip=Const.toLong(this.environmentSubstitute(meta.getNrRowsToSkip()),0);
    data.rowLimit=Const.toLong(this.environmentSubstitute(meta.getRowLimit()),0);
    data.encoding=this.environmentSubstitute(meta.getEncoding());
    data.outputRowMeta=new RowMeta();
    meta.getFields(data.outputRowMeta,getStepname(),null,null,this);
    data.pos_xml_filename=data.outputRowMeta.indexOfValue(meta.getFilenameField());
    data.pos_xml_row_number=data.outputRowMeta.indexOfValue(meta.getRowNumberField());
    data.pos_xml_data_type_numeric=data.outputRowMeta.indexOfValue(meta.getXmlDataTypeNumericField());
    data.pos_xml_data_type_description=data.outputRowMeta.indexOfValue(meta.getXmlDataTypeDescriptionField());
    data.pos_xml_location_line=data.outputRowMeta.indexOfValue(meta.getXmlLocationLineField());
    data.pos_xml_location_column=data.outputRowMeta.indexOfValue(meta.getXmlLocationColumnField());
    data.pos_xml_element_id=data.outputRowMeta.indexOfValue(meta.getXmlElementIDField());
    data.pos_xml_parent_element_id=data.outputRowMeta.indexOfValue(meta.getXmlParentElementIDField());
    data.pos_xml_element_level=data.outputRowMeta.indexOfValue(meta.getXmlElementLevelField());
    data.pos_xml_path=data.outputRowMeta.indexOfValue(meta.getXmlPathField());
    data.pos_xml_parent_path=data.outputRowMeta.indexOfValue(meta.getXmlParentPathField());
    data.pos_xml_data_name=data.outputRowMeta.indexOfValue(meta.getXmlDataNameField());
    data.pos_xml_data_value=data.outputRowMeta.indexOfValue(meta.getXmlDataValueField());
    data.fileObject=KettleVFS.getFileObject(data.filename,getTransMeta());
    try {
      data.inputStream=KettleVFS.getInputStream(data.fileObject);
    }
 catch (    IOException e) {
      throw new KettleException(e);
    }
    try {
      data.xmlEventReader=data.staxInstance.createXMLEventReader(data.inputStream,data.encoding);
    }
 catch (    XMLStreamException e) {
      throw new KettleException(e);
    }
    if (meta.isAddResultFile()) {
      ResultFile resultFile=new ResultFile(ResultFile.FILE_TYPE_GENERAL,data.fileObject,getTransMeta().getName(),getStepname());
      resultFile.setComment("File was read by an XML Input Stream step");
      addResultFile(resultFile);
    }
    resetElementCounters();
  }
  Object[] outputRowData=getRowFromXML();
  if (outputRowData == null) {
    setOutputDone();
    return false;
  }
  putRowOut(outputRowData);
  if (data.rowLimit > 0 && data.rowNumber >= data.rowLimit) {
    setOutputDone();
    return false;
  }
  return true;
}
