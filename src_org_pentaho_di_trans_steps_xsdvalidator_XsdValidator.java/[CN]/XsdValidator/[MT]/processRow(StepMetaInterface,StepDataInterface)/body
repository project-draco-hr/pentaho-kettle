{
  meta=(XsdValidatorMeta)smi;
  data=(XsdValidatorData)sdi;
  Object[] row=getRow();
  if (row == null) {
    setOutputDone();
    return false;
  }
  if (first) {
    first=false;
    data.outputRowMeta=getInputRowMeta().clone();
    meta.getFields(data.outputRowMeta,getStepname(),null,null,this);
    if (meta.getXMLStream() != null) {
      data.xmlindex=getInputRowMeta().indexOfValue(meta.getXMLStream());
      if (data.xmlindex < 0) {
        logError(Messages.getString("XsdValidator.Log.ErrorFindingField") + "[" + meta.getXMLStream()+ "]");
        throw new KettleStepException(Messages.getString("XsdValidator.Exception.CouldnotFindField",meta.getXMLStream()));
      }
      if (meta.getResultfieldname() == null) {
        logError(Messages.getString("XsdValidator.Log.ErrorResultFieldMissing"));
        throw new KettleStepException(Messages.getString("XsdValidator.Exception.ErrorResultFieldMissing"));
      }
      if (meta.getXSDSource().equals(meta.SPECIFY_FILENAME)) {
        if (meta.getXSDFilename() == null) {
          logError(Messages.getString("XsdValidator.Log.ErrorXSDFileMissing"));
          throw new KettleStepException(Messages.getString("XsdValidator.Exception.ErrorXSDFileMissing"));
        }
 else {
          FileObject xsdfile=null;
          try {
            xsdfile=KettleVFS.getFileObject(environmentSubstitute(meta.getXSDFilename()));
            if (!xsdfile.exists()) {
              logError(Messages.getString("XsdValidator.Log.Error.XSDFileNotExists"));
              throw new KettleStepException(Messages.getString("XsdValidator.Exception.XSDFileNotExists"));
            }
          }
 catch (          Exception e) {
            logError(Messages.getString("XsdValidator.Log.Error.GettingXSDFile"));
            throw new KettleStepException(Messages.getString("XsdValidator.Exception.GettingXSDFile"));
          }
 finally {
            try {
              if (xsdfile != null)               xsdfile.close();
            }
 catch (            IOException e) {
            }
          }
        }
      }
      if (meta.getXSDSource().equals(meta.SPECIFY_FIELDNAME)) {
        if (meta.getXSDDefinedField() == null) {
          logError(Messages.getString("XsdValidator.Log.Error.XSDFieldMissing"));
          throw new KettleStepException(Messages.getString("XsdValidator.Exception.XSDFieldMissing"));
        }
 else {
          data.xsdindex=getInputRowMeta().indexOfValue(meta.getXSDDefinedField());
          if (data.xsdindex < 0) {
            logError(Messages.getString("XsdValidator.Log.ErrorFindingXSDField",meta.getXSDDefinedField()));
            throw new KettleStepException(Messages.getString("XsdValidator.Exception.ErrorFindingXSDField",meta.getXSDDefinedField()));
          }
        }
      }
    }
 else {
      logError(Messages.getString("XsdValidator.Log.Error.XmlStreamFieldMissing"));
      throw new KettleStepException(Messages.getString("XsdValidator.Exception.XmlStreamFieldMissing"));
    }
  }
  boolean sendToErrorRow=false;
  String errorMessage=null;
  try {
    String XMLFieldvalue=getInputRowMeta().getString(row,data.xmlindex);
    boolean isvalid=false;
    String xsdfilename=null;
    if (meta.getXSDSource().equals(meta.SPECIFY_FILENAME)) {
      xsdfilename=environmentSubstitute(meta.getXSDFilename());
    }
 else     if (meta.getXSDSource().equals(meta.SPECIFY_FIELDNAME)) {
      xsdfilename=getInputRowMeta().getString(row,data.xsdindex);
    }
    FileObject xsdfile=null;
    String validationmsg=null;
    try {
      SchemaFactory factoryXSDValidator=SchemaFactory.newInstance(XMLConstants.W3C_XML_SCHEMA_NS_URI);
      xsdfile=KettleVFS.getFileObject(xsdfilename);
      File XSDFile=new File(KettleVFS.getFilename(xsdfile));
      Source sourceXML=new StreamSource(new StringReader(XMLFieldvalue));
      if (meta.getXMLSourceFile()) {
        File xmlfileValidator=new File(XMLFieldvalue);
        if (!xmlfileValidator.exists()) {
          logError(Messages.getString("XsdValidator.Log.Error.XMLfileMissing",XMLFieldvalue));
          throw new KettleStepException(Messages.getString("XsdValidator.Exception.XMLfileMissing",XMLFieldvalue));
        }
        sourceXML=new StreamSource(xmlfileValidator);
      }
      Schema SchematXSD=factoryXSDValidator.newSchema(XSDFile);
      if (meta.getXSDSource().equals(meta.NO_NEED)) {
        SchematXSD=factoryXSDValidator.newSchema();
      }
      Validator XSDValidator=SchematXSD.newValidator();
      XSDValidator.validate(sourceXML);
      isvalid=true;
    }
 catch (    SAXException ex) {
      validationmsg=ex.getMessage();
      logError("SAX Exception : " + ex);
    }
catch (    IOException ex) {
      validationmsg=ex.getMessage();
      logError("SAX Exception : " + ex);
    }
 finally {
      try {
        if (xsdfile != null)         xsdfile.close();
      }
 catch (      IOException e) {
      }
    }
    Object[] outputRowData=null;
    Object[] outputRowData2=null;
    if (meta.getOutputStringField()) {
      if (isvalid)       outputRowData=RowDataUtil.addValueData(row,getInputRowMeta().size(),environmentSubstitute(meta.getIfXmlValid()));
 else       outputRowData=RowDataUtil.addValueData(row,getInputRowMeta().size(),environmentSubstitute(meta.getIfXmlInvalid()));
    }
 else {
      outputRowData=RowDataUtil.addValueData(row,getInputRowMeta().size(),isvalid);
    }
    if (meta.useAddValidationMessage())     outputRowData2=RowDataUtil.addValueData(outputRowData,getInputRowMeta().size() + 1,validationmsg);
 else     outputRowData2=outputRowData;
    if (log.isRowLevel())     logRowlevel(Messages.getString("XsdValidator.Log.ReadRow") + " " + getInputRowMeta().getString(row));
    putRow(data.outputRowMeta,outputRowData2);
  }
 catch (  KettleException e) {
    if (getStepMeta().isDoingErrorHandling()) {
      sendToErrorRow=true;
      errorMessage=e.toString();
    }
    if (sendToErrorRow) {
      putError(getInputRowMeta(),row,1,errorMessage,null,"XSD001");
    }
 else {
      logError(Messages.getString("XsdValidator.ErrorProcesing") + e.getMessage());
      setErrors(1);
      stopAll();
      setOutputDone();
      return false;
    }
  }
  return true;
}
