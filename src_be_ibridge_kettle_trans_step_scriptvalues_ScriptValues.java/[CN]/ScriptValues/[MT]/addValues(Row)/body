{
  if (first) {
    determineUsedFields(row);
    debug="first row";
    data.cx=Context.enter();
    data.scope=data.cx.initStandardObjects(null);
    first=false;
    Scriptable jsvalue=Context.toObject(this,data.scope);
    data.scope.put("_step_",data.scope,jsvalue);
    Scriptable jsvars=Context.toObject(KettleVariables.getInstance(),data.scope);
    data.scope.put("KETTLE_VARS",data.scope,jsvars);
    try {
      debug="compile reader";
      data.script=data.cx.compileString(meta.getScript(),"script",1,null);
    }
 catch (    Exception e) {
      logError(Messages.getString("ScriptValues.Log.CouldNotCompileJavascript") + e.toString());
      setErrors(1);
      stopAll();
      return false;
    }
  }
  Scriptable jsrow=Context.toObject(row,data.scope);
  data.scope.put("row",data.scope,jsrow);
  for (int i=0; i < data.fields_used.length; i++) {
    Value val=row.getValue(data.fields_used[i]);
    Scriptable jsarg=Context.toObject(val,data.scope);
    data.scope.put(val.getName(),data.scope,jsarg);
  }
  try {
    debug="exec";
    data.script.exec(data.cx,data.scope);
    StringBuffer message=new StringBuffer();
    for (int i=0; i < meta.getName().length; i++) {
      Value res=new Value();
      if (meta.getValue(data.scope,i,res,message)) {
        logError(message.toString());
        setErrors(1);
        stopAll();
        return false;
      }
      row.addValue(res);
    }
  }
 catch (  JavaScriptException jse) {
    logError(Messages.getString("ScriptValues.Log.JavascriptError") + jse.toString());
    logError(Messages.getString("ScriptValues.Log.ErrorStackTrace") + Const.CR + Const.getStackTracker(jse));
    setErrors(1);
    stopAll();
    return false;
  }
catch (  Exception e) {
    logError(Messages.getString("ScriptValues.Log.JavascriptError") + e.toString());
    logError(Messages.getString("ScriptValues.Log.ErrorStackTrace") + Const.CR + Const.getStackTracker(e));
    setErrors(1);
    stopAll();
    return false;
  }
  return true;
}
