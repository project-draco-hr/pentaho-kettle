{
  if (preview)   return true;
  Result result=getResult();
  logDate=new Date();
  String log_string=null;
  if (transMeta.isLogfieldUsed()) {
    log_string=log.getString();
    log_string+=Const.CR + Messages.getString("Trans.Log.Status.End");
    log.setString("");
    log.endStringCapture();
  }
  DatabaseMeta logcon=transMeta.getLogConnection();
  if (logcon != null) {
    Database ldb=new Database(logcon);
    try {
      ldb.connect();
      ldb.writeLogRecord(transMeta.getLogTable(),transMeta.isBatchIdUsed(),getBatchId(),false,transMeta.getName(),status,result.getNrLinesRead(),result.getNrLinesWritten(),result.getNrLinesUpdated(),result.getNrLinesInput() + result.getNrFilesRetrieved(),result.getNrLinesOutput(),result.getNrErrors(),startDate,endDate,logDate,depDate,currentDate,log_string);
    }
 catch (    Exception e) {
      throw new KettleException(Messages.getString("Trans.Exception.ErrorWritingLogRecordToTable") + transMeta.getLogTable() + "]",e);
    }
 finally {
      ldb.disconnect();
    }
  }
  return true;
}
