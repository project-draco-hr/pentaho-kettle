{
  lifeListeners=Collections.synchronizedSet(loadPlugins(LifecyclePluginType.class,LifecycleListener.class));
  kettleLifecycleListeners=Collections.synchronizedSet(loadPlugins(KettleLifecyclePluginType.class,KettleLifecycleListener.class));
  final PluginRegistry registry=PluginRegistry.getInstance();
  registry.addPluginListener(LifecyclePluginType.class,new PluginTypeListener(){
    public void pluginAdded(    Object serviceObject){
      LifecycleListener listener=null;
      try {
        listener=(LifecycleListener)PluginRegistry.getInstance().loadClass((PluginInterface)serviceObject);
      }
 catch (      KettlePluginException e) {
        e.printStackTrace();
        return;
      }
      lifeListeners.add(listener);
      if (started) {
        try {
          listener.onStart(handler);
        }
 catch (        LifecycleException e) {
          e.printStackTrace();
        }
      }
    }
    public void pluginRemoved(    Object serviceObject){
      lifeListeners.remove(serviceObject);
    }
    public void pluginChanged(    Object serviceObject){
    }
  }
);
  registry.addPluginListener(KettleLifecyclePluginType.class,new PluginTypeListener(){
    @Override public void pluginAdded(    Object serviceObject){
      KettleLifecycleListener listener=null;
      try {
        listener=(KettleLifecycleListener)registry.loadClass((PluginInterface)serviceObject);
      }
 catch (      KettlePluginException e) {
        e.printStackTrace();
        return;
      }
      kettleLifecycleListeners.add(listener);
      if (KettleEnvironment.isInitialized()) {
        try {
          listener.onEnvironmentInit();
        }
 catch (        LifecycleException ex) {
          String message=BaseMessages.getString(PKG,"LifecycleSupport.ErrorInvokingKettleLifecycleListener",listener);
          LogChannel.GENERAL.logError(message,ex);
        }
      }
    }
    @Override public void pluginRemoved(    Object serviceObject){
      kettleLifecycleListeners.remove(serviceObject);
    }
    @Override public void pluginChanged(    Object serviceObject){
    }
  }
);
}
