{
  try {
    byte[] delimiter;
    if (meta.isUseSSV()) {
      delimiter=data.getBytes(";");
    }
 else {
      delimiter=data.separator;
    }
    for (int i=0; i < data.keynrs.length; i++) {
      if (i > 0) {
        data.fifoStream.write(delimiter);
      }
      int index=data.keynrs[i];
      ValueMetaInterface valueMeta=rowMeta.getValueMeta(index);
      Object valueData=r[index];
      if (valueData == null) {
      }
 else {
        if (valueMeta.isStorageBinaryString()) {
          byte[] value=valueMeta.getBinaryString(valueData);
          data.fifoStream.write(value);
        }
 else {
          if (meta.isUseStandardConversion()) {
            if (valueMeta.isDate()) {
              valueMeta.setConversionMask("yyyy-MM-dd HH:mm:ss.SSS");
            }
 else             if (valueMeta.isNumber()) {
              valueMeta.setDecimalSymbol(".");
              valueMeta.setGroupingSymbol("");
            }
          }
          String string=valueMeta.getString(valueData);
          if (string != null) {
            if (meta.isUseSSV()) {
              if (meta.isEscapingSpecialCharacters() && valueMeta.isString()) {
                StringBuilder builder=new StringBuilder(string);
                String[] escapeStrings=new String[]{"\"","\n","\r"};
                String[] replaceStrings=new String[]{"\\\"","\\n","\\r"};
                for (int e=0; e < escapeStrings.length; e++) {
                  String chr=escapeStrings[e];
                  String rep=replaceStrings[e];
                  int idx=builder.indexOf(chr,0);
                  while (idx > 0) {
                    builder.replace(idx,idx + chr.length(),rep);
                    idx=builder.indexOf(chr,idx + rep.length());
                  }
                }
                string=builder.toString();
              }
              string='"' + string + '"';
            }
            byte[] value=data.getBytes(string);
            data.fifoStream.write(value);
          }
        }
      }
    }
    data.fifoStream.write(data.newline);
  }
 catch (  Exception e) {
    try {
      data.sqlRunner.checkExcn();
    }
 catch (    Exception loadEx) {
      throw new KettleException("Error serializing rows of data to the fifo file",loadEx);
    }
    throw new KettleException("Error serializing rows of data to the fifo file",e);
  }
}
