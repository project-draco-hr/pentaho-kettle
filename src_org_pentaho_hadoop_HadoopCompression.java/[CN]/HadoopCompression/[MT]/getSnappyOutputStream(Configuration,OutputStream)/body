{
  if (!isHadoopSnappyAvailable()) {
    throw new Exception("Hadoop-snappy does not seem to be available");
  }
  Object snappyCodec=Class.forName(SNAPPY_CODEC_CLASS).newInstance();
  Class confClass=new Configuration().getClass();
  Class[] paramClass=new Class[1];
  paramClass[0]=confClass;
  if (conf == null) {
    conf=new Configuration();
  }
  Method m=snappyCodec.getClass().getMethod("setConf",paramClass);
  m.invoke(snappyCodec,conf);
  paramClass[0]=Class.forName("java.io.OutputStream");
  m=snappyCodec.getClass().getMethod("createOutputStream",paramClass);
  Object result=m.invoke(snappyCodec,out);
  return (CompressionOutputStream)result;
}
